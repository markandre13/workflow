var workflow=function(t){"use strict";function e(t,e,i,s){var o,r=arguments.length,n=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,i,s);else for(var l=t.length-1;l>=0;l--)(o=t[l])&&(n=(r<3?o(n):r>3?o(e,i,n):o(e,i))||n);return r>3&&n&&Object.defineProperty(e,i,n),n}function i(t,e,i,s){return new(i||(i=Promise))((function(o,r){function n(t){try{a(s.next(t))}catch(t){r(t)}}function l(t){try{a(s.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,l)}a((s=s.apply(t,e||[])).next())}))}class s{constructor(t){if("IOR:"!=t.substr(0,4).toUpperCase())throw Error(`Missing "IOR:" prefix in "${t}"`);if(1&t.length)throw Error("IOR has a wrong length.");const e=new Array((t.length-4)/2);for(let i=4,s=0;i<t.length;i+=2,++s)e[s]=Number.parseInt(t.substring(i,i+2),16);const i=new Uint8Array(e),s=new B(i.buffer);s.endian();const o=s.reference();this.host=o.host,this.port=o.port,this.oid=o.oid,this.objectKey=o.objectKey,s.offset!==i.byteLength&&console.log(`note: ${i.byteLength-s.offset} octets at end of IOR`)}}var o,r,n,l,a,h,d,c,u,g,f,p,m,y,v,w,E,b;o=s||(s={}),function(t){t[t.INTERNET_IOP=0]="INTERNET_IOP",t[t.MULTIPLE_COMPONENTS=1]="MULTIPLE_COMPONENTS",t[t.SCCP_IOP=2]="SCCP_IOP",t[t.UIPMC=3]="UIPMC",t[t.MOBILE_TERMINAL_IOP=4]="MOBILE_TERMINAL_IOP"}((r=o.TAG||(o.TAG={})).IOR||(r.IOR={})),(n=r.ComponentId||(r.ComponentId={}))[n.ORB_TYPE=0]="ORB_TYPE",n[n.CODE_SETS=1]="CODE_SETS",n[n.POLICIES=2]="POLICIES",n[n.ALTERNATE_IIOP_ADDRESS=3]="ALTERNATE_IIOP_ADDRESS",n[n.ASSOCIATION_OPTIONS=13]="ASSOCIATION_OPTIONS",n[n.SEC_NAME=14]="SEC_NAME",n[n.SPKM_1_SEC_MECH=15]="SPKM_1_SEC_MECH",n[n.SPKM_2_SEC_MECH=16]="SPKM_2_SEC_MECH",n[n.KerberosV5_SEC_MECH=17]="KerberosV5_SEC_MECH",n[n.CSI_ECMA_Secret_SEC_MECH=18]="CSI_ECMA_Secret_SEC_MECH",n[n.CSI_ECMA_Hybrid_SEC_MECH=19]="CSI_ECMA_Hybrid_SEC_MECH",n[n.SSL_SEC_TRANS=20]="SSL_SEC_TRANS",n[n.CSI_ECMA_Public_SEC_MECH=21]="CSI_ECMA_Public_SEC_MECH",n[n.GENERIC_SEC_MECH=22]="GENERIC_SEC_MECH",n[n.FIREWALL_TRANS=23]="FIREWALL_TRANS",n[n.SCCP_CONTACT_INFO=24]="SCCP_CONTACT_INFO",n[n.JAVA_CODEBASE=25]="JAVA_CODEBASE",n[n.TRANSACTION_POLICY=26]="TRANSACTION_POLICY",n[n.MESSAGE_ROUTERS=30]="MESSAGE_ROUTERS",n[n.OTS_POLICY=31]="OTS_POLICY",n[n.INV_POLICY=32]="INV_POLICY",n[n.CSI_SEC_MECH_LIST=33]="CSI_SEC_MECH_LIST",n[n.NULL_TAG=34]="NULL_TAG",n[n.SECIOP_SEC_TRANS=35]="SECIOP_SEC_TRANS",n[n.TLS_SEC_TRANS=36]="TLS_SEC_TRANS",n[n.ACTIVITY_POLICY=37]="ACTIVITY_POLICY",n[n.RMI_CUSTOM_MAX_STREAM_FORMAT=38]="RMI_CUSTOM_MAX_STREAM_FORMAT",n[n.GROUP=39]="GROUP",n[n.GROUP_IIOP=40]="GROUP_IIOP",n[n.PASSTHRU_TRANS=41]="PASSTHRU_TRANS",n[n.FIREWALL_PATH=42]="FIREWALL_PATH",n[n.IIOP_SEC_TRANS=43]="IIOP_SEC_TRANS",n[n.INET_SEC_TRANS=123]="INET_SEC_TRANS",(l=r.IIOP||(r.IIOP={}))[l.ORB_TYPE=0]="ORB_TYPE",l[l.CODE_SETS=1]="CODE_SETS",l[l.SEC_NAME=2]="SEC_NAME",l[l.ASSOCIATION_OPTIONS=3]="ASSOCIATION_OPTIONS",l[l.TAG_GENERIC_SEC_MECH=4]="TAG_GENERIC_SEC_MECH",l[l.TAG_SSL_SEC_TRANS=5]="TAG_SSL_SEC_TRANS",l[l.TAG_SPKM_1_SEC_MECH=6]="TAG_SPKM_1_SEC_MECH",l[l.TAG_SPKM_2_SEC_MECH=7]="TAG_SPKM_2_SEC_MECH",l[l.TAG_KerberosV5_SEC_MECH=8]="TAG_KerberosV5_SEC_MECH",l[l.TAG_CSI_ECMA_Secret_SEC_MECH=9]="TAG_CSI_ECMA_Secret_SEC_MECH",l[l.TAG_CSI_ECMA_Hybrid_SEC_MECH=10]="TAG_CSI_ECMA_Hybrid_SEC_MECH",l[l.TAG_SSL_SEC_TRANS_AGAIN=11]="TAG_SSL_SEC_TRANS_AGAIN",l[l.TAG_CSI_ECMA_Public_SEC_MECH=12]="TAG_CSI_ECMA_Public_SEC_MECH",l[l.TAG_FIREWALL_TRANS=13]="TAG_FIREWALL_TRANS",l[l.TAG_JAVA_CODEBASE=14]="TAG_JAVA_CODEBASE",l[l.TAG_TRANSACTION_POLICY=15]="TAG_TRANSACTION_POLICY",l[l.TAG_MESSAGE_ROUTERS=16]="TAG_MESSAGE_ROUTERS",l[l.TAG_INET_SEC_TRANS=17]="TAG_INET_SEC_TRANS",l[l.TAG_ALTERNATE_IIOP_ADDRESS=18]="TAG_ALTERNATE_IIOP_ADDRESS",l[l.TAG_POLICIES=19]="TAG_POLICIES",l[l.TAG_DCE_STRING_BINDING=20]="TAG_DCE_STRING_BINDING",l[l.TAG_DCE_BINDING_NAME=21]="TAG_DCE_BINDING_NAME",l[l.TAG_DCE_NO_PIPES=22]="TAG_DCE_NO_PIPES",l[l.TAG_DCE_MECH=23]="TAG_DCE_MECH",l[l.TAG_COMPLETE_OBJECT_KEY=24]="TAG_COMPLETE_OBJECT_KEY",l[l.TAG_ENDPOINT_ID_POSITION=25]="TAG_ENDPOINT_ID_POSITION",l[l.TAG_LOCATION_POLICY=26]="TAG_LOCATION_POLICY",l[l.TAG_OTS_POLICY=27]="TAG_OTS_POLICY",l[l.TAG_INV_POLICY=28]="TAG_INV_POLICY",l[l.TAG_CSI_SEC_MECH_LIST=29]="TAG_CSI_SEC_MECH_LIST",l[l.TAG_NULL_TAG=30]="TAG_NULL_TAG",l[l.TAG_SECIOP_SEC_TRANS=31]="TAG_SECIOP_SEC_TRANS",l[l.TAG_TLS_SEC_TRANS=32]="TAG_TLS_SEC_TRANS",l[l.TAG_ACTIVITY_POLICY=33]="TAG_ACTIVITY_POLICY";class A extends Object{constructor(t,e,i,s){super(),this.tagClass=t,this.encoding=i,this.tag=e,this.length=s}toString(){return this.tagClass===h.UNIVERSAL?`ASN1Tag(class=${h[this.tagClass]}, encoding=${a[this.encoding]}, tag=${d[this.tag]}, length=${this.length})`:`ASN1Tag(class=${h[this.tagClass]}, encoding=${a[this.encoding]}, tag=${this.tag}, length=${this.length})`}}!function(t){t[t.PRIMITIVE=0]="PRIMITIVE",t[t.CONSTRUCTED=1]="CONSTRUCTED"}(a||(a={})),function(t){t[t.UNIVERSAL=0]="UNIVERSAL",t[t.APPLICATION=1]="APPLICATION",t[t.CONTEXT=2]="CONTEXT",t[t.PRIVATE=3]="PRIVATE"}(h||(h={})),function(t){t[t.EOC=0]="EOC",t[t.BOOLEAN=1]="BOOLEAN",t[t.INTEGER=2]="INTEGER",t[t.BITSTRING=3]="BITSTRING",t[t.OCTETSTRING=4]="OCTETSTRING",t[t.NULLTAG=5]="NULLTAG",t[t.OID=6]="OID",t[t.OBJDESCRIPTOR=7]="OBJDESCRIPTOR",t[t.EXTERNAL=8]="EXTERNAL",t[t.REAL=9]="REAL",t[t.ENUMERATED=10]="ENUMERATED",t[t.EMBEDDED_PDV=11]="EMBEDDED_PDV",t[t.UTF8STRING=12]="UTF8STRING",t[t.SEQUENCE=16]="SEQUENCE",t[t.SET=17]="SET",t[t.NUMERICSTRING=18]="NUMERICSTRING",t[t.PRINTABLESTRING=19]="PRINTABLESTRING",t[t.T61STRING=20]="T61STRING",t[t.VIDEOTEXSTRING=21]="VIDEOTEXSTRING",t[t.IA5STRING=22]="IA5STRING",t[t.UTCTIME=23]="UTCTIME",t[t.GENERALIZEDTIME=24]="GENERALIZEDTIME",t[t.GRAPHICSTRING=25]="GRAPHICSTRING",t[t.VISIBLESTRING=26]="VISIBLESTRING",t[t.GENERALSTRING=27]="GENERALSTRING",t[t.UNIVERSALSTRING=28]="UNIVERSALSTRING",t[t.BMPSTRING=29]="BMPSTRING"}(d||(d={})),function(t){t[t.REQUEST=0]="REQUEST",t[t.REPLY=1]="REPLY",t[t.CANCEL_REQUEST=2]="CANCEL_REQUEST",t[t.LOCATE_REQUEST=3]="LOCATE_REQUEST",t[t.LOCATE_REPLY=4]="LOCATE_REPLY",t[t.CLOSE_CONNECTION=5]="CLOSE_CONNECTION",t[t.MESSAGE_ERROR=6]="MESSAGE_ERROR",t[t.FRAGMENT=7]="FRAGMENT"}(c||(c={})),function(t){t[t.ORB_TYPE=0]="ORB_TYPE",t[t.CODE_SETS=1]="CODE_SETS",t[t.POLICIES=2]="POLICIES",t[t.ALTERNATE_IIOP_ADDRESS=3]="ALTERNATE_IIOP_ADDRESS",t[t.ASSOCIATION_OPTIONS=13]="ASSOCIATION_OPTIONS",t[t.SEC_NAME=14]="SEC_NAME",t[t.SPKM_1_SEC_MECH=15]="SPKM_1_SEC_MECH",t[t.SPKM_2_SEC_MECH=16]="SPKM_2_SEC_MECH",t[t.KerberosV5_SEC_MECH=17]="KerberosV5_SEC_MECH",t[t.CSI_ECMA_Secret_SEC_MECH=18]="CSI_ECMA_Secret_SEC_MECH",t[t.CSI_ECMA_Hybrid_SEC_MECH=19]="CSI_ECMA_Hybrid_SEC_MECH",t[t.CSI_ECMA_Public_SEC_MECH=21]="CSI_ECMA_Public_SEC_MECH",t[t.GENERIC_SEC_MECH=22]="GENERIC_SEC_MECH",t[t.CSI_SEC_MECH_LIST=33]="CSI_SEC_MECH_LIST",t[t.SSL_SEC_TRANS=10]="SSL_SEC_TRANS",t[t.TLS_SEC_TRANS=36]="TLS_SEC_TRANS",t[t.IIOP_SEC_TRANS=43]="IIOP_SEC_TRANS",t[t.INET_SEC_TRANS=123]="INET_SEC_TRANS",t[t.SECIOP_SEC_TRANS=35]="SECIOP_SEC_TRANS",t[t.FIREWALL_TRANS=13]="FIREWALL_TRANS",t[t.PASSTHRU_TRANS=41]="PASSTHRU_TRANS",t[t.FIREWALL_PATH=42]="FIREWALL_PATH",t[t.SCCP_CONTACT_INFO=14]="SCCP_CONTACT_INFO",t[t.JAVA_CODEBASE=15]="JAVA_CODEBASE",t[t.TRANSACTION_POLICY=16]="TRANSACTION_POLICY",t[t.MESSAGE_ROUTERS=30]="MESSAGE_ROUTERS",t[t.OTS_POLICY=31]="OTS_POLICY",t[t.INV_POLICY=32]="INV_POLICY",t[t.TAG_NULL_TAG=34]="TAG_NULL_TAG",t[t.ACTIVITY_POLICY=37]="ACTIVITY_POLICY",t[t.RMI_CUSTOM_MAX_STREAM_FORMAT=38]="RMI_CUSTOM_MAX_STREAM_FORMAT",t[t.GROUP=39]="GROUP",t[t.GROUP_IIOP=40]="GROUP_IIOP"}(u||(u={})),function(t){t[t.TransactionService=0]="TransactionService",t[t.CodeSets=1]="CodeSets",t[t.ChainBypassCheck=2]="ChainBypassCheck",t[t.ChainBypassInfo=3]="ChainBypassInfo",t[t.LogicalThreadId=4]="LogicalThreadId",t[t.BI_DIR_IIOP=5]="BI_DIR_IIOP",t[t.SendingContextRunTime=6]="SendingContextRunTime",t[t.INVOCATION_POLICIES=7]="INVOCATION_POLICIES",t[t.FORWARDED_IDENTITY=8]="FORWARDED_IDENTITY",t[t.UnknownExceptionInfo=9]="UnknownExceptionInfo",t[t.RTCorbaPriority=10]="RTCorbaPriority",t[t.RTCorbaPriorityRange=11]="RTCorbaPriorityRange",t[t.FT_GROUP_VERSION=12]="FT_GROUP_VERSION",t[t.FT_REQUEST=13]="FT_REQUEST",t[t.ExceptionDetailMessage=14]="ExceptionDetailMessage",t[t.SecurityAttributeService=15]="SecurityAttributeService",t[t.ActivityService=16]="ActivityService",t[t.RMICustomMaxStreamFormat=17]="RMICustomMaxStreamFormat",t[t.ACCESS_SESSION_ID=18]="ACCESS_SESSION_ID",t[t.SERVICE_SESSION_ID=19]="SERVICE_SESSION_ID",t[t.FIREWALL_PATH=20]="FIREWALL_PATH",t[t.FIREWALL_PATH_RESP=21]="FIREWALL_PATH_RESP",t[t.SERVICE_PADDING_CONTEXT=1245790977]="SERVICE_PADDING_CONTEXT"}(g||(g={})),function(t){t[t.EstablishContext=0]="EstablishContext",t[t.CompleteEstablishContext=1]="CompleteEstablishContext",t[t.ContextError=2]="ContextError",t[t.MessageInContext=3]="MessageInContext"}(f||(f={}));class x{constructor(t,e){this.type=t,this.content=e}}class C{constructor(t,e,i){this.user=t,this.password=e,this.target_name=i}}class S{}class T extends S{constructor(){super(...arguments),this.clientContextId=0n,this.authorizationToken=[]}decode(t){if(this.clientContextId=t.ulonglong(),t.encapStack[t.encapStack.length-1].nextOffset-t.offset<4)return;const e=t.ulong();for(let i=0;i<e;++i){const e=t.ulong(),i=t.blob();this.authorizationToken.push(new x(e,i))}if(t.ulong()===m.Absent)t.bool();if(t.ulong(),void 0===t.asn1expect(h.APPLICATION,0,a.CONSTRUCTED))return;if(!t.asn1expectOID([2,23,130,1,1,1]))return;const i=new B(t.buffer.slice(t.offset));i.endian();const s=new TextDecoder;this.clientAuthenticationToken=new C(s.decode(i.blob()),s.decode(i.blob()),s.decode(i.blob()))}}class _ extends S{constructor(){super(...arguments),this.clientContextId=0n,this.majorStatus=1,this.minorStatus=1}}class R extends S{constructor(){super(...arguments),this.clientContextId=0n}}!function(t){t[t.SUCCESS=0]="SUCCESS",t[t.ERROR_UNSPECIFIED=1]="ERROR_UNSPECIFIED",t[t.ERROR_BADPASSWORD=2]="ERROR_BADPASSWORD",t[t.ERROR_NOUSER=3]="ERROR_NOUSER",t[t.ERROR_BAD_TARGET=4]="ERROR_BAD_TARGET"}(p||(p={})),function(t){t[t.Absent=0]="Absent",t[t.Anonymous=1]="Anonymous",t[t.PrincipalName=2]="PrincipalName",t[t.X509CertChain=4]="X509CertChain",t[t.DistinguishedName=8]="DistinguishedName"}(m||(m={})),function(t){t[t.KeyAddr=0]="KeyAddr",t[t.ProfileAddr=1]="ProfileAddr",t[t.ReferenceAddr=2]="ReferenceAddr"}(y||(y={})),function(t){t[t.NO_EXCEPTION=0]="NO_EXCEPTION",t[t.USER_EXCEPTION=1]="USER_EXCEPTION",t[t.SYSTEM_EXCEPTION=2]="SYSTEM_EXCEPTION",t[t.LOCATION_FORWARD=3]="LOCATION_FORWARD",t[t.LOCATION_FORWARD_PERM=4]="LOCATION_FORWARD_PERM",t[t.NEEDS_ADDRESSING_MODE=5]="NEEDS_ADDRESSING_MODE"}(v||(v={}));class N{}class O{}class I{}class k{}!function(t){t[t.UNKNOWN_OBJECT=0]="UNKNOWN_OBJECT",t[t.OBJECT_HERE=1]="OBJECT_HERE",t[t.OBJECT_FORWARD=2]="OBJECT_FORWARD",t[t.OBJECT_FORWARD_PERM=3]="OBJECT_FORWARD_PERM",t[t.LOC_SYSTEM_EXCEPTION=4]="LOC_SYSTEM_EXCEPTION",t[t.LOC_NEEDS_ADDRESSING_MODE=5]="LOC_NEEDS_ADDRESSING_MODE"}(w||(w={}));class D{}class L{toString(){return`ObjectReference(oid=${this.oid}, host=${this.host}, port=${this.port}, objectKey=${this.objectKey}')`}}class M{constructor(t){this.offset=0,this.majorVersion=1,this.minorVersion=2,this.connection=t}}M.ENDIAN_BIG=0,M.ENDIAN_LITTLE=1,M.FLOAT64_MAX=17976931348623157e292,M.FLOAT64_MIN=22250738585072014e-324,M.TWO_TO_20=1048576,M.TWO_TO_32=4294967296,M.TWO_TO_52=4503599627370496;class P extends M{constructor(t){if(super(t),this.buffer=new ArrayBuffer(65535),this.data=new DataView(this.buffer),this.bytes=new Uint8Array(this.buffer),this.repositoryIds=new Map,this.objectPosition=new Map,this.sizeStack=[],void 0===P.littleEndian){const t=new ArrayBuffer(2);new Int16Array(t)[0]=4660,P.littleEndian=52===new DataView(t).getUint8(0)}}get buf(){return this.buffer}reserveSize(){this.alignAndReserve(4),this.offset+=4,this.sizeStack.push(this.offset)}fillinSize(){const t=this.offset,e=this.sizeStack.pop();if(void 0===e)throw Error("internal error: fillinSize() misses reserveSize()");this.offset=e-4;const i=t-e;this.ulong(i),this.offset=t}beginEncapsulation(t){this.ulong(t),this.reserveSize(),this.endian()}endEncapsulation(){this.fillinSize()}skipGIOPHeader(){this.offset=10}setGIOPHeader(t){this.data.setUint32(0,1195986768),this.data.setUint8(4,this.majorVersion),this.data.setUint8(5,this.minorVersion),this.data.setUint8(6,P.littleEndian?M.ENDIAN_LITTLE:M.ENDIAN_BIG),this.data.setUint8(7,t),this.data.setUint32(8,this.offset-12,P.littleEndian)}encodeRequest(t,e,i=1,s){this.skipGIOPHeader(),1==this.majorVersion&&this.minorVersion<=1&&this.serviceContext(),this.ulong(i),1==this.majorVersion&&this.minorVersion<=1?this.octet(s?1:0):this.octet(s?3:0),this.offset+=3,1==this.majorVersion&&this.minorVersion<=1||this.ushort(y.KeyAddr),this.blob(t),this.string(e),1==this.majorVersion&&this.minorVersion<=1?this.ulong(0):(this.serviceContext(),this.alignAndReserve(8))}encodeReply(t,e=v.NO_EXCEPTION){this.skipGIOPHeader(),1==this.majorVersion&&this.minorVersion<2&&this.ulong(0),this.ulong(t),this.ulong(e),1==this.majorVersion&&this.minorVersion>=2&&this.ulong(0)}encodeLocateReply(t,e){this.skipGIOPHeader(),this.ulong(t),this.ulong(e)}serviceContext(){if(!this.connection)return void this.ulong(0);let t,e=1;this.connection.orb.outgoingAuthenticator&&(t=this.connection.orb.outgoingAuthenticator(this.connection),t&&++e),this.ulong(e),this.beginEncapsulation(g.BI_DIR_IIOP),this.ulong(1),this.string(this.connection.localAddress),this.ushort(this.connection.localPort),this.endEncapsulation(),t&&this.establishSecurityContext(t)}establishSecurityContext(t){this.beginEncapsulation(g.SecurityAttributeService),this.ulong(f.EstablishContext),this.ulonglong(1n),this.ulong(0),this.ulong(m.Absent),this.bool(!0),this.reserveSize(),this.asn1tag(h.APPLICATION,0,a.CONSTRUCTED,(e=>{e.asn1tag(h.UNIVERSAL,d.OID,a.PRIMITIVE,(t=>{t.asn1oid([2,23,130,1,1,1])})),e.endian();const i=new TextEncoder;e.blob(i.encode(t.user)),e.blob(i.encode(t.password)),e.blob(i.encode(t.target_name))})),this.fillinSize(),this.endEncapsulation()}setReplyHeader(t,e=v.NO_EXCEPTION){this.skipGIOPHeader(),this.encodeReply(t,e)}skipReplyHeader(){this.offset=24}repositoryId(t){const e=`IDL:${t}:1.0`,i=this.repositoryIds.get(e);void 0===i?(this.ulong(2147483394),this.repositoryIds.set(e,this.offset),this.string(e)):(this.ulong(2147483394),this.ulong(4294967295),this.long(i-this.offset))}reference(t){const e=t.constructor._idlClassName(),i=new L;i.host=this.connection.localAddress,i.port=this.connection.localPort,i.oid=`IDL:${e}:1.0`,i.objectKey=t.id,this.string(i.oid),this.ulong(1),this.ulong(s.TAG.IOR.INTERNET_IOP),this.reserveSize(),this.endian(),this.octet(this.majorVersion),this.octet(this.minorVersion),this.string(i.host),this.short(i.port),this.blob(i.objectKey),1==this.majorVersion&&0==this.minorVersion||(this.ulong(1),this.beginEncapsulation(0),this.ulong(1295069952),this.endEncapsulation()),this.fillinSize()}value(t){this.object(t)}object(t){if(void 0===t)return void this.ulong(0);if(t instanceof st)throw Error("ORB: can not serialize Stub yet");if(t instanceof it){if(void 0===this.connection)throw Error("GIOPEncoder has no connection defined. Can not add object to ACL.");return this.connection.orb.aclAdd(t),void this.reference(t)}const e=this.objectPosition.get(t);if(void 0!==e)return this.ulong(4294967295),void this.long(e-this.offset);let i,s=Object.getPrototypeOf(t);for(;null!==s&&(i=tt.valueTypeByPrototype.get(s),void 0===i);)s=Object.getPrototypeOf(s);if(void 0===i)throw console.log(t),Error(`ORB: can not serialize object of unregistered valuetype ${t.constructor.name}`);if(i?.construct.name!==t.constructor.name)throw Error(`ORB: No value type registered for class ${t.constructor.name}. Best match was class ${i?.construct.name}.`);this.alignAndReserve(4),this.objectPosition.set(t,this.offset),this.repositoryId(i.name),i.encode(this,t)}endian(){this.octet(P.littleEndian?M.ENDIAN_LITTLE:M.ENDIAN_BIG)}reserveOne(){if(this.buffer.byteLength<=this.offset+1){const t=new ArrayBuffer(2*this.buffer.byteLength);new Uint8Array(t).set(new Uint8Array(this.buffer)),this.buffer=t,this.data=new DataView(this.buffer),this.bytes=new Uint8Array(this.buffer)}}alignAndReserve(t){const e=this.offset%t;if(0!==e&&(this.offset+=t-e),this.buffer.byteLength<=this.offset+t){const t=new ArrayBuffer(2*this.buffer.byteLength);new Uint8Array(t).set(new Uint8Array(this.buffer)),this.buffer=t,this.data=new DataView(this.buffer),this.bytes=new Uint8Array(this.buffer)}}alignAndReserveVarying(t,e){const i=this.offset%t;if(0!==i&&(this.offset+=t-i),this.buffer.byteLength<=this.offset+e){let t=2*this.buffer.byteLength;for(;t<=this.offset+e;)t*=2;const i=new ArrayBuffer(t);new Uint8Array(i).set(new Uint8Array(this.buffer)),this.buffer=i,this.data=new DataView(this.buffer),this.bytes=new Uint8Array(this.buffer)}}blob(t){this.alignAndReserveVarying(4,4+t.length),this.ulong(t.length),this.bytes.set(t,this.offset),this.offset+=t.length}string(t){const e=P.textEncoder.encode(t);this.alignAndReserveVarying(4,4+e.length+1),this.ulong(e.length+1),this.bytes.set(e,this.offset),this.offset+=e.length,this.bytes[this.offset]=0,this.offset++}sequence(t,e){this.ulong(t.length),t.forEach(((t,i)=>{e(t)}))}bool(t){this.reserveOne(),this.data.setUint8(this.offset,t?1:0),this.offset+=1}char(t){this.reserveOne(),this.data.setUint8(this.offset,t.charCodeAt(0)),this.offset+=1}octet(t){this.reserveOne(),this.data.setUint8(this.offset,t),this.offset+=1}short(t){this.alignAndReserve(2),this.data.setInt16(this.offset,t,P.littleEndian),this.offset+=2}ushort(t){this.alignAndReserve(2),this.data.setUint16(this.offset,t,P.littleEndian),this.offset+=2}long(t){this.alignAndReserve(4),this.data.setInt32(this.offset,t,P.littleEndian),this.offset+=4}ulong(t){this.alignAndReserve(4),this.data.setUint32(this.offset,t,P.littleEndian),this.offset+=4}longlong(t){this.alignAndReserve(8),this.data.setBigInt64(this.offset,t,P.littleEndian),this.offset+=8}ulonglong(t){this.alignAndReserve(8),this.data.setBigUint64(this.offset,t,P.littleEndian),this.offset+=8}float(t){this.alignAndReserve(4),this.data.setFloat32(this.offset,t,P.littleEndian),this.offset+=4}double(t){this.alignAndReserve(8),this.data.setFloat64(this.offset,t,P.littleEndian),this.offset+=8}asn1number(t){let e=[];for(;t>127;)e.push(127&t),t>>=7;e.push(t);for(let t=e.length-1;t>0;--t)this.octet(128|e[t]);this.octet(e[0])}asn1numberE(t){let e=[];for(;t>0;)e.push(255&t),t>>=8;this.octet(e.length);for(let t=e.length-1;t>=0;--t)this.octet(e[t])}asn1tag(t,e,i,s){const o=t<<6|i<<5;e<31?this.octet(o|e):(this.octet(31|o),this.asn1number(e));const r=new P;void 0!==s&&s(r),this.asn1number(r.offset);for(let t=0;t<r.offset;++t)this.octet(r.bytes[t])}asn1oid(t){this.octet(40*t[0]+t[1]);for(let e=2;e<t.length;++e)this.asn1number(t[e])}}P.textEncoder=new TextEncoder;class B extends M{constructor(t,e){super(e),this.littleEndian=!0,this.objects=new Map,this.encapStack=[],this.buffer=t,this.data=new DataView(t),this.bytes=new Uint8Array(t)}beginEncapsulation(){const t=this.ulong(),e=this.ulong(),i=this.offset+e;return this.encapStack.push({nextOffset:i,endian:this.littleEndian}),this.endian(),t}endEncapsulation(){const t=this.encapStack.pop();this.littleEndian=t.endian,this.offset=t.nextOffset}scanGIOPHeader(){const t=this.data.getUint32(0);if(1195986768!==t)throw Error(`Missing GIOP Header Magic Number (got 0x${t.toString(16)}, expected 0x47494f50`);return this.offset+=4,this.majorVersion=this.octet(),this.minorVersion=this.octet(),this.endian(),this.type=this.octet(),this.length=this.ulong(),this.type}scanLocateRequest(){const t=new k;if(t.requestId=this.ulong(),1==this.majorVersion&&this.minorVersion<=1)t.objectKey=this.blob();else{const e=this.ushort();switch(e){case y.KeyAddr:t.objectKey=this.blob();break;case y.ProfileAddr:case y.ReferenceAddr:throw Error(`Unsupported AddressingDisposition(${y[e]})`);default:throw Error(`Unknown AddressingDisposition(${e})`)}}return t}scanLocateReply(){const t=new D;return t.requestId=this.ulong(),t.status=this.ulong(),t}scanRequestHeader(){const t=new O;1==this.majorVersion&&this.minorVersion<=1&&(t.serviceContext=this.serviceContext()),t.requestId=this.ulong();const e=this.octet();if(1==this.majorVersion&&this.minorVersion<=1)t.responseExpected=0!=e;else switch(e){case 0:t.responseExpected=!1;break;case 1:case 2:break;case 3:t.responseExpected=!0}if(this.offset+=3,1==this.majorVersion&&this.minorVersion<=1)t.objectKey=this.blob();else{const e=this.ushort();switch(e){case y.KeyAddr:t.objectKey=this.blob();break;case y.ProfileAddr:case y.ReferenceAddr:throw Error(`Unsupported AddressingDisposition(${y[e]})`);default:throw Error(`Unknown AddressingDisposition(${e})`)}}return t.method=this.string(),1==this.majorVersion&&this.minorVersion<=1?this.ulong():(t.serviceContext=this.serviceContext(),this.align(8)),t}scanReplyHeader(){const t=new I;return 1==this.majorVersion&&this.minorVersion<=1&&this.serviceContext(),t.requestId=this.ulong(),t.replyStatus=this.ulong(),1==this.majorVersion&&this.minorVersion>=2&&this.serviceContext(),t}serviceContext(){const t=[],e=this.ulong();for(let i=0;i<e;++i){switch(this.beginEncapsulation()){case g.BI_DIR_IIOP:{const e=new N;e.host=this.string(),e.port=this.ushort(),t.push(e)}break;case g.SecurityAttributeService:switch(this.ulong()){case f.EstablishContext:{const e=new T;e.decode(this),t.push(e)}break;case f.CompleteEstablishContext:{const e=new R;e.clientContextId=this.ulonglong(),e.contextStateful=this.bool(),t.push(e)}break;case f.ContextError:{const e=new _;e.clientContextId=this.ulonglong(),e.majorStatus=this.long(),e.minorStatus=this.long(),t.push(e)}}}this.endEncapsulation()}return t}reference(t){const e=new L;e.oid=this.string(t);const i=this.ulong();for(let t=0;t<i;++t){if(this.beginEncapsulation()===s.TAG.IOR.INTERNET_IOP){const i=this.octet(),s=this.octet();if(e.host=this.string(),e.port=this.ushort(),e.objectKey=this.blob(),1===i&&0!==s){const e=this.ulong();for(t=0;t<e;++t){const t=this.ulong(),e=this.ulong(),i=this.offset+e;switch(t){case u.ORB_TYPE:const t=this.ulong();for(let e=0;e<t;++e){const t=this.ulong(),e=[[1213202432,1213202447,"Hewlett Packard"],[1229081856,1229081871,"IBM"],[1229739264,1229739519,"Xerox"],[1230194944,1230194959,"AdNovum Informatik AG"],[1447645952,1447645967,"Borland (VisiBroker)"],[1330205440,1330205695,"Objective Interface Systems"],[1178730496,1178730511,"FloorBoard Software"],[1313754710,1313754710,"Rogue Wave"],[1314193408,1314193423,"Nihon Unisys, Ltd"],[1245858642,1245858642,"SilverStream Software"],[1413566208,1413566208,"Center for Distributed Object Computing, Washington University"],[1279476224,1279476239,"2AB"],[1095784497,1095784497,"Informatik 4, Univ. of Erlangen-Nuernberg"],[1329746944,1329746944,"ORBit"],[1196640512,1196640527,"GemStone Systems, Inc."],[1179254784,1179254799,"Fujitsu Limited"],[1314079808,1314079823,"Compaq Computer"],[1329749760,1329749775,"TIBCO"],[1329679104,1329679119,"Camros Corporation"],[1096045568,1096045583,"AT&T Laboratories, Cambridge (OmniORB)"],[1330594560,1330594575,"IONA Technologies"],[1313161984,1313161987,"NEC Corporation"],[1112298752,1112298767,"Berry Software"],[1447646208,1447646463,"Vitra"],[1146046208,1146046463,"Exoffice Technologies"],[3406692352,3406692607,"Chicago Board of Exchange (CBOE)"],[1245790976,1245790991,"FU Berlin Institut für Informatik (JAC)"],[1481921088,1481921103,"Xtradyne Technologies AG"],[1413961728,1413961731,"Top Graph'X"],[1097097472,1097097475,"AdaOS project"],[1313819392,1313819647,"Nokia"],[1396788736,1396788751,"Sankhya Technologies Private Limited, India"],[1095648256,1095648271,"Androsoft GmbH"],[1111638784,1111638799,"Bionic Buffalo Corporation"],[1295069952,1295069952,"corba.js"]];let i;for(let s of e)if(s[0]<=t&&t<=s[1]){i=s[2];break}void 0===i&&(i=`0x${t.toString(16)}`)}case u.CODE_SETS:case u.POLICIES:}this.offset=i}}}this.endEncapsulation()}return e}value(t){return this.object(t,!0)}object(t,e=!1){const i=this.ulong();if(0===i)return;const s=this.offset-4;if(2147483392==(4294967040&i)){let e;if(1&i)throw Error("value_tag contains unsupported codebase URL");if(2==(6&i)){let t;const i=this.ulong();if(4294967295!==i)t=this.string(i);else{const e=this.offset,i=this.long(),s=this.offset;this.offset=e+i,0!=(3&this.offset)&&(console.error(`WRONG INDIRECTION: GOT 0x${this.offset.toString(16)}, EXPECTED 0x${(this.offset-(3&this.offset)).toString(16)}`),this.offset=this.offset-(3&this.offset)),t=this.string(),this.offset=s}if(t.length<8||"IDL:"!==t.substring(0,4)||":1.0"!==t.substring(t.length-4))throw Error(`Unsupported CORBA GIOP Repository ID '${t}'`);const s=t.substring(4,t.length-4);if(e=tt.lookupValueType(s),void 0===e)throw Error(`Unregistered Repository ID '${t}' (${s})`)}if(6==(6&i))throw Error("value_tag contains unsupported list of repository IDs");if(void 0===e&&void 0!==t&&(e=tt.lookupValueType(t)),void 0===e)throw Error("insufficient value type information");const o=new e(this);return this.objects.set(s+2,o),o}if(4294967295===i){let t=this.long();t+=2;const e=this.offset+t,i=this.objects.get(e);if(void 0===i)throw Error("IDL:omg.org/CORBA/MARSHAL:1.0");return i}if(i<2147483392){if(void 0===this.connection)throw Error("GIOPDecoder has no connection defined. Can not resolve resolve reference to stub object.");const t=this.reference(i);if(t.host==this.connection.localAddress&&t.port==this.connection.localPort)return this.connection.orb.servants.get(t.objectKey);let e=this.connection.stubsById.get(t.objectKey);if(void 0!==e)return e;const s=t.oid.substring(4,t.oid.length-4);let o=this.connection.orb.stubsByName.get(s);if(void 0===o)throw new Z(1330446339,E.NO);return e=new o(this.connection.orb,t.objectKey,this.connection),this.connection.stubsById.set(t.objectKey,e),e}throw Error(`GIOPDecoder: Unsupported value with CORBA tag 0x${i.toString(16)}`)}endian(){const t=this.octet();this.littleEndian=t===M.ENDIAN_LITTLE}blob(t){void 0===t&&(t=this.ulong());const e=this.bytes.subarray(this.offset,this.offset+t);return this.offset+=t,e}string(t){void 0===t&&(t=this.ulong());const e=this.bytes.subarray(this.offset,this.offset+t-1),i=B.textDecoder.decode(e);return this.offset+=t,i}sequence(t){const e=this.ulong(),i=new Array(e);for(let s=0;s<e;++s)i[s]=t();return i}bool(){const t=0!==this.data.getUint8(this.offset);return++this.offset,t}char(){const t=String.fromCharCode(this.data.getUint8(this.offset));return++this.offset,t}octet(){const t=this.data.getUint8(this.offset);return++this.offset,t}short(){this.align(2);const t=this.data.getInt16(this.offset,this.littleEndian);return this.offset+=2,t}ushort(){this.align(2);const t=this.data.getUint16(this.offset,this.littleEndian);return this.offset+=2,t}long(){this.align(4);const t=this.data.getInt32(this.offset,this.littleEndian);return this.offset+=4,t}ulong(){this.align(4);const t=this.data.getUint32(this.offset,this.littleEndian);return this.offset+=4,t}longlong(){this.align(8);const t=this.data.getBigInt64(this.offset,this.littleEndian);return this.offset+=8,t}ulonglong(){this.align(8);const t=this.data.getBigUint64(this.offset,this.littleEndian);return this.offset+=8,t}float(){this.align(4);const t=this.data.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t}double(){this.align(8);const t=this.data.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t}asn1number(){let t=0;for(;;){const e=this.octet();if(t<<=7,!(128&e)){t|=e;break}t|=127&e}return t}asn1tag(){const t=new A;let e,i=0;for(;i>=0;){const s=this.octet();switch(i){case 0:t.tagClass=(192&s)>>6,t.encoding=(32&s)>>5,t.tag=31&s,31==t.tag?(i=1,t.tag=0):i=2;break;case 1:t.tag<<=7,t.tag|=127&s,128&s&&(i=2);break;case 2:t.length=s,128&s?(e=127&t.length,t.length=0,i=3):i=-1;break;case 3:t.length<<=8,t.length|=s,0==--e&&(i=-1)}}return t}asn1oid(t){const e=[];let i=0,s=0;for(let o=0;o<t;++o){const t=this.octet();switch(i){case 0:e.push(Math.floor(t/40)),e.push(t%40),i=1;break;case 1:128&t?(s=127&t,i=2):e.push(t);break;case 2:s<<=7,s|=127&t,128&t||(e.push(s),i=1)}}return e}asn1expect(t,e,i){const s=this.asn1tag();if(s.tagClass===t&&s.tag===e&&s.encoding===i)return s;console.log("Can not authenticate client: ASN.1 decoding error")}asn1expectOID(t){const e=this.asn1expect(h.UNIVERSAL,d.OID,a.PRIMITIVE);if(void 0===e)return!1;const i=this.asn1oid(e.length);if(t.length!==i.length)return console.log("Can not authenticate client: Wrong OID"),!1;for(let e=0;e<t.length;++e)if(t[e]!==i[e])return console.log("Can not authenticate client: Wrong OID"),!1;return!0}align(t){const e=this.offset%t;0!==e&&(this.offset+=t-e)}}B.textDecoder=new TextDecoder;class H{constructor(){this.map=new Map}set(t,e){return this.map.set(H.hex(t),e),this}delete(t){return this.map.delete(H.hex(t))}get(t){return this.map.get(H.hex(t))}has(t){return this.map.has(H.hex(t))}get size(){return this.map.size}forEach(t,e){this.map.forEach(((i,s)=>t.call(e,i,H.unhex(s),this)))}clear(){this.map.clear()}static hex(t){let e="";for(let i=0;i<t.length;++i)e+=H.byteToHex[t[i]];return e}static unhex(t){const e=new Array(t.length/2);for(let i=0;i<t.length;i+=2)e[i]=parseInt(t[i]+t[i+1],16);return new Uint8Array(e)}}H.byteToHex=new Array(255),H.init=function(){for(let t=0;t<=255;++t){const e=t.toString(16).padStart(2,"0");H.byteToHex[t]=e}}();class G extends Object{constructor(){super(...arguments),this.addr=[]}toString(){return"corbaloc:"+this.toStringCore()}toStringCore(){let t="";for(let e=0;e<this.addr.length;++e){0!==e&&(t+=",");const i=this.addr[e];switch(i.proto){case"iiop":t+=`${i.proto}:${i.major}.${i.minor}@${i.host}:${i.port}`;break;case"rir":t+="rir:"}}return void 0!==this.objectKey&&(t+="/"+this.objectKey),t}}class V extends G{constructor(){super(),this.name="",this.objectKey="NameService"}toString(){let t="corbaname:";return t+=this.toStringCore(),void 0!==this.name&&(t+="#"+this.name),t}}class F{constructor(){this.proto="iiop",this.major=1,this.minor=0,this.host="",this.port=2809}}class ${constructor(t){this.url=new U(t)}parse(){if(this.url.match("IOR:"))return new s(this.url.data);if(this.url.match("corbaloc:"))return this.loc=new G,this.corbaloc();if(this.url.match("corbaname:"))return this.corbaname();throw Error("Bad string, expected on of 'IOR:...', 'corbaloc:...' or 'corbaname:...'")}corbaname(){const t=new V;if(this.loc=t,this.corbaloc(),this.url.match("#")){const e=this.url.uri();void 0!==e&&(t.name=e)}return t}corbaloc(){if(this.obj_addr_list(),this.url.match("/")){const t=this.key_string();this.loc.objectKey=t}return this.loc}obj_addr_list(){do{this.addr=new F,this.obj_addr(),this.loc.addr.push(this.addr)}while(this.url.match(","))}obj_addr(){this.prot_addr()}prot_addr(){return!!this.rir_prot_addr()||(!!this.iiop_prot_addr()||void 0)}rir_prot_addr(){return this.url.match("rir:")&&(this.addr.proto="rir"),!1}iiop_prot_addr(){return!!this.iiop_id()&&(this.iiop_addr(),!0)}iiop_id(){return!!this.url.match("iiop:")||!!this.url.match(":")}iiop_addr(){if(this.version(),this.host(),this.url.match(":")){const t=this.port();if(void 0===t)throw Error("missing port number after :");this.addr.port=t}}version(){const t=this.url.pos,e=this.url.number();if(void 0===e)return;if(void 0===this.url.match("."))return void(this.url.pos=t);const i=this.url.number();void 0!==i&&void 0!==this.url.match("@")?(this.addr.major=e,this.addr.minor=i):this.url.pos=t}host(){const t=this.url.pos;if(this.url.match("[")){const e=this.url.data.indexOf("]",t);if(-1===e)throw Error("missing ] in IPv6 address");this.addr.host=this.url.data.substring(t,e),this.url.pos=e+1}do{this.label()}while(this.url.match("."));if(t==this.url.pos)return;const e=this.url.data.substring(t,this.url.pos);return this.addr.host=e,e}label(){let t=this.url.getc();if(!U.isAlphaNumeric(t))return this.url.ungetc(),!1;do{t=this.url.getc()}while(U.isAlphaNumeric(t)||"-"==t);return this.url.ungetc(),!0}port(){return this.url.number()}key_string(){return this.url.uri()}}class U{constructor(t){this.pos=0,this.state=0,this.data=t}match(t){if(!(this.pos+t.length>this.data.length)&&this.data.substring(this.pos,this.pos+t.length)==t)return this.pos+=t.length,t}number(){const t=this.pos;for(;U.isDigit(this.getc()););if(this.ungetc(),t!==this.pos)return parseInt(this.data.substring(t,this.pos))}uri(){const t=this.pos;for(;!this.eof();){let t=this.getc();if(!U.isAlphaNumeric(t)&&-1==="%;/:?:@&=+$,-_!~*’|()".indexOf(t)){this.ungetc();break}}if(this.pos!==t)return decodeURI(this.data.substring(t,this.pos))}eof(){return this.pos>=this.data.length}getc(){return this.data[this.pos++]}ungetc(){--this.pos}static isAlpha(t){let e=t.charCodeAt(0);return 65<=e&&e<=90||97<=e&&e<=122}static isDigit(t){let e=t.charCodeAt(0);return 48<=e&&e<=57}static isAlphaNumeric(t){return U.isAlpha(t)||U.isDigit(t)}}class W extends Error{}!function(t){t[t.YES=0]="YES",t[t.NO=1]="NO",t[t.MAYBE=2]="MAYBE"}(E||(E={}));class z extends W{constructor(t,e){super(),this.minor=t,this.completed=e}}class j extends z{constructor(t,e){super(t,e);let i={1330446337:"Unable to locate value factory.",1330446338:"ServerRequest::set_result called before ServerRequest::ctx when the operation IDL contains a context clause.",1330446339:"NVList passed to ServerRequest::arguments does not describe all parameters passed by client.",1330446340:"Attempt to marshal local object.",1330446341:"wchar or wstring data erroneously sent by client over GIOP 1.0 connection.",1330446342:"wchar or wstring data erroneously returned by server over GIOP 1.0 connection.",1330446343:"Unsupported RMI/IDL custom value type stream format.",1096024074:"Pass end of message",1096024082:"Sequence is too long",1096024085:"Index out of range",1096024086:"Received an invalid zero length string",1096024116:"Invalid IOR",1096024143:"Invalid ContextList",1096024154:"Invalid Indirection",1096024155:"Invalid TypeCodeKind",1096024157:"Message too long",1096024176:"Invalid value tag"};const s=this.minor in i?`, ${i[this.minor]}`:"";this.message=`MARSHAL(minor=0x${this.minor.toString(16)}, completed=${E[this.completed]}${s})`}get major(){return"IDL:omg.org/CORBA/MARSHAL:1.0"}}class Y extends z{constructor(t,e){super(t,e)}toString(){return`NO_PERMISSION(minor=0x${this.minor.toString(16)}, completed=${E[this.completed]})`}get major(){return"IDL:omg.org/CORBA/NO_PERMISSION:1.0"}}class q extends z{constructor(t,e){super(t,e);let i={1096024093:"Invalid initial size"};const s=this.minor in i?`, ${i[this.minor]}`:"";this.message=`BAD_PARAM(minor=0x${this.minor.toString(16)}, completed=${E[this.completed]}${s})`}get major(){return"IDL:omg.org/CORBA/BAD_PARAM:1.0"}}class K extends z{constructor(t,e){super(t,e)}toString(){return`BAD_OPERATION(minor=0x${this.minor.toString(16)}, completed=${E[this.completed]})`}get major(){return"IDL:omg.org/CORBA/BAD_OPERATION:1.0"}}class X extends z{constructor(t,e){super(t,e)}toString(){return`OBJECT_NOT_EXIST(minor=0x${this.minor.toString(16)}, completed=${E[this.completed]})`}get major(){return"IDL:omg.org/CORBA/OBJECT_NOT_EXIST:1.0"}}class J extends z{constructor(t,e){super(t,e);let i={1096024066:"Connect Failed"};const s=this.minor in i?`, ${i[this.minor]}`:"";this.message=`TRANSIENT(minor=0x${this.minor.toString(16)}, completed=${E[this.completed]}${s})`}get major(){return"IDL:omg.org/CORBA/TRANSIENT:1.0"}}class Z extends z{constructor(t,e){super(t,e);let i={1330446337:"POA Unknown adapter",1330446338:"No servant",1330446339:"No default servant",1330446340:"No servant manager",1330446341:"Wrong incarnate policy",1096024079:"BiDir not allowed",1096024097:"BOA not initialized",1096024117:"POA not initialized",1096024127:"Servant already active",1096024161:"Incompatible servant"};const s=this.minor in i?`, ${i[this.minor]}`:"";this.message=`OBJECT_ADAPTER(minor=0x${this.minor.toString(16)}, completed=${E[this.completed]}${s})`}get major(){return"IDL:omg.org/CORBA/OBJECT_ADAPTER:1.0"}}class Q{constructor(t,e){this.decode=t,this.reject=e}}class tt{constructor(){this.debug=0,this.name="",this.stubsByName=new Map,this.servants=new H,this.servantIdCounter=0n,this.accesibleServants=new Set,this.initialReferences=new Map,this.listeners=new Map,this.protocols=[],this.connections=[],this.namingService=new rt(this),this.initialReferences.set("NameService",this.namingService),this.servants.set(tt.nameServiceKey,this.namingService)}addProtocol(t){this.protocols.push(t)}addConnection(t){this.connections.push(t)}removeConnection(t){for(let e=0;e<this.connections.length;++e)if(t===this.connections[e]){this.connections.splice(e,1);break}}logConnection(){this.connections.forEach((t=>console.log(`CONNECTION ${t.localAddress}:${t.localPort}->${t.remoteAddress}:${t.remotePort}`)))}async shutdown(){for(let t=0;t<this.protocols.length;++t)await this.protocols[t].close();for(let t=0;t<this.connections.length;++t)await this.connections[t].close();this.connections.length=0}async replaceAllConnections(){const t=this.connections.map((t=>t));for(let e=0;e<t.length;++e){const i=t[e];this.removeConnection(i);const s=await this.getConnection(i.remoteAddress,i.remotePort);i.close(),i.stubsById.forEach(((t,e)=>{t.connection=s,s.stubsById.set(e,t)})),i.stubsById.clear()}}async getConnection(t,e){"::1"===t&&(t="localhost");for(const i of this.connections)if(i.remoteAddress==t&&i.remotePort==e)return i;for(const i of this.protocols){if(this.debug){0===this.connections.length?console.log(`ORB: Creating new connection to ${t}:${e} as no others exist`):console.log(`ORB: Creating new connection to ${t}:${e}, as none found to`);for(const t of this.connections)console.log(`ORB:  active connection ${t.remoteAddress}:${t.remotePort}`)}return await i.connect(this,t,e)}throw Error(`failed to allocate connection to ${t}:${e}`)}async stringToObject(t){const e=new $(t).parse();if(e instanceof s)return this.iorToObject(new s(t));if(e instanceof V){const t=e.addr[0];if("iiop"===t.proto){const i=await this.getConnection(t.host,t.port),s=(new TextEncoder).encode(e.objectKey);let o=i.stubsById.get(s);void 0===o&&(o=new ot(this,s,i),i.stubsById.set(s,o));const r=await o.resolve_str(e.name),n=await this.getConnection(r.host,r.port);let l=n.stubsById.get(r.objectKey);if(void 0!==l)return l;const a=r.oid.substring(4,r.oid.length-4);let h=n.orb.stubsByName.get(a);if(void 0===h)throw Error(`ORB: no stub registered for OID '${r.oid} (${a})'`);return l=new h(n.orb,r.objectKey,n),n.stubsById.set(r.objectKey,l),l}throw Error("yikes")}throw Error("yikes")}async iorToObject(t){const e=await this.getConnection(t.host,t.port);let i=e.stubsById.get(t.objectKey);if(void 0!==i)return i;const s=t.oid.substring(4,t.oid.length-4);let o=this.stubsByName.get(s);if(void 0===o)throw Error(`ORB: can not deserialize object of unregistered stub '${t.oid}' (${s})'`);return i=new o(this,t.objectKey,e),e.stubsById.set(t.objectKey,i),i}onewayCall(t,e,i){const s=t.connection.requestId;t.connection.requestId+=2,this.callCore(t.connection,s,!1,t.id,e,i)}twowayCall(t,e,i,s){const o=t.connection.requestId;return t.connection.requestId+=2,new Promise(((r,n)=>{try{t.connection.pendingReplies.set(o,new Q((t=>r(s(t))),n)),this.callCore(t.connection,o,!0,t.id,e,i)}catch(t){n(t)}}))}callCore(t,e,i,s,o,r){this.debug&&console.log(`ORB ${this.name}: send request method:${o}, requestId:${e}, responseExpected:${i} to ${t.remoteAddress}:${t.remotePort}`);const n=new P(t);n.encodeRequest(s,o,e,i),r(n),n.setGIOPHeader(c.REQUEST),t.send(n.buffer.slice(0,n.offset))}socketRcvd(t,e){const i=new B(e,t),s=i.scanGIOPHeader();switch(s){case c.LOCATE_REQUEST:{const e=i.scanLocateRequest(),s=this.servants.get(e.objectKey),o=new P(t);o.encodeLocateReply(e.requestId,void 0!==s?w.OBJECT_HERE:w.UNKNOWN_OBJECT),o.setGIOPHeader(c.LOCATE_REPLY),t.send(o.buffer.slice(0,o.offset))}break;case c.REQUEST:{const e=i.scanRequestHeader(),s=this.servants.get(e.objectKey);if(void 0===s){if(e.responseExpected){const i=new P(t);i.skipReplyHeader(),i.string("IDL:omg.org/CORBA/OBJECT_NOT_EXIST:1.0"),i.ulong(1330446337),i.ulong(E.NO);const s=i.offset;i.setGIOPHeader(c.REPLY),i.setReplyHeader(e.requestId,v.SYSTEM_EXCEPTION),t.send(i.buffer.slice(0,s))}return}for(let i=0;i<e.serviceContext.length;++i){const o=e.serviceContext[i];if(o instanceof T&&this.incomingAuthenticator&&s!==this.namingService&&this.incomingAuthenticator(t,o)!==p.SUCCESS){if(e.responseExpected){const i=new P(t);i.skipReplyHeader(),i.string("IDL:omg.org/CORBA/NO_PERMISSION:1.0"),i.ulong(0),i.ulong(E.NO);const s=i.offset;i.setGIOPHeader(c.REPLY),i.setReplyHeader(e.requestId,v.SYSTEM_EXCEPTION),t.send(i.buffer.slice(0,s))}return}}if("_is_a"==e.method){const o=i.string(),r=new P(t);r.skipReplyHeader(),r.bool(`IDL:${s.constructor._idlClassName()}:1.0`===o);const n=r.offset;return r.setGIOPHeader(c.REPLY),r.setReplyHeader(e.requestId,v.NO_EXCEPTION),void t.send(r.buffer.slice(0,n))}const o=s[`_orb_${e.method}`];if(void 0===o){if(e.responseExpected){const i=new P(t);i.skipReplyHeader(),i.string("IDL:omg.org/CORBA/BAD_OPERATION:1.0"),i.ulong(1330446338),i.ulong(E.NO);const s=i.offset;i.setGIOPHeader(c.REPLY),i.setReplyHeader(e.requestId,v.SYSTEM_EXCEPTION),t.send(i.buffer.slice(0,s))}return}const r=new P(t);r.skipReplyHeader(),o.call(s,i,r).then((()=>{if(e.responseExpected){const i=r.offset;r.setGIOPHeader(c.REPLY),r.setReplyHeader(e.requestId,v.NO_EXCEPTION),t.send(r.buffer.slice(0,i))}})).catch((i=>{if(e.responseExpected)if(i instanceof z){r.skipReplyHeader(),r.string(i.major),r.ulong(i.minor),r.ulong(i.completed);const s=r.offset;r.setGIOPHeader(c.REPLY),r.setReplyHeader(e.requestId,v.SYSTEM_EXCEPTION),t.send(r.buffer.slice(0,s))}else{r.skipReplyHeader(),r.string("IDL:mark13.org/CORBA/GENERIC:1.0"),r.ulong(0),r.ulong(0),r.string(`IDL:${s.constructor._idlClassName()}:1.0:${e.method}(): ${i.message}`);const o=r.offset;r.setGIOPHeader(c.REPLY),r.setReplyHeader(e.requestId,v.SYSTEM_EXCEPTION),t.send(r.buffer.slice(0,o))}else console.log("ORB: ignoring servant exception because method does not expect response"),console.log(i)}))}break;case c.REPLY:{const e=i.scanReplyHeader(),s=t.pendingReplies.get(e.requestId);if(void 0===s)return console.log(`corba.js: Unexpected reply to requestId ${e.requestId} from ${t.remoteAddress}:${t.remotePort}`),void console.log(t.pendingReplies);try{switch(t.pendingReplies.delete(e.requestId),e.replyStatus){case v.NO_EXCEPTION:s.decode(i);break;case v.USER_EXCEPTION:throw new Error(`User Exception for requestId ${e.requestId}`);case v.SYSTEM_EXCEPTION:const o=i.string(),r=i.ulong(),n=i.ulong();let l={267584:"OmniORB",291888:"GNU Classpath",300068:"IBM",300352:"IONA",304176:"JacORB",316179:"corba.js",324816:"OMG",341328:"SUN",345104:"TAO",353312:"Borland (VisiBroker)",659904:"Adiron"};const a=(4294963200&r)>>12,h=a in l?` ${l[a]}`:"";let d="";switch(o){case"IDL:omg.org/CORBA/MARSHAL:1.0":throw new j(r,n);case"IDL:omg.org/CORBA/TRANSIENT:1.0":throw new J(r,n);case"IDL:omg.org/CORBA/BAD_PARAM:1.0":throw new q(r,n);case"IDL:omg.org/CORBA/BAD_OPERATION:1.0":throw new K(r,n);case"IDL:omg.org/CORBA/OBJECT_NOT_EXIST:1.0":throw new X(r,n);case"IDL:omg.org/CORBA/OBJECT_ADAPTER:1.0":throw new Z(r,n);case"IDL:omg.org/CORBA/NO_PERMISSION:1.0":throw new Y(r,n);case"IDL:mark13.org/CORBA/GENERIC:1.0":throw new Error(`Remote CORBA exception on ${t.remoteAddress}:${t.remotePort}: ${i.string()}`)}throw new Error(`CORBA System Exception ${o} from ${t.remoteAddress}:${t.remotePort}:${h}${d} (0x${r.toString(16)}), operation completed: ${E[n]}`);default:throw new Error(`ReplyStatusType ${e.replyStatus} is not supported`)}}catch(t){s.reject(t)}}break;default:throw Error(`Received ${c[s]} which is not implemented in corba.js`)}}socketError(t,e){throw e}socketClosed(t){this.dispatchEvent(new Event("closed")),this.release(),this.removeConnection(t)}addEventListener(t,e,i){if(null===e)return;let s=this.listeners.get(t);void 0===s&&(s=new Set,this.listeners.set(t,s)),s.add(e)}removeEventListener(t,e,i){if(null==e)return;let s=this.listeners.get(t);void 0!==s&&s.delete(e)}dispatchEvent(t){let e=this.listeners.get(t.type);if(void 0===e)return!0;for(let i of e)"function"==typeof i?i(t):i.handleEvent(t);return!0}set onclose(t){this.listeners.delete("close"),this.addEventListener("close",t)}registerServant(t){let e=++this.servantIdCounter;const i=new BigUint64Array([e]),s=new Uint8Array(i.buffer);return this.servants.set(s,t),s}unregisterServant(t){this.servants.delete(t.id)}registerStubClass(t){this.stubsByName.set(t._idlClassName(),t)}releaseStub(t){}static registerValueType(t,e){let i=tt.valueTypeByName.get(t);if(void 0===i)throw console.log(`registerValueType: number of known types: ${tt.valueTypeByName.size}`),tt.valueTypeByName.forEach(((t,e)=>console.log(e))),Error(`ORB.registerValueType: valuetype '${t}' not defined in IDL`);i.name=t,i.construct=e,tt.valueTypeByPrototype.set(e.prototype,i)}static lookupValueType(t){let e=tt.valueTypeByName.get(t);if(void 0===e)throw Error(`ORB.lookupValueType: valuetype '${t}' not defined in IDL`);if(void 0===e.construct)throw Error(`ORB.lookupValueType: valuetype '${t}' not registered via ORB.registerValueType()`);return e.construct}bind(t,e){const i=this.initialReferences.get("NameService");if(void 0===i)throw Error("No NameService found.");if(!(i instanceof rt))throw Error("NameService is not of type IDL:omg.org/CosNaming/NamingContext:1.0");i.bind(t,e)}async list(){throw Error("Obsolete")}async resolve(t){throw Error("Obsolete: Use objectToString(`corbaname::${hostname}#${objectname}`) instead")}serialize(t){const e=new P;return e.endian(),e.value(t),e.buffer.slice(0,e.offset)}deserialize(t){const e=new B(t);return e.endian(),e.value()}setIncomingAuthenticator(t){this.incomingAuthenticator=t}setOutgoingAuthenticator(t){this.outgoingAuthenticator=t}release(){this.aclDeleteAll()}aclAdd(t){t.acl.add(this),this.accesibleServants.add(t)}aclDeleteAll(){for(let t of this.accesibleServants)t.acl.delete(this);this.accesibleServants.clear()}}tt.nameServiceKey=new Uint8Array((new TextEncoder).encode("NameService")),tt.valueTypeByName=new Map,tt.valueTypeByPrototype=new Map;class et{constructor(t,e){this.orb=t,this.id=e}}class it extends et{constructor(t){super(t,void 0),this.id=t.registerServant(this),this.acl=new Set}release(){}}class st extends et{constructor(t,e,i){super(t,e),this.connection=i}release(){this.orb.releaseStub(this)}}class ot extends st{static _idlClassName(){return"omg.org/CosNaming/NamingContextExt"}static narrow(t){if(t instanceof ot)return t;throw Error("NamingContextExt.narrow() failed")}async resolve_str(t){return await this.orb.twowayCall(this,"resolve_str",(e=>{e.string(t)}),(t=>t.reference()))}}class rt extends it{constructor(t){super(t),this.map=new Map}static _idlClassName(){return"omg.org/CosNaming/NamingContextExt"}bind(t,e){if(this.map.has(t))throw Error(`name '${t}' is already bound to object`);this.map.set(t,e)}async resolve(t){const e=this.map.get(t);if(void 0===e)throw Error(`orb ${this.orb.name}: name '${t}' is not bound to an object`);return e}async _orb_resolve(t,e){const i=t.ulong(),s=t.string(),o=t.string();1!==i&&0!==o.length&&console.log(`warning: resolve got ${i} (expected 1) and/or key is "${o}" (expected "")`);const r=await this.resolve(s);e.object(r)}async _orb_resolve_str(t,e){const i=t.string(),s=await this.resolve(i);e.object(s)}}class nt{async connect(t,e,i){return new Promise(((s,o)=>{const r=new WebSocket(`ws://${e}:${i}`);r.binaryType="arraybuffer";const n=new lt(t,r);t.addConnection(n),r.onopen=()=>{r.onmessage=async e=>{e.data instanceof Blob?t.socketRcvd(n,await e.data.arrayBuffer()):t.socketRcvd(n,e.data)},r.onerror=e=>{t.socketError(n,new Error(`WebSocket connection error with ${r.url}`))},r.onclose=e=>t.socketClosed(n),s(n)},r.onerror=t=>{o(new Error(`Failed to connect to ${r.url}`))}}))}async close(){}}class lt extends class{constructor(t){this.requestId=0,this.didSendBiDirIIOP=!1,this.stubsById=new H,this.pendingReplies=new Map,this.initialContextTokens=new Map,this.orb=t}}{constructor(t,e){super(t),this.socket=e}get localAddress(){return"browser"}get localPort(){return 0}get remoteAddress(){return this.socket.url}get remotePort(){return 0}close(){this.socket.close()}send(t){this.socket.send(t)}}class at extends st{static _idlClassName(){return"Board"}static narrow(t){if(t instanceof at)return t;throw Error("Board.narrow() failed")}getModel(){return i(this,void 0,void 0,(function*(){return yield this.orb.twowayCall(this,"getModel",(t=>{}),(t=>t.value("BoardModel")))}))}addListener(t){return i(this,void 0,void 0,(function*(){this.orb.onewayCall(this,"addListener",(e=>{e.object(t)}))}))}removeListener(t){return i(this,void 0,void 0,(function*(){this.orb.onewayCall(this,"removeListener",(e=>{e.object(t)}))}))}add(t,e){return i(this,void 0,void 0,(function*(){this.orb.onewayCall(this,"add",(i=>{i.ulong(t),i.value(e)}))}))}transform(t,e,s){return i(this,void 0,void 0,(function*(){this.orb.onewayCall(this,"transform",(i=>{i.ulong(t),i.sequence(e,(t=>i.ulong(t))),i.value(s)}))}))}}class ht extends st{static _idlClassName(){return"Project"}static narrow(t){if(t instanceof ht)return t;throw Error("Project.narrow() failed")}getBoard(t){return i(this,void 0,void 0,(function*(){return yield this.orb.twowayCall(this,"getBoard",(e=>{e.ulong(t)}),(t=>t.object()))}))}}class dt extends st{static _idlClassName(){return"Server"}static narrow(t){if(t instanceof dt)return t;throw Error("Server.narrow() failed")}setClient(t){return i(this,void 0,void 0,(function*(){this.orb.onewayCall(this,"setClient",(e=>{e.object(t)}))}))}initializeWebSession(t){return i(this,void 0,void 0,(function*(){this.orb.onewayCall(this,"initializeWebSession",(e=>{e.string(t)}))}))}logon(t,e,s){return i(this,void 0,void 0,(function*(){this.orb.onewayCall(this,"logon",(i=>{i.string(t),i.string(e),i.bool(s)}))}))}getProject(t){return i(this,void 0,void 0,(function*(){return yield this.orb.twowayCall(this,"getProject",(e=>{e.ulong(t)}),(t=>t.object()))}))}}class ct extends st{static _idlClassName(){return"WorkflowServer"}static narrow(t){if(t instanceof ct)return t;throw Error("WorkflowServer.narrow() failed")}getServer(){return i(this,void 0,void 0,(function*(){return yield this.orb.twowayCall(this,"getServer",(t=>{}),(t=>t.object()))}))}}function ut(t,e){if(e instanceof B){const i=e;t.x=i.double(),t.y=i.double()}else t.x=void 0===e||void 0===e.x?0:e.x,t.y=void 0===e||void 0===e.y?0:e.y}function gt(t,e){t.double(e.x),t.double(e.y)}function ft(t,e){if(e instanceof B){const i=e;t.width=i.double(),t.height=i.double()}else t.width=void 0===e||void 0===e.width?0:e.width,t.height=void 0===e||void 0===e.height?0:e.height}function pt(t,e){t.double(e.width),t.double(e.height)}function mt(t,e){t.double(e.a),t.double(e.b),t.double(e.c),t.double(e.d),t.double(e.e),t.double(e.f)}function yt(t,e){if(e instanceof B){const i=e;t.origin=i.value("Point"),t.size=i.value("Size")}else{const i=tt.lookupValueType("Point");t.origin=i.prototype.isPrototypeOf(null==e?void 0:e.origin)?e.origin:new i(null==e?void 0:e.origin);const s=tt.lookupValueType("Size");t.size=s.prototype.isPrototypeOf(null==e?void 0:e.size)?e.size:new s(null==e?void 0:e.size)}}function vt(t,e){t.value(e.origin),t.value(e.size)}function wt(t,e){t.ulong(e.id),t.value(e.matrix)}function Et(t,e){t.sequence(e.data,(e=>t.value(e)))}function bt(t,e){Et(t,e),t.ulong(e.id),t.string(e.name)}function At(t,e){t.ulong(e.uid),t.string(e.name),t.string(e.password),t.string(e.email),t.string(e.fullname),t.string(e.avatar)}function xt(t,e){t.ulong(e.id),t.string(e.name),t.string(e.description)}function Ct(t,e){t.ulong(e.bid),t.string(e.name),t.string(e.description),t.sequence(e.layers,(e=>t.value(e)))}!function(t){function e(t,e){wt(t,e),t.string(e.stroke),t.double(e.strokeWidth),t.string(e.fill)}function i(t,i){e(t,i),t.value(i.origin),t.value(i.size)}function s(t,e){wt(t,e),t.sequence(e.childFigures,(e=>t.value(e)))}t.initAttributedFigure=function(t,e){if(e instanceof B){const i=e;t.stroke=i.string(),t.strokeWidth=i.double(),t.fill=i.string()}else t.stroke=void 0===e||void 0===e.stroke?"":e.stroke,t.strokeWidth=void 0===e||void 0===e.strokeWidth?0:e.strokeWidth,t.fill=void 0===e||void 0===e.fill?"":e.fill},t.encodeAttributedFigure=e,t.initShape=function(t,e){if(e instanceof B){const i=e;t.origin=i.value("Point"),t.size=i.value("Size")}else{const i=tt.lookupValueType("Point");t.origin=i.prototype.isPrototypeOf(null==e?void 0:e.origin)?e.origin:new i(null==e?void 0:e.origin);const s=tt.lookupValueType("Size");t.size=s.prototype.isPrototypeOf(null==e?void 0:e.size)?e.size:new s(null==e?void 0:e.size)}},t.encodeShape=i,t.initRectangle=function(t,e){},t.encodeRectangle=function(t,e){i(t,e)},t.initCircle=function(t,e){},t.encodeCircle=function(t,e){i(t,e)},t.initText=function(t,e){if(e instanceof B){const i=e;t.text=i.string()}else t.text=void 0===e||void 0===e.text?"":e.text},t.encodeText=function(t,e){i(t,e),t.string(e.text)},t.initPath=function(t,e){if(e instanceof B){const i=e;t.types=i.sequence((()=>i.octet())),t.values=i.sequence((()=>i.double()))}else t.types=void 0===e||void 0===e.types?new Array:e.types,t.values=void 0===e||void 0===e.values?new Array:e.values},t.encodePath=function(t,i){e(t,i),t.sequence(i.types,(e=>t.octet(e))),t.sequence(i.values,(e=>t.double(e)))},t.initGroup=function(t,e){if(e instanceof B){const i=e;t.childFigures=i.sequence((()=>i.value("Figure")))}else t.childFigures=void 0===e||void 0===e.childFigures?new Array:e.childFigures},t.encodeGroup=s,t.initTransform=function(t,e){},t.encodeTransform=function(t,e){s(t,e)}}(b||(b={}));let St=!1;St||(St=!0,tt.valueTypeByName.set("Point",{attributes:["x","y"],encode:gt}),tt.valueTypeByName.set("Size",{attributes:["width","height"],encode:pt}),tt.valueTypeByName.set("Matrix",{attributes:["a","b","c","d","e","f"],encode:mt}),tt.valueTypeByName.set("Rectangle",{attributes:["origin","size"],encode:vt}),tt.valueTypeByName.set("Figure",{attributes:["id","matrix"],encode:wt}),tt.valueTypeByName.set("figure.AttributedFigure",{attributes:["id","matrix","stroke","strokeWidth","fill"],encode:b.encodeAttributedFigure}),tt.valueTypeByName.set("figure.Shape",{attributes:["id","matrix","stroke","strokeWidth","fill","origin","size"],encode:b.encodeShape}),tt.valueTypeByName.set("figure.Rectangle",{attributes:["id","matrix","stroke","strokeWidth","fill","origin","size"],encode:b.encodeRectangle}),tt.valueTypeByName.set("figure.Circle",{attributes:["id","matrix","stroke","strokeWidth","fill","origin","size"],encode:b.encodeCircle}),tt.valueTypeByName.set("figure.Text",{attributes:["id","matrix","stroke","strokeWidth","fill","origin","size","text"],encode:b.encodeText}),tt.valueTypeByName.set("figure.Path",{attributes:["id","matrix","stroke","strokeWidth","fill","types","values"],encode:b.encodePath}),tt.valueTypeByName.set("figure.Group",{attributes:["id","matrix","childFigures"],encode:b.encodeGroup}),tt.valueTypeByName.set("figure.Transform",{attributes:["id","matrix","childFigures"],encode:b.encodeTransform}),tt.valueTypeByName.set("FigureModel",{attributes:["data"],encode:Et}),tt.valueTypeByName.set("Layer",{attributes:["data","id","name"],encode:bt}),tt.valueTypeByName.set("User",{attributes:["uid","name","password","email","fullname","avatar"],encode:At}),tt.valueTypeByName.set("Card",{attributes:["id","name","description"],encode:xt}),tt.valueTypeByName.set("BoardModel",{attributes:["bid","name","description","layers"],encode:Ct}));class Tt{constructor(t,e){t instanceof B?ut(this,t):void 0===t?ut(this):ut(this,"object"==typeof t?t:{x:t,y:e})}toString(){return`Point(${this.x}, ${this.y})`}}class _t{constructor(t,e){t instanceof B?ft(this,t):void 0===t?ft(this):ft(this,"object"==typeof t?t:{width:t,height:e})}toString(){return`Size(${this.width}, ${this.height})`}}class Rt{constructor(t){!function(t,e){if(e instanceof B){const i=e;t.a=i.double(),t.b=i.double(),t.c=i.double(),t.d=i.double(),t.e=i.double(),t.f=i.double()}else t.a=void 0===e||void 0===e.a?0:e.a,t.b=void 0===e||void 0===e.b?0:e.b,t.c=void 0===e||void 0===e.c?0:e.c,t.d=void 0===e||void 0===e.d?0:e.d,t.e=void 0===e||void 0===e.e?0:e.e,t.f=void 0===e||void 0===e.f?0:e.f}(this,t),void 0===t&&(this.a=1,this.d=1)}isIdentity(){return 1===this.a&&0===this.b&&0===this.c&&1===this.d&&0===this.e&&0===this.f}isOnlyTranslate(){return 1===this.a&&0===this.b&&0===this.c&&1===this.d}isOnlyTranslateAndScale(){return 0===this.b&&0===this.c}identity(){return[this.a,this.b,this.c,this.d,this.e,this.f]=[1,0,0,1,0,0],this}append(t){return[this.a,this.b,this.c,this.d,this.e,this.f]=[this.a*t.a+this.c*t.b,this.b*t.a+this.d*t.b,this.a*t.c+this.c*t.d,this.b*t.c+this.d*t.d,this.a*t.e+this.c*t.f+this.e,this.b*t.e+this.d*t.f+this.f],this}prepend(t){return[this.a,this.b,this.c,this.d,this.e,this.f]=[t.a*this.a+t.c*this.b,t.b*this.a+t.d*this.b,t.a*this.c+t.c*this.d,t.b*this.c+t.d*this.d,t.a*this.e+t.c*this.f+t.e,t.b*this.e+t.d*this.f+t.f],this}invert(){let t=1/(this.a*this.d-this.c*this.b),e=t*this.d,i=t*-this.b,s=t*-this.c,o=t*this.a,r=t*(this.c*this.f-this.d*this.e),n=t*(this.b*this.e-this.a*this.f);return this.a=e,this.b=i,this.c=s,this.d=o,this.e=r,this.f=n,this}translate(t){let e=new Rt({a:1,c:0,e:t.x,b:0,d:1,f:t.y});return this.prepend(e),this}rotate(t){let e=new Rt({a:Math.cos(t),c:-Math.sin(t),e:0,b:Math.sin(t),d:Math.cos(t),f:0});return this.prepend(e),this}getRotation(){let t=-Math.atan2(-this.b,this.a);return Gt(t,-Math.atan2(this.c,this.d))?(t<0&&(t=Math.PI+t),t):NaN}scale(t,e){let i=new Rt({a:t,c:0,e:0,b:0,d:e,f:0});return this.prepend(i),this}postTranslate(t){let e=new Rt({a:1,c:0,e:t.x,b:0,d:1,f:t.y});return this.append(e),this}postRotate(t){let e=new Rt({a:Math.cos(t),c:-Math.sin(t),e:0,b:Math.sin(t),d:Math.cos(t),f:0});return this.append(e),this}postScale(t,e){let i=new Rt({a:t,c:0,e:0,b:0,d:e,f:0});return this.append(i),this}transformPoint(t){return new Tt({x:t.x*this.a+t.y*this.c+this.e,y:t.x*this.b+t.y*this.d+this.f})}transformArrayPoint(t){return[t[0]*this.a+t[1]*this.c+this.e,t[0]*this.b+t[1]*this.d+this.f]}transformSize(t){return new _t({width:t.width*this.a+t.height*this.c,height:t.width*this.b+t.height*this.d})}toString(){return`{rotate: [${this.a}, ${this.b}, ${this.c}, ${this.d}], translate: [${this.e}, ${this.f}]}`}}function Nt(t,e){return new Tt({x:t.x+e.width,y:t.y+e.height})}function Ot(t,e){return new Tt({x:t.x+e.x,y:t.y+e.y})}function It(t,e){return new Tt({x:t.x-e.x,y:t.y-e.y})}function kt(t,e){return It(t,It(e,t))}function Dt(t,e){return new Tt({x:t.x*e,y:t.y*e})}function Lt(t){return new Tt({x:-t.x,y:-t.y})}function Mt(t,e,i){let s=It(t,e),o=Math.atan2(s.y,s.x)+i,r=Math.sqrt(s.x*s.x+s.y*s.y);return new Tt(e.x+Math.cos(o)*r,e.y+Math.sin(o)*r)}const Pt=1e-9;function Bt(t){return Math.abs(t)<=Pt}function Ht(t){return 1-Math.abs(t)<=Pt}function Gt(t,e){return Bt(t-e)}function Vt(t,e){return Bt(t.x-e.x)&&Bt(t.y-e.y)}function Ft(t){return t.x*t.x+t.y*t.y}function $t(t,e){return Math.sqrt(Ft(It(e,t)))}function Ut(t,e,i){let s=It(i,e),o=It(t,e),r=Ft(s),n=function(t,e){return t.x*e.x+t.y*e.y}(o,s)/r;return n<0||n>1?1/0:Math.abs(s.y*o.x-s.x*o.y)/Math.sqrt(r)}function Wt(t,e){let i=t[1].x-t[0].x,s=t[1].y-t[0].y,o=e[1].x-e[0].x,r=e[1].y-e[0].y,n=i*r-s*o;if(Bt(n))return!1;let l=t[0].x-e[0].x,a=t[0].y-e[0].y,h=(o*a-r*l)/n,d=(i*a-s*l)/n;return!(Bt(h)||Ht(h)||Bt(d)||Ht(d))&&!(h<=0||h>=1||d<=0||d>=1)}function zt(t,e){return function(t,e,i,s,o,r,n,l){let a=[{x:t,y:e},{x:i,y:s}];return!!(Wt(a,[{x:o,y:r},{x:n,y:r}])||Wt(a,[{x:o,y:l},{x:n,y:l}])||Wt(a,[{x:o,y:r},{x:o,y:l}])||Wt(a,[{x:n,y:r},{x:n,y:l}]))}(t[0].x,t[0].y,t[1].x,t[1].y,e.origin.x,e.origin.y,e.origin.x+e.size.width,e.origin.y+e.size.height)}class jt{constructor(t,e,i,s){if(t instanceof B)yt(this,t);else if(void 0===t)yt(this);else if(void 0===e){if(!t.hasOwnProperty("origin")||!t.hasOwnProperty("size"))throw Error("yikes");yt(this,t)}else if(void 0===i){if(!(t.hasOwnProperty("x")&&t.hasOwnProperty("y")&&e.hasOwnProperty("width")&&e.hasOwnProperty("height")))throw Error("yikes");yt(this,{origin:t,size:e})}else{if("number"!=typeof t||"number"!=typeof e)throw Error("yikes");yt(this,{origin:{x:t,y:e},size:{width:i,height:s}})}}set(t,e,i,s){return this.origin.x=t,this.origin.y=e,this.size.width=i,this.size.height=s,this}contains(t){return this.origin.x<=t.x&&t.x<=this.origin.x+this.size.width&&this.origin.y<=t.y&&t.y<=this.origin.y+this.size.height}inside(t){return this.origin.x<t.x&&t.x<this.origin.x+this.size.width&&this.origin.y<t.y&&t.y<this.origin.y+this.size.height}containsRectangle(t){return this.contains(t.origin)&&this.contains(new Tt({x:t.origin.x+t.size.width,y:t.origin.y}))&&this.contains(new Tt({x:t.origin.x+t.size.width,y:t.origin.y+t.size.height}))&&this.contains(new Tt({x:t.origin.x,y:t.origin.y+t.size.height}))}intersects(t){let e=this.origin.x,i=e+this.size.width;e>i&&([e,i]=[i,e]);let s=t.origin.x,o=s+t.size.width;s>o&&([s,o]=[o,s]);let r=this.origin.y,n=r+this.size.height;r>n&&([r,n]=[n,r]);let l=t.origin.y,a=l+t.size.height;l>a&&([l,a]=[a,l]);let h=0;e<s&&(h|=1),e>o&&(h|=2),r<l&&(h|=4),r>a&&(h|=8);let d=0;return i<s&&(d|=1),i>o&&(d|=2),n<l&&(d|=4),n>a&&(d|=8),0==(h&d)}expandByPoint(t){return t.x<this.origin.x?(this.size.width+=this.origin.x-t.x,this.origin.x=t.x):t.x>this.origin.x+this.size.width&&(this.size.width=t.x-this.origin.x),t.y<this.origin.y?(this.size.height+=this.origin.y-t.y,this.origin.y=t.y):t.y>this.origin.y+this.size.height&&(this.size.height=t.y-this.origin.y),this}center(){return new Tt({x:this.origin.x+this.size.width/2,y:this.origin.y+this.size.height/2})}forAllEdges(t,e){void 0!==e?(t(e.transformPoint(this.origin)),t(e.transformPoint(Nt(this.origin,{width:this.size.width,height:0}))),t(e.transformPoint(Nt(this.origin,{width:0,height:this.size.height}))),t(e.transformPoint(Nt(this.origin,this.size)))):(t(this.origin),t(Nt(this.origin,{width:this.size.width,height:0})),t(Nt(this.origin,{width:0,height:this.size.height})),t(Nt(this.origin,this.size)))}expandByRectangle(t,e){return 0===this.size.width&&0===this.size.height?(this.origin.x=t.origin.x,this.origin.y=t.origin.y,this.size.width=t.size.width,this.size.height=t.size.height):t.forAllEdges((t=>{this.expandByPoint(t)}),e),this}inflate(t){return this.origin.x-=t,this.origin.y-=t,t*=2,this.size.width+=t,this.size.height+=t,this}toString(){return`Rectangle(${this.origin.x}, ${this.origin.y}, ${this.size.width}, ${this.size.height})`}}class Yt{constructor(t){!function(t,e){if(e instanceof B){const i=e;t.id=i.ulong(),t.matrix=i.value("Matrix")}else t.id=void 0===e||void 0===e.id?0:e.id,void 0!==e&&void 0!==e.matrix&&(t.matrix=new(tt.lookupValueType("Matrix | undefined"))(e.matrix))}(this,t)}updateSVG(t,e,i){throw Error("updateSVG is not implemented for this class")}}Yt.FIGURE_RANGE=5,Yt.HANDLE_RANGE=5,Yt.DRAG_START_DISTANCE=1;class qt extends Yt{constructor(t){super(t),t instanceof B?b.initAttributedFigure(this,t):(this.stroke="#000",this.strokeWidth=1,this.fill="#fff")}}class Kt extends qt{constructor(t){super(t),b.initShape(this,t)}transform(t){return!!t.isOnlyTranslateAndScale()&&(this.origin=t.transformPoint(this.origin),this.size=t.transformSize(this.size),!0)}bounds(){return new jt(this)}getHandlePosition(t){switch(t){case 0:return{x:this.origin.x,y:this.origin.y};case 1:return{x:this.origin.x+this.size.width,y:this.origin.y};case 2:return{x:this.origin.x+this.size.width,y:this.origin.y+this.size.height};case 3:return{x:this.origin.x,y:this.origin.y+this.size.height}}}setHandlePosition(t,e){if(t<0||t>3)throw Error("yikes");0==t||3==t?(this.size.width+=this.origin.x-e.x,this.origin.x=e.x):this.size.width+=e.x-(this.origin.x+this.size.width),0==t||1==t?(this.size.height+=this.origin.y-e.y,this.origin.y=e.y):this.size.height+=e.y-(this.origin.y+this.size.height)}}function Xt(t,e){return(t+e)/2}function Jt(t,e,i,s){const o=t-i,r=e-s;return Math.sqrt(o*o+r*r)}function Zt(t,e,i,s,o,r,n,l,a,h,d=0,c=1){const u=o-i,g=n-o,f=r-s,p=l-r,m=u*p-f*g,y=g*(h-l)-p*(a-n),v=a-i,w=h-s,E=(n-i)*w-(l-s)*v,b=u*w-f*v;if(Math.abs(m)+Math.abs(y)+Math.abs(E)+Math.abs(b)<1){let u=Jt(t,e,i,s),g=0,f={x:i,y:s},p=Jt(t,e,o,r);return p<u&&(u=p,g=1,f={x:o,y:r}),p=Jt(t,e,n,l),p<u&&(u=p,g=2,f={x:n,y:l}),p=Jt(t,e,a,h),p<u&&(u=p,g=3,f={x:a,y:h}),{point:f,distance:u,u:d+(c-d)*g/3}}const A=Xt(o,n),x=Xt(r,l),C=Xt(i,o),S=Xt(s,r),T=Xt(n,a),_=Xt(l,h),R=Xt(C,A),N=Xt(S,x),O=Xt(A,T),I=Xt(x,_),k=Xt(R,O),D=Xt(N,I),L=Zt(t,e,i,s,C,S,R,N,k,D,d,d+(c-d)/2),M=Zt(t,e,k,D,O,I,T,_,a,h,d+(c-d)/2,c);return L.distance<M.distance?L:M}function Qt(t,e,i,s,o,r){let n,l,a=function(t,e,i,s){const o=Number.EPSILON/2;if(Math.abs(t)<o)return Math.abs(e)>=o?(s[0]=-i/e,1):Math.abs(i)<o?-1:0;let r=e*e-4*t*i;if(r<0)return 0;r=Math.sqrt(r),e<0&&(r=-r);r=-.5*(e+r);let n=0;Math.abs(r)>=o&&(s[n++]=i/r);Math.abs(t)>=o&&(s[n++]=r/t);return n}(t,e,i,s);if(void 0===o||void 0===r)return a;for(n=0,l=0;n<a;++n)l!=n&&(s[l]=s[n]),s[n]>=o&&s[n]<=r&&++l;return l}function te(t,e,i,s,o){let r=t-e,n=t+e;0==i?(r<s.x&&(s.x=r),n>o.x&&(o.x=n)):(r<s.y&&(s.y=r),n>o.y&&(o.y=n))}function ee(t,e,i,s,o,r,n,l){const a=[],h=Qt(3*(e-i)-t+s,2*(t+i)-4*e,e-t,a,0,1),d=Number.EPSILON/2,c=1-d;te(s,0,o,n,l);for(let u=0;u<h;u++){const h=a[u];if(d<h&&h<c){const a=h*h,d=1-h,c=d*d;te(c*d*t+3*c*h*e+3*d*a*i+a*h*s,r,o,n,l)}}}function ie(t){let e={x:t[0].x,y:t[0].y},i={x:t[0].x,y:t[0].y};return ee(t[0].x,t[1].x,t[2].x,t[3].x,0,0,e,i),ee(t[0].y,t[1].y,t[2].y,t[3].y,1,0,e,i),new jt({origin:e,size:(s=i,o=e,{width:s.x-o.x,height:s.y-o.y})});var s,o}function se(t,e,i,s){const o=t*t-3*e,r=2*t*t*t-9*t*e+27*i,n=o/9,l=r/54;if(0===l&&0===n)return s[0]=-t/3,1;if(729*r*r===2916*o*o*o){const e=Math.sqrt(n);return l>0?(s[0]=-2*e-t/3,s[1]=e-t/3):(s[0]=-e-t/3,s[1]=2*e-t/3),2}const a=n*n*n,h=l*l;if(h<a){const e=(l>=0?1:-1)*Math.sqrt(h/a),i=Math.acos(e),o=-2*Math.sqrt(n);return s[0]=o*Math.cos(i/3)-t/3,s[1]=o*Math.cos((i+2*Math.PI)/3)-t/3,s[2]=o*Math.cos((i-2*Math.PI)/3)-t/3,s[0]>s[1]&&([s[0],s[1]]=[s[1],s[0]]),s[1]>s[2]&&([s[1],s[2]]=[s[2],s[1]],s[0]>s[1]&&([s[0],s[1]]=[s[1],s[0]])),3}const d=-(l>=0?1:-1)*Math.pow(Math.abs(l)+Math.sqrt(h-a),1/3),c=n/d;return s[0]=d+c-t/3,1}function oe(t,e){const i=1-e,s=i*i,o=e*e;return t[0].x*s*i+t[1].x*e*s*3+t[2].x*o*i*3+t[3].x*o*e}function re(t,e){const i=e*e;return t[0].y*(6*e-3-2*i)+t[1].y*(3-12*e+9*i)+t[2].y*(6*e-9*i)+2*t[3].y*i}class ne{constructor(t,e,i,s){this.type=t,this.src=e,this.u=i,this.pt=s}}class le{constructor(t,e,i,s,o,r,n,l){this.seg0=new ne(t,e,i,s),this.seg1=new ne(o,r,n,l)}}function ae(t,e){let i=t[1].x-t[0].x,s=t[1].y-t[0].y,o=e[1].x-e[0].x,r=e[1].y-e[0].y,n=i*r-s*o;if(Bt(n))return;let l=t[0].x-e[0].x,a=t[0].y-e[0].y,h=(o*a-r*l)/n,d=(i*a-s*l)/n;return h<0||h>1||d<0||d>1?void 0:new Tt(t[0].x+h*i,t[0].y+h*s)}function he(t,e,i){let s=e[1].x-e[0].x,o=e[1].y-e[0].y,r=i[1].x-i[0].x,n=i[1].y-i[0].y,l=s*n-o*r;if(Bt(l))return;let a=e[0].x-i[0].x,h=e[0].y-i[0].y,d=(r*h-n*a)/l,c=(s*h-o*a)/l;if(d<0||d>1||c<0||c>1)return;let u=new Tt(e[0].x+d*s,e[0].y+d*o);t.push(new le("L",e,d,u,"L",i,c,u))}function de(t,e,i){return i[0].y<=e.y?i[1].y>e.y&&ue(i[0],i[1],e)>0&&++t:i[1].y<=e.y&&ue(i[0],i[1],e)<0&&--t,t}function ce(t,e,i){const s=function(t,e){let i=0,s=0;for(let o of function(t,e){if(Gt(t[0].y,t[1].y)&&Gt(t[0].y,t[2].y)&&Gt(t[0].y,t[3].y))return[];let i=Math.min(Math.min(t[0].y,t[1].y),Math.min(t[2].y,t[3].y)),s=Math.max(Math.max(t[0].y,t[1].y),Math.max(t[2].y,t[3].y));if(e<i||e>s)return[];let o=t[0].y,r=t[1].y,n=t[2].y,l=t[3].y,a=3*(r-o),h=3*(n-r)-a,d=l-o-a-h,c=o-e;const u=Array(4);let g;g=Bt(d)?se(h,a,c,u):se(h/d,a/d,c/d,u);const f=Array();for(let e=0;e<g;++e)u[e]>=0&&u[e]<=1&&f.push({x:oe(t,u[e]),dy:re(t,u[e])});return f}(t,e.y))e.x<o.x&&(++i,s=o.dy);return 1==(1&i)?s:0}(i,e);return s>0?++t:s<0&&--t,t}function ue(t,e,i){return(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y)}class ge extends class{translate(t,e){return"object"==typeof t?this.transform(new Rt({a:1,b:0,c:0,d:1,e:t.x,f:t.y})):this.transform(new Rt({a:1,b:0,c:0,d:1,e:t,f:e})),this}}{constructor(t){if(super(),this.data=[],t instanceof Array){this.data.push({type:"M",values:[t[0].x,t[0].y]});for(let e=1;e<t.length;++e)this.data.push({type:"L",values:[t[e].x,t[e].y]});this.data.push({type:"Z",values:void 0})}else if(t instanceof ge)for(let e of t.data)switch(e.type){case"M":this.data.push({type:"M",values:[e.values[0],e.values[1]]});break;case"L":this.data.push({type:"L",values:[e.values[0],e.values[1]]});break;case"C":this.data.push({type:"C",values:[e.values[0],e.values[1],e.values[2],e.values[3],e.values[4],e.values[5]]});break;case"Z":this.data.push({type:"Z",values:void 0})}}clone(){return new ge(this)}toString(){let t="";for(let e of this.data)switch(e.type){case"M":t+=`M ${e.values[0]} ${e.values[1]} `;break;case"L":t+=`L ${e.values[0]} ${e.values[1]} `;break;case"C":t+=`C ${e.values[0]} ${e.values[1]} ${e.values[2]} ${e.values[3]} ${e.values[4]} ${e.values[5]} `;break;case"Z":t+="Z "}return t.substring(0,t.length-1)}clear(){return this.data=[],this}empty(){return 0==this.data.length}contains(t){return function(t,e){let i,s,o=0;for(let r of t.data)switch(r.type){case"M":s=i={x:r.values[0],y:r.values[1]};break;case"L":{const t=[i,{x:r.values[0],y:r.values[1]}];o=de(o,e,t),i=t[1]}break;case"C":{if(void 0===i)throw Error("yikes");let t=[i,{x:r.values[0],y:r.values[1]},{x:r.values[2],y:r.values[3]},{x:r.values[4],y:r.values[5]}];o=ce(o,e,t),i=t[3]}break;case"Z":o=de(o,e,[i,s]),i=s}i!==s&&(o=de(o,e,[i,s]));return 1==(1&o)}(this,t)}distance(t){let e,i,s,o=Number.MAX_VALUE;for(let r of this.data)switch(r.type){case"M":e=s={x:r.values[0],y:r.values[1]};break;case"L":i=s,s={x:r.values[0],y:r.values[1]},o=Math.min(Ut(t,i,s),o);break;case"C":i=s,s={x:r.values[4],y:r.values[5]};const n=Zt(t.x,t.y,i.x,i.y,r.values[0],r.values[1],r.values[2],r.values[3],s.x,s.y);o=Math.min(n.distance,o);break;case"Z":o=Math.min(Ut(t,e,s),o),s=e}return o}transform(t){for(let e of this.data)switch(e.type){case"M":case"L":e.values=t.transformArrayPoint(e.values);break;case"C":{let i=t.transformArrayPoint([e.values[0],e.values[1]]);e.values[0]=i[0],e.values[1]=i[1],i=t.transformArrayPoint([e.values[2],e.values[3]]),e.values[2]=i[0],e.values[3]=i[1],i=t.transformArrayPoint([e.values[4],e.values[5]]),e.values[4]=i[0],e.values[5]=i[1]}}return this}move(t,e){return"object"==typeof t?this.data.push({type:"M",values:[t.x,t.y]}):this.data.push({type:"M",values:[t,e]}),this}line(t,e){return"object"==typeof t?this.data.push({type:"L",values:[t.x,t.y]}):this.data.push({type:"L",values:[t,e]}),this}curve(t,e,i,s,o,r){if("object"==typeof t&&"object"==typeof e&&"object"==typeof i)this.data.push({type:"C",values:[t.x,t.y,e.x,e.y,i.x,i.y]});else{if("number"!=typeof t||"number"!=typeof e||"number"!=typeof i)throw Error(`yikes: curve(${t}, ${e},${i}, ${s}, ${o}, ${r})`);this.data.push({type:"C",values:[t,e,i,s,o,r]})}return this}close(){return this.data.push({type:"Z",values:void 0}),this}appendRect(t){return this.move(t.origin),this.line(t.origin.x+t.size.width,t.origin.y),this.line(t.origin.x+t.size.width,t.origin.y+t.size.height),this.line(t.origin.x,t.origin.y+t.size.height),this.close(),this}appendCircle(t){let e=.552284749831,i=.5*t.size.width,s=.5*t.size.height,o=t.origin.x+i,r=t.origin.y+s;return this.move({x:o,y:r-s}),this.curve({x:o+i*e,y:r-s},{x:o+i,y:r-s*e},{x:o+i,y:r}),this.curve({x:o+i,y:r+s*e},{x:o+i*e,y:r+s},{x:o,y:r+s}),this.curve({x:o-i*e,y:r+s},{x:o-i,y:r+s*e},{x:o-i,y:r}),this.curve({x:o-i,y:r-s*e},{x:o-i*e,y:r-s},{x:o,y:r-s}),this.close(),this}bounds(){let t,e=new jt;for(let i of this.data)switch(i.type){case"M":t={x:i.values[0],y:i.values[1]},e.origin.x=i.values[0],e.origin.y=i.values[1];break;case"L":t={x:i.values[0],y:i.values[1]},e.expandByPoint(t);break;case"C":{const s={x:i.values[4],y:i.values[5]},o=ie([t,{x:i.values[0],y:i.values[1]},{x:i.values[2],y:i.values[3]},s]);e.expandByPoint(o.origin),e.expandByPoint(Nt(o.origin,o.size)),t=s}}return e}createSVG(t="#000",e=1,i="none"){let s=document.createElementNS("http://www.w3.org/2000/svg","path");return s.setAttributeNS("","d",this.toString()),s.setAttributeNS("","stroke-width",String(e)),s.setAttributeNS("","stroke",t),s.setAttributeNS("","fill",i),s}updateSVG(t,e){return e||(e=document.createElementNS("http://www.w3.org/2000/svg","path")),e.setAttributeNS("","d",this.toString()),e}}class fe extends Kt{constructor(t){super(t),b.initRectangle(this,t)}distance(t){return this.origin.x<=t.x&&t.x<this.origin.x+this.size.width&&this.origin.y<=t.y&&t.y<this.origin.y+this.size.height?-1:Number.MAX_VALUE}getPath(){let t=new ge;return t.appendRect(this),t}updateSVG(t,e,i){return i||(i=document.createElementNS("http://www.w3.org/2000/svg","path")),i.setAttributeNS("","d",t.toString()),i.setAttributeNS("","stroke-width",String(this.strokeWidth)),i.setAttributeNS("","stroke",this.stroke),i.setAttributeNS("","fill",this.fill),i}}class pe extends Kt{constructor(t){super(t),b.initCircle(this,t)}distance(t){let e=.5*this.size.width,i=.5*this.size.height,s=this.origin.x+e,o=this.origin.y+i,r=t.x-s,n=t.y-o,l=Math.atan(n*e/(r*i));r<0&&(l+=Math.PI);let a=e*Math.cos(l),h=i*Math.sin(l);if("none"!==this.fill){let t=Math.sqrt(r*r+n*n)-Math.sqrt(a*a+h*h);return t<0?-1:t}return r-=a,n-=h,Math.sqrt(r*r+n*n)}getPath(){let t=new ge;return t.appendCircle(this),t}updateSVG(t,e,i){return i||(i=document.createElementNS("http://www.w3.org/2000/svg","path")),i.setAttributeNS("","d",t.toString()),i.setAttributeNS("","stroke-width",String(this.strokeWidth)),i.setAttributeNS("","stroke",this.stroke),i.setAttributeNS("","fill",this.fill),i}}class me{constructor(t){this.array=new Array,this.order=t}insert(t){let e=0,i=this.array.length,s=Math.floor((i+e)/2);for(;e<i;){if(this.order(t,this.array[s]))i=s-1;else{if(!this.order(this.array[s],t))return;e=s+1}s=Math.floor((i+e)/2)}s>=this.array.length?this.array.push(t):s<0?this.array.splice(0,0,t):this.order(t,this.array[s])?this.array.splice(s,0,t):this.array.splice(s+1,0,t)}at(t){return this.array[t]}shift(){if(0==this.array.length)throw Error("OrderedArray.shift(): empty, can not shift");return this.array.shift()}get length(){return this.array.length}set length(t){this.array.length=t}empty(){return 0===this.array.length}}class ye{constructor(t,e){if(void 0===e){let e=t;this.type=e.type,this.p=new Array;for(let t of e.p)this.p.push(t)}else this.type="L",this.p=new Array,this.p.push(t),this.p.push(e)}static less(t,e){return t.p[0].y<e.p[0].y||!(e.p[0].y<t.p[0].y)&&(t.p[0].x!==e.p[0].x?t.p[0].x<e.p[0].x:(i=t.p[0],s=t.p[1],o=e.p[1],(i.x-o.x)*(s.y-o.y)-(s.x-o.x)*(i.y-o.y)<0));var i,s,o}toString(){let t=`(${this.type}, [`;return this.p.forEach((e=>t+=`(${e.x},${e.y}), `)),t+="])",t}}class ve{constructor(){this.left=new Array,this.right=new Array}}function we(t,e=!0){if(e){console.log("slices = [");for(let e of t){console.log("    Slice {"),console.log("        left = [");for(let t of e.left)console.log("            ",t.p[0]),console.log("            ",t.p[1]),Vt(t.p[0],t.p[1])&&console.log("            EVENT IS A SINGULARITY *********************************************************");console.log("        ]"),console.log("        right = [");for(let t of e.right)console.log("            ",t.p[0]),console.log("            ",t.p[1]),Vt(t.p[0],t.p[1])&&console.log("            EVENT IS A SINGULARITY *********************************************************");console.log("        ]"),console.log("    }")}console.log("]")}else for(let e=0;e<t.length;++e){let i=t[e];console.log(`-------------------------- slice ${e}: leftTop=${i.left[0].p[0].x}, ${i.left[0].p[0].y}, rightTop=${i.right[0].p[0].x}, ${i.right[0].p[0].y}  --------------------------`);for(let t=0;t<i.left.length;++t)console.log(`left[${t}]  : ${i.left[t].p[0].x}, ${i.left[t].p[0].y} -> ${i.left[t].p[1].x}, ${i.left[t].p[1].y}`);for(let t=0;t<i.right.length;++t)console.log(`right[${t}]: ${i.right[t].p[0].x}, ${i.right[t].p[0].y} -> ${i.right[t].p[1].x}, ${i.right[t].p[1].y}`)}}class Ee{constructor(){this.topLeftEvent=-1,this.bottomLeftEvent=-1,this.topRightEvent=-1,this.bottomRightEvent=-1}hasLeftAndRightCorners(){return!(-1==this.topLeftEvent&&-1==this.bottomLeftEvent||-1==this.topRightEvent&&-1==this.bottomRightEvent)}}function be(t,e,i=!1){i&&(console.log("WITHINSLICES ------------------------"),console.log(t),console.log(e));let s=t.origin.y,o=s+t.size.height,r=t.origin.x,n=r+t.size.width;for(let t=0;t<e.length;++t){let r=e[t];if(s<r.left[0].p[0].y)return i&&console.log("WITHINSLICES => FALSE (1)"),!1;if(o>r.left[r.left.length-1].p[1].y)return i&&console.log("WITHINSLICES => FALSE (2)"),!1;if(s<r.right[0].p[0].y)return i&&console.log("WITHINSLICES => FALSE (3)"),!1;if(o>r.right[r.right.length-1].p[1].y)return i&&console.log("WITHINSLICES => FALSE (4)"),!1}for(let l=0;l<e.length;++l){let a=e[l],h=!0,d=!0;for(let e=0;e<a.left.length;++e)if(!(a.left[e].p[1].y<s)){if(o<a.left[e].p[0].y)break;if(n<a.left[e].p[0].x&&n<a.left[e].p[1].x){h=!1;break}if(!(a.left[e].p[0].x<=r&&a.left[e].p[1].x<=r)){if(t.contains(a.left[e].p[0])||t.contains(a.left[e].p[1]))return i&&console.log("WITHINSLICES => FALSE (5)"),!1;if(zt(a.left[e].p,t)){i&&(console.log("WITHINSLICES: LEFT CROSSES RECT"),console.log(t),console.log(a.left[e].p)),h=!1;break}}}if(h){for(let e=0;e<a.right.length;++e)if(!(a.right[e].p[1].y<s)){if(o<a.right[e].p[0].y)break;if(a.right[e].p[0].x<r&&a.right[e].p[1].x<r){d=!1;break}if(!(n<=a.right[e].p[0].x&&n<=a.right[e].p[1].x)){if(t.contains(a.right[e].p[0])||t.contains(a.right[e].p[1]))return i&&console.log("WITHINSLICES => FALSE (6)"),!1;if(zt(a.right[e].p,t)){i&&console.log("WITHINSLICES: RIGHT LINE CROSSES RECT"),d=!1;break}}}if(d)return i&&(console.log(t),console.log(e),console.log("WITHINSLICES => TRUE")),!0}else i&&console.log("WITHINSLICES: leftOfBoxIsInside")}return i&&console.log("WITHINSLICES => FALSE (7)"),!1}class Ae{constructor(t,e,i){this.trace=1==i,this.sweepBuffer=new me(((t,e)=>ye.less(t,e))),this.initializeSweepBufferFrom(t),void 0!==e&&this.placeWordBoxes(e)}initializeSweepBufferFrom(t){let e,i,s;this.bounds=t.bounds(),this.sweepBuffer.length=0;for(let o of t.data)switch(o.type){case"M":e=i=new Tt(o.values[0],o.values[1]);break;case"L":s=new Tt(o.values[0],o.values[1]),this.addSweepLine(i,s),i=s;break;case"C":break;case"Z":this.addSweepLine(i,e)}}addSweepLine(t,e){if(Bt(t.y-e.y))return;(t.y>e.y||t.y===e.y&&t.x>e.x)&&([t,e]=[e,t]);let i=new ye(t,e);this.sweepBuffer.insert(i)}placeWordBoxes(t){this.trace&&console.log("WordWrap.placeWordBoxes(): ENTER");let e=[];t.reset();let i=t.pullBox();if(void 0===i)return void console.log("WordWrap.placeWordBoxes(): NO BOXES");let[s,o]=this.pointForBoxInSlices(i,e);if(o=new Tt(o),-1===s)return void(this.trace&&console.log("WordWrap.placeWordBoxes(): NOT EVEN A FIRST SLICE"));let r=this.findCornersAtCursorForBoxAtSlice(o,i,e[s]),[n,l]=this.leftAndRightForAtCursorForBox(o,i,e,s,r),a=l-n;for(this.trace&&(console.log(`WordWrap.placeWordBoxes(): ENTER LOOP, HORIZONTAL SPACE IS ${a}`),this.printSlices(e));i;)if((h=i.width)<(d=a)||Math.abs(h-d)<Pt)t.placeBox(o),o.x+=i.width+t.space,a-=i.width+t.space,i=t.pullBox(),this.trace&&(console.log(`WordWrap.placeWordBoxes(): PLACED BOX, REDUCED HORIZONTAL SPACE TO ${a}`),this.printSlices(e));else if(t.endOfSlice(),++s,s<e.length){this.trace&&console.log(`WordWrap.placeWordBoxes(): NOT ENOUGH HORIZONTAL SPACE FOR ${i.width}, MOVE TO SLICE ${s}`);let t=this.findCornersAtCursorForBoxAtSlice(o,i,e[s]),[r,n]=this.leftAndRightForAtCursorForBox(o,i,e,s,t);a=n-r,o.x=r}else if(this.trace&&(console.log(`WordWrap.placeWordBoxes(): NOT ENOUGH HORIZONTAL SPACE FOR ${i.width}, LAST SLICE, NEW LINE`),this.printSlices(e)),t.endOfLine(),s=-1,a=0,o.y+=i.height,this.extendSlices(o,i,e),o.y+i.height>this.bounds.origin.y+this.bounds.size.height)break;var h,d;t.endOfWrap(),this.trace&&console.log("WordWrap.placeWordBoxes(): LEAVE")}printSlices(t){we(t)}validateSlices(t){!function(t){for(let e=0;e<t.length;++e){let i=t[e];for(let s=0;s<i.left.length;++s)if(i.left[s].p[0].y>i.left[s].p[1].y)throw console.log(`!!!!! slice ${e}, left ${s}: edge doesn't point down`),we(t,!0),Error();for(let t=0;t<i.right.length;++t)if(i.right[t].p[0].y>i.right[t].p[1].y)throw console.log(`!!!!! slice ${e}, right ${t}: edge doesn't point down`),Error();let s=0,o=0;for(;s<i.left.length&&i.left[s].p[0].y<i.right[o].p[0].y;)++s;for(;o<i.right.length&&i.left[s].p[0].y>i.right[o].p[0].y;)++o;for(;s<i.left.length&&o<i.right.length&&i.left[s].p[0].y==i.right[o].p[0].y&&i.left[s].p[1].y==i.right[o].p[1].y;)++s,++o;s<i.left.length&&i.right.length}}(t)}pointForBoxInSlices(t,e){this.trace&&console.log("======================== WordWrap.pointForBoxInSlices ========================");let i=new Tt(this.bounds.origin);for(;this.trace&&console.log(`-------------------------- extend & level slices to accomodate ${i.y} to ${i.y+t.height} -----------------------------------------`),this.extendSlices(i,t,e),0!==e.length;){let s=new jt(i,t);for(let o=0;o<e.length;++o){let r=e[o];for(let n=0;n<r.left.length;++n)for(let l=0;l<r.right.length;++l){this.trace&&console.log("CHECK ",o,n,l,r.left[n],r.right[l]);let a=this.pointForBoxInCornerCore(t,r.left[n],r.right[l]);if(void 0!==a&&(s.origin=a,be(s,e,this.trace)))return this.trace&&console.log("pointForBoxInSlices => point (1)"),[o,s.origin];if(a=this.pointForBoxAtTop(t,r.left[n],r.right[l]),void 0!==a&&(s.origin=a,be(s,e,this.trace)))return this.trace&&console.log("pointForBoxInSlices => point (2)"),[o,s.origin];if(a=this.pointForBoxAtEdge(t,r.left[n],r.right[l]),void 0!==a&&(this.extendSlices(a,t,e),s.origin=a,be(s,e)))return this.trace&&console.log("pointForBoxInSlices => point (3)"),[o,s.origin];this.trace&&console.log(`pointForBoxInSlices point ${i.x}, ${i.y} not within slices (4)`)}}i.y+=t.height}return this.trace&&console.log("pointForBoxInSlices => undefined (5)"),[-1,i]}pointForBoxAtTop(t,e,i){if(this.trace&&console.log(`WordWrap.pointForBoxInCorner(box: (${t.width}, ${t.height}), left: ${e}, right: ${i})`),e.p[0].y!==i.p[0].y)return;let s=e.p[0],o=It(e.p[1],s),r=i.p[0];if(i.p[0].x-e.p[0].x<t.width)return;if(o.x<=0)return this.trace&&console.log("[2] return ",e.p[0]),e.p[0];let n=[new Tt(this.bounds.origin.x-10,e.p[0].y+t.height),new Tt(this.bounds.origin.x+this.bounds.size.width+10,e.p[0].y+t.height)],l=ae(e.p,n);if(void 0===l)return void console.log(`pointForBoxAtTop(): failed to find leftPoint2 between left event and bottom line at y=${n[0].y}`);if(l.y=e.p[0].y,l.x+t.width>r.x)return void(this.trace&&console.log("NOPE"));let a=ae(i.p,n);if(!(a&&a.x-t.width<l.x))return this.trace&&console.log("[1] return ",l),l;this.trace&&console.log("[0] return undefined")}pointForBoxInCornerCore(t,e,i){this.trace&&console.log("WordWrap.pointForBoxInCornerCore");let s=e.p[0],o=It(e.p[1],s),r=i.p[0],n=It(i.p[1],r),l=i.p[0].x-e.p[0].x,a=i.p[1].x-e.p[1].x;if(!(l<t.width&&a<t.width)){if(this.trace&&console.log("left and right vector:",o,n),o.x>0&&n.x>0){let l=new Tt(t.width,-t.height),a=o.y/o.x,h=Ot(r,Dt(n,(s.y+a*(r.x-s.x-l.x)+l.y-r.y)/(n.y-a*n.x)));return h.x-=t.width,this.trace&&(console.log("[4] return ",h),console.log("p    :",h),console.log("left :",e.p),console.log("right:",i.p)),h}if(o.x<0&&n.x<0){let e=new Tt(t.width,t.height),i=o.y/o.x,l=Ot(r,Dt(n,(s.y+i*(r.x-s.x-e.x)+e.y-r.y)/(n.y-i*n.x)));return l.x-=t.width,l.y-=t.height,this.trace&&console.log("[5] return ",l),l}if(l<a){let s=[new Tt(i.p[0].x-t.width,i.p[0].y),new Tt(i.p[1].x-t.width,i.p[1].y)],o=ae(e.p,s);if(void 0!==o)return this.trace&&console.log("[7] return ",o),o}if(o.x<=0&&n.x>=0&&Bt(i.p[0].y-e.p[0].y)&&i.p[0].x-e.p[0].x>=t.width)return this.trace&&console.log("[8] return ",e.p[0]),e.p[0];this.trace&&console.log("[9] return undefined")}}pointForBoxAtEdge(t,e,i){let s=Math.max(e.p[1].y,i.p[1].y)+10,o=[new Tt(e.p[1].x,e.p[0].y),new Tt(e.p[1].x,s)],r=ae(o,i.p);if(void 0===r)return;let n=new ye(r,o[1]),l=new ye(r,i.p[1]);return this.pointForBoxInCornerCore(t,n,l)}extendSlices(t,e,i){t.y;let s=t.y+e.height;for(;!this.sweepBuffer.empty()&&this.sweepBuffer.at(0).p[0].y<=s;){this.validateSlices(i),this.levelSlicesHorizontally(i),this.validateSlices(i),this.mergeAndDropSlices(t,e,i);let s=this.sweepBuffer.shift();this.validateSlices(i),this.appendEventToSlices(i,s)?this.validateSlices(i):(this.appendEventAsNewSlice(i,s,this.trace),this.validateSlices(i))}this.validateSlices(i),this.levelSlicesHorizontally(i),this.validateSlices(i),this.mergeAndDropSlices(t,e,i),this.validateSlices(i),this.dropEventsInSlices(t,e,i),this.validateSlices(i)}appendEventToSlices(t,e){for(let i of t){if(0==i.left.length&&console.log("Upsi, left slice is empty"),0==i.right.length&&console.log("Upsi, right slice is empty"),Vt(i.left[i.left.length-1].p[1],e.p[0]))return i.left.push(e),!0;if(Vt(i.right[i.right.length-1].p[1],e.p[0]))return i.right.push(e),!0}return!1}appendEventAsNewSlice(t,e,i=!1){!function(t,e,i,s,o=!1){let r=e.p[0].y,n=[new Tt(s.origin.x-10,r),new Tt(s.origin.x+s.size.width+10,r)],l=new Array,a=new Array,h=!0;for(let s=0;s<t.length;++s){l.length=a.length=0,o&&console.log("check for intersections with the slice's left");for(let e=0;e<t[s].left.length;++e)t[s].left[e].p[0].y<=r&&r<=t[s].left[e].p[1].y&&he(l,n,t[s].left[e].p);if(e.p[0].x<l[0].seg0.pt.x){o&&console.log("new segment is outside the slide on the left");let r=new ve;if(r.left.push(e),0===i.length)throw Error("yikes");r.right.push(i.shift()),t.splice(s,0,r),h=!1;break}o&&console.log("check for intersections with the slice's right");for(let e=0;e<t[s].right.length;++e)t[s].right[e].p[0].y<=r&&r<=t[s].right[e].p[1].y&&he(a,n,t[s].right[e].p);if(e.p[0].x<a[0].seg0.pt.x){o&&(console.log("new segment is inside the slice"),console.log(e));let n=new ve,d=n.left;n.left=t[s].left;for(let e=0;e<t[s].right.length&&t[s].right[e].p[0].y<r;++e)n.right.push(new ye(t[s].right[e]));n.right[t[s].right.length-1].p[1]=a[0].seg0.pt,n.right[t[s].right.length-1],Vt(n.right[t[s].right.length-1].p[0],n.right[t[s].right.length-1].p[1])&&n.right.pop(),n.right.push(e),t[s].left=d;for(let e=0;e<n.left.length&&n.left[e].p[0].y<r;++e)t[s].left.push(new ye(n.left[e]));t[s].left[t[s].left.length-1].p[1]=l[0].seg0.pt,t[s].left[t[s].left.length-1],Vt(t[s].left[t[s].left.length-1].p[0],t[s].left[t[s].left.length-1].p[1])&&t[s].left.pop(),t[s].left.push(i.shift()),t.splice(s,0,n),h=!1;break}}if(h){let s=new ve;s.left.push(e),s.right.push(i.shift()),t.push(s)}}(t,e,this.sweepBuffer,this.bounds,i)}levelSlicesHorizontally(t){for(let e of t)for(let t=0;t<e.left.length&&!(t>=e.left.length||t>=e.right.length);++t)if(e.left[t].p[1].y>e.right[t].p[1].y){let i=ae([new Tt(this.bounds.origin.x-10,e.right[t].p[1].y),new Tt(this.bounds.origin.x+this.bounds.size.width+10,e.right[t].p[1].y)],e.left[t].p);if(void 0===i)throw console.log(e.right[t].p[1].y),console.log(e.left[t].p),Error("yikes");if(!Vt(e.left[t].p[0],i)){let s=new ye(e.left[t].p[0],i);e.left[t].p[0]=i,e.left.splice(t,0,s)}}else if(e.left[t].p[1].y<e.right[t].p[1].y){let i=ae(e.right[t].p,[new Tt(this.bounds.origin.x-10,e.left[t].p[1].y),new Tt(this.bounds.origin.x+this.bounds.size.width+10,e.left[t].p[1].y)]);if(void 0===i)throw console.log(e.right[t]),console.log(e.left[t].p[1].y),Error("failed to split right event on left event");if(!Vt(e.right[t].p[0],i)){let s=new ye(e.right[t].p[0],i);e.right[t].p[0]=i,e.right.splice(t,0,s)}}}dropEventsInSlices(t,e,i){for(let e of i){for(;e.left.length>0&&e.left[0].p[1].y<t.y;)e.left.shift();for(;e.right.length>0&&e.right[0].p[1].y<t.y;)e.right.shift()}}mergeAndDropSlices(t,e,i){for(let e=0;e<i.length;)(0===i[e].left.length||i[e].left[i[e].left.length-1].p[1].y<t.y)&&(0===i[e].right.length||i[e].right[i[e].right.length-1].p[1].y<t.y)?i.splice(e,1):i.length>=2&&(0===i[e].right.length||i[e].right[i[e].right.length-1].p[1].y<t.y)&&(0===i[e+1].left.length||i[e+1].left[i[e+1].left.length-1].p[1].y<t.y)?(i[e].right=i[e+1].right,i.splice(e+1,1)):++e}leftAndRightForAtCursorForBox(t,e,i,s,o){let r,n,l,a,h,d,c=t.y,u=t.y+e.height,g=[new Tt(this.bounds.origin.x-10,c),new Tt(this.bounds.origin.x+this.bounds.size.width+10,c)],f=[new Tt(this.bounds.origin.x-10,u),new Tt(this.bounds.origin.x+this.bounds.size.width+10,u)];if(-1!==o.topLeftEvent){let t=new Array;if(he(t,i[s].left[o.topLeftEvent].p,g),1!==t.length)throw Error("yikes");r=t[0].seg0.pt.x}if(-1!==o.topRightEvent){let t=new Array;if(he(t,i[s].right[o.topRightEvent].p,g),1!==t.length)throw Error("yikes");n=t[0].seg0.pt.x}if(-1!==o.bottomLeftEvent){let t=new Array;if(he(t,i[s].left[o.bottomLeftEvent].p,f),1!==t.length)throw Error("yikes");l=t[0].seg0.pt.x}if(-1!==o.bottomRightEvent){let t=new Array;if(he(t,i[s].right[o.bottomRightEvent].p,f),1!==t.length)throw Error("yikes");a=t[0].seg0.pt.x}return h=void 0===r?l:null==l?r:Math.max(r,l),d=void 0===n?a:void 0===a?n:Math.min(n,a),[h,d]}findCornersAtCursorForBoxAtSlice(t,e,i){let s=t.y,o=t.y+e.height,r=new Ee;for(let t=0;t<i.left.length;++t)if(i.left[t].p[0].y<=s&&s<=i.left[t].p[1].y&&(r.topLeftEvent=t),i.left[t].p[0].y<=o&&o<=i.left[t].p[1].y){r.bottomLeftEvent=t;break}for(let t=0;t<i.right.length;++t)if(i.right[t].p[0].y<=s&&s<=i.right[t].p[1].y&&(r.topRightEvent=t),i.right[t].p[0].y<=o&&o<=i.right[t].p[1].y){r.bottomRightEvent=t;break}return r}}class xe extends jt{constructor(t,e,i){super(0,0,t,e),this.ascent=0,this.word=i,this.endOfLine=!1,this.endOfSlice=!1,this.endOfWrap=!1}reset(){this.endOfLine=!1,this.endOfSlice=!1,this.endOfWrap=!1}}class Ce{constructor(t){this.wordBoxes=[],this.current=0,this.space=0,this.height=0,null==t&&(t="Lorem ipsum dolor sit amet, consectetur adipisici elit, sed eiusmod tempor incidunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquid ex ea commodi consequat. Quis aute iure reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint obcaecat cupiditat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."),Ce.splitTextIntoWordBoxes(this.wordBoxes,t)}toString(){let t="";for(const e of this.wordBoxes)0!=t.length&&(t+=" "),t+=e.word;return t}static splitTextIntoWordBoxes(t,e){let i="";for(let s of e)switch(s){case" ":case"\t":case"\r":case"\n":case"\v":let e=new xe(8*i.length,16,i);t.push(e),i="";break;default:i+=s}if(i.length>0){let e=new xe(8*i.length,16,i);t.push(e)}if(0===t.length){let e=new xe(0,16,"");t.push(e)}}reset(){this.current=0;for(let t of this.wordBoxes)t.reset()}initializeWordBoxes(t){this.parentSVG=t;let e=document.createElementNS("http://www.w3.org/2000/svg","text");e.setAttributeNS("","font-family","sans-serif"),e.setAttributeNS("","font-size","12px"),e.innerHTML="&nbsp;",t.appendChild(e),this.space=e.getComputedTextLength(),t.removeChild(e);let i=document.createElementNS("http://www.w3.org/2000/svg","text");i.innerHTML="X",t.appendChild(i),this.height=i.getBBox().height,t.removeChild(i)}pullBox(){if(this.current>=this.wordBoxes.length)return;const t=this.wordBoxes[this.current];if(void 0===t.svg){let e=document.createElementNS("http://www.w3.org/2000/svg","text");e.style.cursor="inherit",e.setAttributeNS("","font-family","sans-serif"),e.setAttributeNS("","font-size","12px"),e.setAttributeNS("","stroke","none"),e.setAttributeNS("","fill","none"),e.setAttributeNS("","x","0"),e.setAttributeNS("","y","0"),e.textContent=t.word,t.svg=e,this.parentSVG.appendChild(e)}const e=Number.parseFloat(t.svg.getAttributeNS("","y"));let i=t.svg.getBBox();if(t.ascent=e-i.y,t.ascent=e-i.y,0!==t.word.length){t.size.width=t.svg.getComputedTextLength();let e=t.svg.getBBox();t.size.height=e.height}else t.size.width=0,t.size.height=this.height;return t.size}displayWordBoxes(){this.updateSVG()}updateSVG(){var t;let e=!0;for(let i of this.wordBoxes)e?void 0===i.svg?console.log("TextSource: word within visible area has no SVG element"):(i.svg.setAttributeNS("","x",`${i.origin.x}`),i.svg.setAttributeNS("","y",`${i.origin.y+i.ascent}`),i.svg.setAttributeNS("","fill","#000")):i.svg&&(null===(t=i.svg.parentElement)||void 0===t||t.removeChild(i.svg),i.svg=void 0),i.endOfWrap&&(e=!1)}placeBox(t){Object.assign(this.wordBoxes[this.current].origin,t),++this.current}endOfSlice(){this.wordBoxes[this.current-1].endOfSlice=!0}endOfLine(){this.wordBoxes[this.current-1].endOfLine=!0}endOfWrap(){this.wordBoxes[this.current-1].endOfWrap=!0}}class Se extends Kt{constructor(t){super(t),this.stroke="none",this.fill="#000",b.initText(this,t)}get text(){return this.textSource.toString()}set text(t){this.textSource=new Ce(t)}distance(t){return this.origin.x<=t.x&&t.x<this.origin.x+this.size.width&&this.origin.y<=t.y&&t.y<this.origin.y+this.size.height?-1:Number.MAX_VALUE}getPath(){let t=new ge;return t.appendRect(this),t}updateSVG(t,e,i){if(i){this.textSource.reset(),this.textSource.initializeWordBoxes(i),new Ae(t).placeWordBoxes(this.textSource),this.textSource.updateSVG()}else{(i=document.createElementNS("http://www.w3.org/2000/svg","g")).style.cursor="inherit",e.appendChild(i),this.textSource.initializeWordBoxes(i),new Ae(t).placeWordBoxes(this.textSource),this.textSource.updateSVG(),e.removeChild(i)}return i}}class Te extends Yt{constructor(t){super(t),b.initGroup(this,t)}add(t){this.childFigures.push(t)}transform(t){return!1}distance(t){throw Error("not yet implemented")}bounds(){throw Error("not yet implemented")}getHandlePosition(t){}setHandlePosition(t,e){}getPath(){throw Error("nope")}}class _e extends Te{constructor(t){super(t),b.initTransform(this,t)}add(t){this.childFigures.push(t)}transform(t){return this.matrix.prepend(t),!0}appendMatrix(t){return this.matrix.append(t),!0}prependMatrix(t){return this.matrix.prepend(t),!0}distance(t){let e=new Rt(this.matrix);return e.invert(),t=e.transformPoint(t),this.childFigures[0].distance(t)}bounds(){let t=new ge;return t.appendRect(this.childFigures[0].bounds()),t.transform(this.matrix),t.bounds()}getHandlePosition(t){}setHandlePosition(t,e){}getPath(){let t=super.getPath();return t.transform(this.matrix),t}}var Re;!function(t){var e;(e=t.AnchorType||(t.AnchorType={}))[e.ANCHOR_EDGE=0]="ANCHOR_EDGE",e[e.ANCHOR_EDGE_ANGLE=1]="ANCHOR_EDGE_ANGLE",e[e.ANCHOR_ANGLE_EDGE=2]="ANCHOR_ANGLE_EDGE",e[e.ANCHOR_SYMMETRIC=3]="ANCHOR_SYMMETRIC",e[e.ANCHOR_SMOOTH_ANGLE_ANGLE=4]="ANCHOR_SMOOTH_ANGLE_ANGLE",e[e.ANCHOR_ANGLE_ANGLE=5]="ANCHOR_ANGLE_ANGLE",e[e.CLOSE=6]="CLOSE"}(Re||(Re={}));class Ne extends qt{constructor(t){t instanceof ge?(super(),b.initPath(this)):(super(t),b.initPath(this,t))}addEdge(t){this.types.push(Re.AnchorType.ANCHOR_EDGE),this.values.push(t.x),this.values.push(t.y)}changeEdgeToSymmetric(t){if(0===this.types.length)throw Error("figure.Path.changeEdgeToSymmetric(): figure is empty");if(this.types[this.types.length-1]!==Re.AnchorType.ANCHOR_EDGE)throw Error("figure.Path.changeEdgeToSymmetric(): last anchor is not an edge");this.types[this.types.length-1]=Re.AnchorType.ANCHOR_SYMMETRIC;const e=this.values[this.values.length-2],i=this.values[this.values.length-1];this.values[this.values.length-2]=t.x,this.values[this.values.length-1]=t.y,this.values.push(e),this.values.push(i)}changeSymmetricToSmoothAngleAngle(t){if(0===this.types.length)throw Error("figure.Path.changeSymmetricToSmoothAngleAngle(): figure is empty");if(this.types[this.types.length-1]!==Re.AnchorType.ANCHOR_SYMMETRIC)throw Error("figure.Path.changeSymmetricToSmoothAngleAngle(): last anchor is not symmetric");this.types[this.types.length-1]=Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE,this.values.push(t.x),this.values.push(t.y)}changeEdgeToSmoothAngleAngle(t,e){if(0===this.types.length)throw Error("figure.Path.changeEdgeToSmoothAngleAngle(): figure is empty");if(this.types[this.types.length-1]!==Re.AnchorType.ANCHOR_EDGE)throw Error("figure.Path.changeEdgeToSmoothAngleAngle(): last anchor is not an edge");this.types[this.types.length-1]=Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE;const i={x:this.values[this.values.length-2],y:this.values[this.values.length-1]};this.values[this.values.length-2]=t.x,this.values[this.values.length-1]=t.y,this.values.push(i.x),this.values.push(i.y),this.values.push(e.x),this.values.push(e.y)}changeSmoothAngleAngleToSymmetric(){if(0===this.types.length)throw Error("figure.Path.changeSmoothAngleAngleToSymmetric(): figure is empty");if(this.types[this.types.length-1]!==Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE)throw Error(`figure.Path.changeSmoothAngleAngleToSymmetric(): unexpected last anchor type ${Re.AnchorType[this.types[this.types.length-1]]}`);this.types[this.types.length-1]=Re.AnchorType.ANCHOR_SYMMETRIC;const t=kt({x:this.values[this.values.length-4],y:this.values[this.values.length-3]},{x:this.values[this.values.length-2],y:this.values[this.values.length-1]});this.values[this.values.length-4]=t.x,this.values[this.values.length-3]=t.y,this.values.length-=2}updateSymmetric(t){if(0===this.types.length)throw Error("figure.Path.updateSymmetric(): figure is empty");if(this.types[this.types.length-1]!==Re.AnchorType.ANCHOR_SYMMETRIC)throw Error("figure.Path.updateSymmetric(): last anchor is not symmetric");this.values[this.values.length-4]=t.x,this.values[this.values.length-3]=t.y}updateAngleEdge(t,e){if(0===this.types.length)throw Error("figure.Path.updateAngleEdge(): figure is empty");if(this.types[0]!==Re.AnchorType.ANCHOR_ANGLE_EDGE)throw Error("figure.Path.updateAngleEdge(): last anchor is not symmetric");this.values[0]=e.x,this.values[1]=e.y}changeEdgeToEdgeAngle(t){if(0===this.types.length)throw Error("figure.Path.changeEdgeToEdgeAngle(): figure is empty");if(this.types[this.types.length-1]!==Re.AnchorType.ANCHOR_EDGE)throw Error("figure.Path.changeEdgeToEdgeAngle(): last anchor is not an edge");this.types[this.types.length-1]=Re.AnchorType.ANCHOR_EDGE_ANGLE,this.values.push(t.x),this.values.push(t.y)}changeAngleEdgeToSymmetric(){if(1!==this.types.length){if(0===this.types.length)throw Error("figure.Path.changeAngleEdgeToSmooth(): figure is empty");if(this.types[this.types.length-1]!==Re.AnchorType.ANCHOR_ANGLE_EDGE)throw Error(`figure.Path.changeAngleEdgeToSmooth(): last anchor is not an angle-edge ${Re.AnchorType[this.types[this.types.length-1]]}`);this.types[this.types.length-1]=Re.AnchorType.ANCHOR_SYMMETRIC}}changeEdgeAngleToSmooth(t,e,i){if(0!==t)throw Error("figure.Path.changeEdgeAngleToAngleAngle(): index !== 0 not implemented yet");if(0===this.types.length)throw Error("figure.Path.changeEdgeAngleToAngleAngle(): figure is empty");if(this.types[t]!==Re.AnchorType.ANCHOR_EDGE_ANGLE)throw Error(`figure.Path.changeEdgeAngleToAngleAngle(): anchor is not edge-angle ${Re.AnchorType[this.types[t]]}`);this.types[t]=Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE,this.values=[e.x,e.y].concat(this.values),this.values[4]=i.x,this.values[5]=i.y}updateSmooth(t,e,i){if(0!==t)throw Error("figure.Path.updateSmooth(): index !== 0 not implemented yet");if(0===this.types.length)throw Error("figure.Path.updateSmooth(): figure is empty");if(this.types[t]!==Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE)throw Error(`figure.Path.updateSmooth(): anchor is not smooth angle-angle ${Re.AnchorType[this.types[t]]}`);this.values[0]=e.x,this.values[1]=e.y,this.values[4]=i.x,this.values[5]=i.y}changeEdgeToAngleEdge(t,e){if(0!==t)throw Error("figure.Path.changeEdgeAngleToAngleAngle(): index !== 0 not implemented yet");if(0===this.types.length)throw Error("figure.Path.changeEdgeAngleToAngleAngle(): figure is empty");if(this.types[t]!==Re.AnchorType.ANCHOR_EDGE)throw Error(`figure.Path.changeEdgeAngleToAngleAngle(): anchor is not edge ${Re.AnchorType[this.types[t]]}`);this.types[t]=Re.AnchorType.ANCHOR_ANGLE_EDGE,this.values=[e.x,e.y].concat(this.values)}changeEdgeAngleToAngleAngle(t,e){if(0!==t)throw Error("figure.Path.changeEdgeAngleToAngleAngle(): index !== 0 not implemented yet");if(0===this.types.length)throw Error("figure.Path.changeEdgeAngleToAngleAngle(): figure is empty");if(this.types[t]!==Re.AnchorType.ANCHOR_EDGE_ANGLE)throw Error(`figure.Path.changeEdgeAngleToAngleAngle(): anchor is not edge-angle ${Re.AnchorType[this.types[t]]}`);this.types[t]=Re.AnchorType.ANCHOR_ANGLE_ANGLE,this.values=[e.x,e.y].concat(this.values)}addEdgeAngle(t,e){this.types.push(Re.AnchorType.ANCHOR_EDGE_ANGLE),this.values.push(t.x),this.values.push(t.y),this.values.push(e.x),this.values.push(e.y)}addAngleEdge(t,e){this.types.push(Re.AnchorType.ANCHOR_ANGLE_EDGE),this.values.push(t.x),this.values.push(t.y),this.values.push(e.x),this.values.push(e.y)}addSymmetric(t,e){this.types.push(Re.AnchorType.ANCHOR_SYMMETRIC),this.values.push(t.x),this.values.push(t.y),this.values.push(e.x),this.values.push(e.y)}addAngleAngle(t,e,i){this.types.push(Re.AnchorType.ANCHOR_ANGLE_ANGLE),this.values.push(t.x),this.values.push(t.y),this.values.push(e.x),this.values.push(e.y),this.values.push(i.x),this.values.push(i.y)}addClose(){this.types.push(Re.AnchorType.CLOSE)}getPath(){const t=new ge;let e,i=0;for(let s=0;s<this.types.length;++s){let o=i,r=this.types[s];switch(r===Re.AnchorType.CLOSE&&(i=0,r=this.types[0]),r){case Re.AnchorType.ANCHOR_EDGE:switch(e){case void 0:t.move(this.values[i++],this.values[i++]);break;case Re.AnchorType.ANCHOR_EDGE:case Re.AnchorType.ANCHOR_ANGLE_EDGE:t.line(this.values[i++],this.values[i++]);break;case Re.AnchorType.ANCHOR_EDGE_ANGLE:case Re.AnchorType.ANCHOR_ANGLE_ANGLE:case Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE:t.curve(this.values[o-2],this.values[o-1],this.values[i],this.values[i+1],this.values[i],this.values[i+1]),i+=2;break;case Re.AnchorType.ANCHOR_SYMMETRIC:{const e={x:this.values[o-4],y:this.values[o-3]},s=kt({x:this.values[o-2],y:this.values[o-1]},e);t.curve(s.x,s.y,this.values[i],this.values[i+1],this.values[i],this.values[i+1]),i+=2}break;default:throw Error("yikes 0")}break;case Re.AnchorType.ANCHOR_EDGE_ANGLE:switch(e){case void 0:t.move(this.values[i++],this.values[i++]),i+=2;break;case Re.AnchorType.ANCHOR_EDGE:case Re.AnchorType.ANCHOR_ANGLE_EDGE:t.line(this.values[i++],this.values[i++]),i+=2;break;case Re.AnchorType.ANCHOR_EDGE_ANGLE:case Re.AnchorType.ANCHOR_ANGLE_ANGLE:case Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE:t.curve(this.values[o-2],this.values[o-1],this.values[i],this.values[i+1],this.values[i],this.values[i+1]),i+=4;break;case Re.AnchorType.ANCHOR_SYMMETRIC:{const e={x:this.values[o-4],y:this.values[o-3]},s=kt({x:this.values[o-2],y:this.values[o-1]},e);t.curve(s.x,s.y,this.values[i],this.values[i+1],this.values[i],this.values[i+1]),i+=4}break;default:throw Error("yikes 1")}break;case Re.AnchorType.ANCHOR_ANGLE_EDGE:switch(e){case void 0:i+=2,t.move(this.values[i++],this.values[i++]);break;case Re.AnchorType.ANCHOR_EDGE_ANGLE:case Re.AnchorType.ANCHOR_EDGE:case Re.AnchorType.ANCHOR_ANGLE_EDGE:case Re.AnchorType.ANCHOR_ANGLE_ANGLE:case Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE:t.curve(this.values[o-2],this.values[o-1],this.values[i++],this.values[i++],this.values[i++],this.values[i++]);break;case Re.AnchorType.ANCHOR_SYMMETRIC:{const e={x:this.values[o-4],y:this.values[o-3]},s=kt({x:this.values[o-2],y:this.values[o-1]},e);t.curve(s.x,s.y,this.values[i++],this.values[i++],this.values[i++],this.values[i++])}break;default:throw Error("yikes")}break;case Re.AnchorType.ANCHOR_SYMMETRIC:switch(e){case void 0:i+=2,t.move(this.values[i++],this.values[i++]);break;case Re.AnchorType.ANCHOR_EDGE:case Re.AnchorType.ANCHOR_EDGE_ANGLE:case Re.AnchorType.ANCHOR_ANGLE_EDGE:case Re.AnchorType.ANCHOR_ANGLE_ANGLE:case Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE:t.curve(this.values[o-2],this.values[o-1],this.values[i++],this.values[i++],this.values[i++],this.values[i++]);break;case Re.AnchorType.ANCHOR_SYMMETRIC:{const e={x:this.values[o-4],y:this.values[o-3]},s=kt({x:this.values[o-2],y:this.values[o-1]},e);t.curve(s.x,s.y,this.values[i++],this.values[i++],this.values[i++],this.values[i++])}break;default:throw Error(`yikes 3: ${Re.AnchorType[e]} -> ANCHOR_SMOOTH in ${this.toInternalString()}`)}break;case Re.AnchorType.ANCHOR_ANGLE_ANGLE:case Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE:switch(e){case void 0:i+=2,t.move(this.values[i++],this.values[i++]),i+=2;break;case Re.AnchorType.ANCHOR_EDGE:case Re.AnchorType.ANCHOR_EDGE_ANGLE:case Re.AnchorType.ANCHOR_ANGLE_EDGE:case Re.AnchorType.ANCHOR_ANGLE_ANGLE:case Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE:t.curve(this.values[o-2],this.values[o-1],this.values[i],this.values[i+1],this.values[i+2],this.values[i+3]),i+=6;break;case Re.AnchorType.ANCHOR_SYMMETRIC:{const e={x:this.values[o-4],y:this.values[o-3]},s=kt({x:this.values[o-2],y:this.values[o-1]},e);t.curve(s.x,s.y,this.values[i],this.values[i+1],this.values[i+2],this.values[i+3]),i+=6}break;default:throw Error("yikes 4")}}e=r,this.types[s]===Re.AnchorType.CLOSE&&t.close()}return t}toString(){const t=this.getPath();return void 0===this.matrix?`figure.Path(d="${t}")`:`figure.Path(matrix=${this.matrix}, d="${t}")`}updateSVG(t,e,i){return i||(i=document.createElementNS("http://www.w3.org/2000/svg","path")),i.setAttributeNS("","d",t.toString()),i.setAttributeNS("","stroke-width",String(this.strokeWidth)),i.setAttributeNS("","stroke",this.stroke),i.setAttributeNS("","fill",this.fill),i}distance(t){const e=this.getPath();return"none"!==this.fill&&e.contains(t)?-1:e.distance(t)}bounds(){return this.getPath().bounds()}transform(t){if(t.isIdentity())return!0;if(!t.isOnlyTranslateAndScale())return!1;let e=0;for(;e<this.values.length;)[this.values[e],this.values[e+1]]=t.transformArrayPoint([this.values[e],this.values[e+1]]),e+=2;return!0}getHandlePosition(t){}setHandlePosition(t,e){}toInternalString(){let t="",e=0;for(let i=0;i<this.types.length;++i)switch(this.types[i]){case Re.AnchorType.ANCHOR_EDGE:t+=`E ${this.values[e++]} ${this.values[e++]} `;break;case Re.AnchorType.ANCHOR_EDGE_ANGLE:t+=`EA ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} `;break;case Re.AnchorType.ANCHOR_ANGLE_EDGE:t+=`AE ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} `;break;case Re.AnchorType.ANCHOR_SYMMETRIC:t+=`S ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} `;break;case Re.AnchorType.ANCHOR_SMOOTH_ANGLE_ANGLE:t+=`SAA ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} `;break;case Re.AnchorType.ANCHOR_ANGLE_ANGLE:t+=`AA ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} ${this.values[e++]} `;break;case Re.AnchorType.CLOSE:t+="Z "}return t.trimEnd()}toPathString(){return this.getPath().toString()}}class Oe extends class{constructor(t){!function(t,e){if(e instanceof B){const i=e;t.data=i.sequence((()=>i.value("Figure")))}else t.data=void 0===e||void 0===e.data?new Array:e.data}(this,t)}}{constructor(t){super(t),function(t,e){if(e instanceof B){const i=e;t.id=i.ulong(),t.name=i.string()}else t.id=void 0===e||void 0===e.id?0:e.id,t.name=void 0===e||void 0===e.name?"":e.name}(this,t)}findFigureAt(t){let e,i=Number.POSITIVE_INFINITY;for(let s=this.data.length-1;s>=0;--s){let o,r=this.data[s];o=void 0!==r.matrix?new Rt(r.matrix).invert().transformPoint(t):t;let n=r.distance(o);n<i&&(i=n,e=r)}if(!(i>=Yt.FIGURE_RANGE))return e}}class Ie{constructor(t,e){this.object=t,this.attribute=e.toString()}get(){return this.object[this.attribute]}set(t){Object.defineProperty(this.object,this.attribute,{value:t})}toString(){return`${this.object[this.attribute]}`}fromString(t){const e=typeof this.object[this.attribute];let i;switch(e){case"string":i=t;break;case"number":i=Number.parseFloat(t);break;default:throw Error(`Reference.fromString() isn't yet supported for type ${e}`)}Object.defineProperty(this.object,this.attribute,{value:i})}}function ke(t,e){return new Ie(t,e)}class De extends Array{constructor(t){super(...t?.children);for(let t=0;t<this.length;++t){const e=this[t];"string"==typeof e&&(this[t]=document.createTextNode(e))}}replaceIn(t){for(;t.childNodes.length>0;)t.removeChild(t.childNodes[t.childNodes.length-1]);this.appendTo(t)}appendTo(t){for(let e of this)t.appendChild(e)}}function Le(t,e,i){return void 0!==e&&void 0!==e.children&&(e.children=[e.children]),Me(t,e)}function Me(t,e,i){let s;if("string"!=typeof t)return new t(e);const o=t;switch(o){case"svg":case"line":case"rect":case"circle":case"path":case"text":s="http://www.w3.org/2000/svg";break;default:s="http://www.w3.org/1999/xhtml"}const r=document.createElementNS(s,o);return Pe(r,e,s),r}function Pe(t,e,i){if(null!=e){for(let[s,o]of Object.entries(e))switch(s){case"children":break;case"action":t.setAction(o);break;case"model":t.setModel(o);break;case"class":t.classList.add(o);break;case"style":for(let[e,i]of Object.entries(o)){const s=/[A-Z]/g;e=e.replace(s,(t=>"-"+t.toLowerCase())),t.style.setProperty(e,i)}break;case"set":Object.defineProperty(e.set.object,e.set.attribute,{value:t});break;default:if("on"===s.substring(0,2))t.addEventListener(s.substr(2),o);else if("object"!=typeof o){if("http://www.w3.org/2000/svg"===i){const t=/[A-Z]/g;s=s.replace(t,(t=>"-"+t.toLowerCase()))}t.setAttributeNS(null,s,`${o}`)}}if(void 0!==e.children)for(let i of e.children)"string"==typeof i?t.appendChild(document.createTextNode(i)):t.appendChild(i)}}class Be{constructor(t,e){this.callback=t,this.id=e}}class He{add(t,e){this.callbacks||(this.callbacks=new Array),this.callbacks.push(new Be(t,e))}remove(t){if(this.callbacks)for(let e=this.callbacks.length-1;e>=0;--e)this.callbacks[e].id===t&&this.callbacks.splice(e,1)}count(){return this.callbacks?this.callbacks.length:0}lock(){this.locked=!0}unlock(){if(this.locked=void 0,this.triggered){let t=this.triggered.data;this.triggered=void 0,this.trigger(t)}}trigger(t){if(this.locked)this.triggered={data:t};else if(this.callbacks)for(let e=0;e<this.callbacks.length;++e)this.callbacks[e].callback(t)}}class Ge{constructor(){this.modified=new He}}class Ve extends Ge{constructor(t){super(),this._value=t}set value(t){this._value!=t&&(this._value=t,this.modified.trigger())}get value(){return this._value}}class Fe extends Ve{constructor(t){super(t)}}class $e extends Ve{constructor(t,e){super(t),e&&(this.min=e.min,this.max=e.max,this.step=e.step)}}class Ue extends Ge{constructor(t){super(),this._value=t}set promise(t){this._value=t,this.modified.trigger()}get promise(){return"string"==typeof this._value?()=>this._value:this._value}set value(t){this._value!==t&&("string"==typeof t?(this._value=t,this.modified.trigger()):console.trace(`TextModel.set value(value: string): ${typeof t} is not type string`))}get value(){switch(typeof this._value){case"number":case"string":this._value=`${this._value}`;break;case"function":this._value=this._value()}return this._value}}class We extends Ue{constructor(t){super(t)}}class ze extends Ge{constructor(t,e){super(),this.signal=new He,this.title=e,this._enabled=!0}set value(t){throw Error("Action.value can not be assigned a value")}get value(){throw Error("Action.value can not return a value")}set enabled(t){this._enabled!=t&&(this._enabled=t,this.modified.trigger())}get enabled(){return this._enabled}trigger(t){this._enabled&&this.signal.trigger(t)}}class je{constructor(){this.modelId2Models=new Map,this.modelId2Views=new Map,this.view2ModelIds=new Map,this.sigChanged=new He}registerAction(t,e){let i=new ze(void 0,t);return i.signal.add(e),this._registerModel("A:"+t,i),i}registerModel(t,e){this._registerModel("M:"+t,e)}_registerModel(t,e){let i=this.modelId2Models.get(t);i||(i=new Set,this.modelId2Models.set(t,i)),i.add(e);let s=this.modelId2Views.get(t);if(s)for(let t of s)t.setModel(e)}registerView(t,e){if(e.controller&&e.controller!==this)return void console.log("error: attempt to register view more than once at different controllers");e.controller=this;let i=this.view2ModelIds.get(e);i||(i=new Set,this.view2ModelIds.set(e,i)),i.add(t);let s=this.modelId2Views.get(t);s||(s=new Set,this.modelId2Views.set(t,s)),s.add(e);let o=this.modelId2Models.get(t);if(o)for(let t of o)e.setModel(t)}unregisterView(t){if(!t.controller)return;if(t.controller!==this)throw Error("attempt to unregister view from wrong controller");let e=this.view2ModelIds.get(t);if(e)for(let i of e){let e=this.modelId2Views.get(i);e&&(e.delete(t),0===e.size&&this.modelId2Views.delete(i),t.setModel(void 0))}}clear(){for(let t of this.view2ModelIds)t[0].setModel(void 0);this.modelId2Models.clear(),this.modelId2Views.clear(),this.view2ModelIds.clear()}bind(t,e){this.registerModel(t,e)}action(t,e){return this.registerAction(t,e)}text(t,e){let i=new Ue(e);return this.bind(t,i),i}html(t,e){let i=new We(e);return this.bind(t,i),i}boolean(t,e){let i=new Fe(e);return this.bind(t,i),i}number(t,e,i){let s=new $e(e,i);return this.bind(t,s),s}}function Ye(t){return function(t){let e=document.querySelector('template[id="'+t+'"]');if(!e)throw new Error("failed to find template '"+t+"'");let i=e.content;return document.importNode(i,!0)}(t)}function qe(t,e){let i=t.getAttribute(e);if(null===i)throw console.log("missing attribute '"+e+"' in ",t),Error("missing attribute '"+e+"' in "+t.nodeName);return i}function Ke(t,e){let i=t.getAttribute(e);return null===i?void 0:i}function Xe(t,e){return function(t){if(""===t)return 0;if("px"!==t.substr(t.length-2))throw Error(`TableView.pixelToNumber('${t}') expected 'px' suffix`);return Number.parseFloat(t.substr(0,t.length-2))}(window.getComputedStyle(t,void 0).getPropertyValue(e))}function Je(t){return Xe(t,"padding-left")+Xe(t,"padding-right")}function Ze(t){return Xe(t,"padding-top")+Xe(t,"padding-bottom")}class Qe extends je{constructor(t){super(),this.root=Ye(t),this.registerViews()}registerViews(){let t=this.root.querySelectorAll("[model]");for(let e of t){let t=e;if(t)try{this.registerView(t.getModelId(),t)}catch(t){}}t=this.root.querySelectorAll("[action]");for(let e of t){let t=e;if(t)try{this.registerView(t.getActionId(),t)}catch(t){}}}openHref(t){}}class ti extends je{constructor(){super(),this.close=this.close.bind(this)}open(t){if(this.shadow=Le("div",{style:{position:"absolute",left:"0",top:"0",right:"0",bottom:"0",backgroundColor:"#aaa",opacity:"0.5"}}),this.frame=Le("div",{style:{position:"absolute",left:"5%",top:"5%",right:"5%",bottom:"5%",padding:"10px",overflow:"auto",backgroundColor:"#fff",border:"solid 2px #000"}}),"object"==typeof t)return t instanceof De?t.appendTo(this.frame):this.frame.appendChild(t),document.body.appendChild(this.shadow),void document.body.appendChild(this.frame);document.body.appendChild(this.shadow);let e,i=document.head.querySelectorAll("link[rel=import]");for(let s of i)if(s.href===t){e=s;break}if(e)e.dispatchEvent(new Event("load"));else{let e=document.createElement("link");e.rel="import",e.href=t,e.onload=i=>{let s=e.import.querySelector("template");if(!s)throw Error("toad.openDialog: failed to find template in '"+t+"'");let o=document.importNode(s.content,!0);this.registerViews(o),this.frame.appendChild(o),document.body.appendChild(this.frame)},document.head.appendChild(e)}}close(){this.frame&&document.body.removeChild(this.frame),this.shadow&&document.body.removeChild(this.shadow),this.frame=void 0,this.shadow=void 0}registerViews(t){let e=t.querySelectorAll("[model]");for(let t of e){let e=t;if(e)try{this.registerView(e.getModelId(),e)}catch(t){}}e=t.querySelectorAll("[action]");for(let t of e){let e=t;if(e)try{this.registerView(e.getActionId(),e)}catch(t){}}}}let ei=new je;function ii(t,e){ei.bind(t,e)}function si(t,e){return ei.registerAction(t,e)}class oi{constructor(){this._stop=!1,this._firstFrame=this._firstFrame.bind(this),this._animationFrame=this._animationFrame.bind(this)}start(){this.prepare(),!0!==this._stop&&this.requestAnimationFrame(this._firstFrame)}stop(){this._stop=!0,this.animator?.current===this&&(this.animator.current=void 0)}replace(t){this.next=t,this.animationFrame(1),this.lastFrame(),t.prepare()}prepare(){}firstFrame(){}animationFrame(t){}lastFrame(){}requestAnimationFrame(t){window.requestAnimationFrame(t)}_firstFrame(t){this.startTime=t,this.firstFrame(),this._stop||(this.animationFrame(0),this.requestAnimationFrame(this._animationFrame))}_animationFrame(t){if(this.next)return void this.next._firstFrame(t);let e=oi.animationFrameCount>0?(t-this.startTime)/oi.animationFrameCount:1;e=e>1?1:e;const i=this.ease(e);this.animationFrame(i),this._stop||(i<1?this.requestAnimationFrame(this._animationFrame.bind(this)):(this.lastFrame(),this.animator?.current===this&&(this.animator.current=void 0)))}ease(t){return.5*(1-Math.cos(Math.PI*t))}}oi.animationFrameCount=468;class ri{run(t){const e=this.current;this.current=t,t.animator=this,e?(e.animator=void 0,e.replace(t)):t.start()}}class ni extends Ge{constructor(){super(),this._stringValue=""}set stringValue(t){this._stringValue!==t&&(this._stringValue=t,this.modified.trigger())}get stringValue(){return this._stringValue}isValidStringValue(t){return!1}}class li extends ni{constructor(){super(),this._map=new Map}add(t,e){this._map.set(t,e)}isValidStringValue(t){return this._map.has(t)}get value(){return this._map.get(this.stringValue)}}class ai extends HTMLElement{constructor(t){super(),Pe(this,t)}static define(t,e,i){const s=window.customElements.get(t);void 0===s?window.customElements.define(t,e,i):s!==e&&console.trace(`View::define(${t}, ...): attempt to redefine view with different constructor`)}setModel(t){console.trace("Please note that View.setModel(model) has no implementation.")}getModelId(){if(!this.hasAttribute("model"))throw Error("no 'model' attribute");let t=this.getAttribute("model");if(!t)throw Error("no model id");return"M:"+t}getActionId(){if(!this.hasAttribute("action"))throw Error("no 'action' attribute");let t=this.getAttribute("action");if(!t)throw Error("no action id");return"A:"+t}connectedCallback(){if(this.controller)return;let t="";try{t=this.getModelId()}catch(t){}""!=t&&ei.registerView(t,this)}disconnectedCallback(){this.controller&&this.controller.unregisterView(this)}}class hi extends ai{constructor(t){super(t),void 0!==t?.model&&this.setModel(t.model)}updateModel(){}updateView(t){}setModel(t){if(t===this.model)return;const e=this;this.model&&this.model.modified.remove(e),t&&t.modified.add((t=>e.updateView(t)),e),this.model=t,this.isConnected&&this.updateView(void 0)}connectedCallback(){super.connectedCallback(),this.model&&this.updateView(void 0)}}class di extends hi{constructor(t){super(t)}connectedCallback(){if(this.controller)this.updateView();else{try{ei.registerView(this.getActionId(),this)}catch(t){}try{ei.registerView(this.getModelId(),this)}catch(t){}this.updateView()}}disconnectedCallback(){super.disconnectedCallback(),this.controller&&this.controller.unregisterView(this)}setModel(t){if(!t)return this.model&&this.model.modified.remove(this),this.action&&this.action.modified.remove(this),this.model=void 0,this.action=void 0,void this.updateView();if(t instanceof ze)this.action=t,this.action.modified.add((()=>{this.updateView()}),this);else{if(!(t instanceof Ue))throw Error("unexpected model of type "+t.constructor.name);this.model=t,this.model.modified.add((()=>{this.updateView()}),this)}this.updateView()}setAction(t){if(t instanceof Function){const e=new ze(void 0,"");e.signal.add(t),this.setModel(e)}else this.setModel(t)}isEnabled(){return void 0!==this.action&&this.action.enabled}}let ci=document.createElement("style");ci.textContent="\n  button {\n    border: none;\n    background-color: var(--toad-primary-color, #0052cc);\n    color: #ffffff;\n    border-radius: 3px;\n    font-size: 14px;\n    font-weight: bold;\n    height: 32px;\n    line-height: 32px;\n    min-width: 24px;\n    text-shadow: none;\n    padding: 0 10px;\n    margin-right: 4px;\n  }\n  \n  button:hover {\n    background-color: #0065ff;\n  }\n  \n  button:hover:active {\n    background-color: #0049b0;\n  }\n  \n  button:disabled, button:disabled:active {\n    background-color: #888;\n  }\n";class ui extends di{constructor(t){super(t),this.button=document.createElement("button"),this.button.onclick=()=>{this.action&&this.action.trigger()},this.button.disabled=!0,this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(ci,!0)),this.shadowRoot.appendChild(this.button)}connectedCallback(){super.connectedCallback(),0===this.children.length&&(this._observer=new MutationObserver(((t,e)=>{void 0!==this._timer&&clearTimeout(this._timer),this._timer=window.setTimeout((()=>{this._timer=void 0,this.updateView()}),100)})),this._observer.observe(this,{childList:!0,subtree:!0,characterData:!0}))}updateView(){this.isConnected&&(this.model&&this.model.value?this.model instanceof We?this.button.innerHTML=this.model.value:this.button.innerText=this.model.value:this.button.innerHTML=this.innerHTML,this.button.disabled=!this.isEnabled())}}ui.define("toad-button",ui);let gi=document.createElement("style");gi.textContent="\nsvg {\n  width: 12px;\n  height: 12px;\n  vertical-align: middle;\n  margin: 3px;              /* space for the outline */\n  background: none;\n}\nsvg:focus {\n  outline-offset: -2px;     /* bring outline in touch with the svg */\n  background: #9eccfb;      /* the rectangle is rounded, fill the corners */\n  outline-color: 9eccfb;    /* outline shall be the same color used to fill the corners */\n}\n@media(pointer: coarse) { /* works on Chrome but iOS is never coarse :( */\n  svg {\n    width: 18px;\n    height: 18px;\n  }\n}\nsvg rect {\n  stroke: var(--border-color, var(--toad-neutral-color, #aaa));\n  fill: var(--background-color, #fff);\n  stroke-width: 1px;\n}\nsvg path {\n  stroke: var(--marker-color, none);\n  fill: none;\n  stroke-width: 2px;\n}\n:host([checked]) svg rect {\n  stroke: var(--checked-border-color, var(--toad-primary-color, #0052cc));\n  fill: var(--checked-background-color, var(--toad-primary-color, #0052cc));\n}\n:host([checked]) svg path {\n  stroke: var(--checked-marker-color, var(--toad-light-color, #fff));\n}\n:host([disabled]) svg rect {\n  stroke: var(--checked-border-color, var(--toad-primary-color, #bdbdbd));\n  fill: var(--checked-background-color, var(--toad-primary-color, #fff));\n}\n:host([disabled]) svg path {\n  stroke: var(--checked-marker-color, var(--toad-light-color, none));\n}\n:host([checked][disabled]) svg path {\n  stroke: var(--checked-marker-color, var(--toad-light-color, #bdbdbd));\n}";class fi extends hi{constructor(){super();let t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttributeNS("","viewBox","0 0 18 18");let e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttributeNS("","x","1"),e.setAttributeNS("","y","1"),e.setAttributeNS("","width","16"),e.setAttributeNS("","height","16"),e.setAttributeNS("","rx","3"),e.setAttributeNS("","ry","3");let i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS("","d","M4 9.5 L 7.5 13 L 14.5 4"),t.onclick=()=>{this.toggle()},t.setAttributeNS("","tabindex","0"),t.addEventListener("keydown",(t=>{" "===t.key&&this.toggle()})),t.onmousedown=e=>{t.focus(),e.preventDefault()},t.appendChild(e),t.appendChild(i),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(gi,!0)),this.shadowRoot.appendChild(t)}setModel(t){if(void 0!==t&&!(t instanceof Fe))throw Error("CheckBoxView.setModel(): model is not of type BooleanModel");super.setModel(t)}static get observedAttributes(){return["checked"]}attributeChangedCallback(t,e,i){if("checked"===t)this.updateModel()}toggle(){this.hasAttribute("disabled")||(this.hasAttribute("checked")?this.removeAttribute("checked"):this.setAttribute("checked",""),this.updateModel())}updateModel(){this.model&&(this.model.value=this.hasAttribute("checked"))}updateView(){if(!this.model)return this.setAttribute("disabled",""),void this.removeAttribute("checked");this.removeAttribute("disabled"),this.model.value?this.setAttribute("checked",""):this.removeAttribute("checked")}}fi.define("toad-checkbox",fi);class pi extends hi{constructor(t){super(t),this.input=document.createElement("input"),this.input.type="range";let e=this;this.input.oninput=()=>{e.updateModel()},this.attachShadow({mode:"open"}).appendChild(this.input)}updateModel(){this.model&&(this.model.value=Number.parseFloat(this.input.value))}updateView(){this.model&&(void 0===this.model.step&&void 0!==this.model.min&&void 0!==this.model.max?this.input.step=""+(this.model.max-this.model.min)/100:this.input.step=String(this.model.step),this.input.min=String(this.model.min),this.input.max=String(this.model.max),this.input.value=String(this.model.value))}}pi.define("toad-slider",pi);let mi=document.createElement("style");mi.textContent="\ninput {\n  font-family: var(--toad-font-family, sans-serif);\n  font-size: var(--toad-font-size, 12px);\n  border: 1px #ccc solid;\n  border-radius: 3px;\n  margin: 2px;\n  padding: 4px 5px;\n}\n\n:host(.embedded) input {\n  border: none 0;\n  border-radius: 0;\n  padding: 0;\n  margin: 2px;\n  width: 100%;\n  background: #fff;\n}\n";class yi extends hi{constructor(t){super(t),this.input=document.createElement("input"),this.input.oninput=()=>{this.updateModel()},this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(mi,!0)),this.shadowRoot.appendChild(this.input)}focus(){this.input.focus()}blur(){this.input.blur()}static get observedAttributes(){return["value"]}attributeChangedCallback(t,e,i){if("value"===t)this.model&&void 0!==i&&(this.model.value=i)}updateModel(){this.model&&(this.model.value=this.input.value),this.setAttribute("value",this.input.value)}updateView(){if(!this.model)return;const t=`${this.model.value}`;this.input.value!==t&&(this.input.value=t,this.setAttribute("value",this.input.value))}get value(){return this.input.value}set value(t){this.input.value=t,this.updateModel()}}yi.define("toad-text",yi);let vi=document.createElement("style");vi.textContent="\n\n/* try to follow material ui: when active render button labels in black, otherwise in gray */\nsvg .fill {\n  fill: #ccc;\n  stroke: #ccc;\n}\nsvg .stroke {\n  fill: none;\n  stroke: #ccc;\n}\nsvg .strokeFill {\n  fill: #fff;\n  stroke: #ccc;\n}\n\n.toolbar.active svg .fill {\n  fill: #000;\n  stroke: #000;\n}\n.toolbar.active svg .stroke {\n  fill: none;\n  stroke: #000;\n}\n.toolbar.active svg .strokeFill {\n  fill: #fff;\n  stroke: #000;\n}\n\n.toolbar button {\n    background: #fff;\n    color: #000;\n    border: 1px #ccc;\n    border-style: solid solid solid none;\n    padding: 5;\n    margin: 0;\n    vertical-align: middle;\n    height: 22px;\n}\n\n.toolbar button:active:hover {\n  background: linear-gradient(to bottom, #7abcff 0%,#0052cc 100%,#4096ee 100%);\n}\n\n.toolbar button.left {\n    border-style: solid;\n    border-radius: 3px 0 0 3px;\n}\n\n.toolbar button.right {\n    border: 1px #ccc;\n    border-style: solid solid solid none;\n    border-radius: 0 3px 3px 0;\n}\n\n.toolbar button.active {\n    background: linear-gradient(to bottom, #7abcff 0%,#0052cc 100%,#4096ee 100%);\n    border: 1px #0052cc solid;\n    color: #fff;\n}\n\ndiv.textarea {\n  font-family: var(--toad-font-family, sans-serif);\n  font-size: var(--toad-font-size, 12px);\n  border: 1px #ccc solid;\n  border-radius: 3px;\n  margin: 2px;\n  padding: 4px 5px;\n  outline-offset: -2px;\n}\n\ndiv.textarea h1 {\n  font-size: 22px;\n  margin: 0;\n  padding: 4px 0 4px 0;\n}\n\ndiv.textarea h2 {\n  font-size: 18px;\n  margin: 0;\n  padding: 4px 0 4px 0;\n}\n\ndiv.textarea h3 {\n  font-size: 16px;\n  margin: 0;\n  padding: 4px 0 4px 0;\n}\n\ndiv.textarea h4 {\n  font-size: 14px;\n  margin: 0;\n  padding: 4px 0 4px 0;\n}\n\ndiv.textarea div {\n  padding: 2px 0 2px 0;\n}\n";class wi extends hi{constructor(){super(),wi.texttool=this;let t=Le("div",{class:"toolbar"});this.buttonH1=Le("button",{class:"left",children:"H1"}),this.buttonH1.onclick=()=>{document.execCommand("formatBlock",!1,"<h1>"),this.update()},t.appendChild(this.buttonH1),this.buttonH2=Le("button",{children:"H2"}),this.buttonH2.onclick=()=>{document.execCommand("formatBlock",!1,"<h2>"),this.update()},t.appendChild(this.buttonH2),this.buttonH3=Le("button",{children:"H3"}),this.buttonH3.onclick=()=>{document.execCommand("formatBlock",!1,"<h3>"),this.update()},t.appendChild(this.buttonH3),this.buttonH4=Le("button",{class:"right",children:"H4"}),this.buttonH4.onclick=()=>{document.execCommand("formatBlock",!1,"<h4>"),this.update()},t.appendChild(this.buttonH4),t.appendChild(document.createTextNode(" ")),this.buttonBold=Le("button",{class:"left",children:Le("b",{children:"B"})}),this.buttonBold.onclick=()=>{document.execCommand("bold",!1),this.update()},t.appendChild(this.buttonBold),this.buttonItalic=Le("button",{children:Le("i",{children:"I"})}),this.buttonItalic.onclick=()=>{document.execCommand("italic",!1),this.update()},t.appendChild(this.buttonItalic),this.buttonUnderline=Le("button",{children:Le("u",{children:"U"})}),this.buttonUnderline.onclick=()=>{document.execCommand("underline",!1),this.update()},t.appendChild(this.buttonUnderline),this.buttonStrikeThrough=Le("button",{children:Le("strike",{children:"S"})}),this.buttonStrikeThrough.onclick=()=>{document.execCommand("strikeThrough",!1),this.update()},t.appendChild(this.buttonStrikeThrough),this.buttonSubscript=Le("button",{children:"x₂"}),this.buttonSubscript.onclick=()=>{document.execCommand("subscript",!1),this.update()},t.appendChild(this.buttonSubscript),this.buttonSuperscript=Le("button",{class:"right",children:"x²"}),this.buttonSuperscript.onclick=()=>{document.execCommand("superscript",!1),this.update()},t.appendChild(this.buttonSuperscript),t.appendChild(document.createTextNode(" ")),this.buttonJustifyLeft=Le("button",{class:"left",children:Me("svg",{viewBox:"0 0 10 9",width:"10",height:"9",children:[Le("line",{x1:"0",y1:"0.5",x2:"10",y2:"0.5",stroke:"#000"}),Le("line",{x1:"0",y1:"2.5",x2:"6",y2:"2.5",stroke:"#000"}),Le("line",{x1:"0",y1:"4.5",x2:"10",y2:"4.5",stroke:"#000"}),Le("line",{x1:"0",y1:"6.5",x2:"6",y2:"6.5",stroke:"#000"}),Le("line",{x1:"0",y1:"8.5",x2:"10",y2:"8.5",stroke:"#000"})]})}),this.buttonJustifyLeft.onclick=()=>{document.execCommand("justifyLeft",!1),this.update()},t.appendChild(this.buttonJustifyLeft),this.buttonJustifyCenter=Le("button",{children:Me("svg",{viewBox:"0 0 10 9",width:"10",height:"9",children:[Le("line",{x1:"0",y1:"0.5",x2:"10",y2:"0.5",stroke:"#000"}),Le("line",{x1:"2",y1:"2.5",x2:"8",y2:"2.5",stroke:"#000"}),Le("line",{x1:"0",y1:"4.5",x2:"10",y2:"4.5",stroke:"#000"}),Le("line",{x1:"2",y1:"6.5",x2:"8",y2:"6.5",stroke:"#000"}),Le("line",{x1:"0",y1:"8.5",x2:"10",y2:"8.5",stroke:"#000"})]})}),this.buttonJustifyCenter.onclick=()=>{document.execCommand("justifyCenter",!1),this.update()},t.appendChild(this.buttonJustifyCenter),this.buttonJustifyRight=Le("button",{class:"right",children:Me("svg",{viewBox:"0 0 10 9",width:"10",height:"9",children:[Le("line",{x1:"0",y1:"0.5",x2:"10",y2:"0.5",stroke:"#000"}),Le("line",{x1:"4",y1:"2.5",x2:"10",y2:"2.5",stroke:"#000"}),Le("line",{x1:"0",y1:"4.5",x2:"10",y2:"4.5",stroke:"#000"}),Le("line",{x1:"4",y1:"6.5",x2:"10",y2:"6.5",stroke:"#000"}),Le("line",{x1:"0",y1:"8.5",x2:"10",y2:"8.5",stroke:"#000"})]})}),this.buttonJustifyRight.onclick=()=>{document.execCommand("justifyRight",!1),this.update()},t.appendChild(this.buttonJustifyRight),this.buttonUnorderedList=Le("button",{class:"left",children:Me("svg",{style:{display:"block"},viewBox:"0 0 17 11.5",width:"17",height:"11.5",children:[Le("circle",{cx:"4.5",cy:"1.5",r:"0.8",stroke:"#000",fill:"#000"}),Le("line",{x1:"7",y1:"1.5",x2:"17",y2:"1.5",stroke:"#000"}),Le("circle",{cx:"4.5",cy:"5.5",r:"0.8",stroke:"#000",fill:"#000"}),Le("line",{x1:"7",y1:"5.5",x2:"17",y2:"5.5",stroke:"#000"}),Le("circle",{cx:"4.5",cy:"9.5",r:"0.8",stroke:"#000",fill:"#000"}),Le("line",{x1:"7",y1:"9.5",x2:"17",y2:"9.5",stroke:"#000"})]})}),this.buttonUnorderedList.onclick=t=>{document.execCommand("insertUnorderedList",!1),this.update()},t.appendChild(this.buttonUnorderedList),this.buttonOrderedList=Le("button",{class:"right",children:Me("svg",{style:{display:"block"},viewBox:"0 0 17 11.5",width:"17",height:"11.5",children:[Le("line",{x1:"4.5",y1:"0",x2:"4.5",y2:"3",stroke:"#000"}),Le("line",{x1:"7",y1:"1.5",x2:"17",y2:"1.5",stroke:"#000"}),Le("line",{x1:"2.5",y1:"4",x2:"2.5",y2:"7",stroke:"#000"}),Le("line",{x1:"4.5",y1:"4",x2:"4.5",y2:"7",stroke:"#000"}),Le("line",{x1:"7",y1:"5.5",x2:"17",y2:"5.5",stroke:"#000"}),Le("line",{x1:"0.5",y1:"8",x2:"0.5",y2:"11",stroke:"#000"}),Le("line",{x1:"2.5",y1:"8",x2:"2.5",y2:"11",stroke:"#000"}),Le("line",{x1:"4.5",y1:"8",x2:"4.5",y2:"11",stroke:"#000"}),Le("line",{x1:"7",y1:"9.5",x2:"17",y2:"9.5",stroke:"#000"})]})}),this.buttonOrderedList.onclick=()=>{document.execCommand("insertOrderedList",!1),this.update()},t.appendChild(this.buttonOrderedList),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(vi,!0)),this.shadowRoot.appendChild(t)}update(){this.buttonH1.classList.toggle("active","h1"===document.queryCommandValue("formatBlock")),this.buttonH2.classList.toggle("active","h2"===document.queryCommandValue("formatBlock")),this.buttonH3.classList.toggle("active","h3"===document.queryCommandValue("formatBlock")),this.buttonH4.classList.toggle("active","h4"===document.queryCommandValue("formatBlock")),this.buttonBold.classList.toggle("active",document.queryCommandState("bold")),this.buttonItalic.classList.toggle("active",document.queryCommandState("italic")),this.buttonUnderline.classList.toggle("active",document.queryCommandState("underline")),this.buttonStrikeThrough.classList.toggle("active",document.queryCommandState("strikeThrough")),this.buttonSubscript.classList.toggle("active",document.queryCommandState("subscript")),this.buttonSuperscript.classList.toggle("active",document.queryCommandState("superscript")),this.buttonJustifyLeft.classList.toggle("active",document.queryCommandState("justifyLeft")),this.buttonJustifyCenter.classList.toggle("active",document.queryCommandState("justifyCenter")),this.buttonJustifyRight.classList.toggle("active",document.queryCommandState("justifyRight"))}}wi.define("toad-texttool",wi);class Ei extends hi{constructor(){super();let t=document.createElement("div");this.content=t,t.classList.add("textarea"),t.contentEditable="true",t.oninput=e=>{if(this.model instanceof We){let i=e.target.firstChild;i&&3===i.nodeType?document.execCommand("formatBlock",!1,"<div>"):"<br>"===t.innerHTML&&(t.innerHTML="")}this.updateModel()},t.onkeydown=t=>{this.model instanceof We&&(!0===t.metaKey&&"b"===t.key?(t.preventDefault(),document.execCommand("bold",!1),this.updateTextTool()):!0===t.metaKey&&"i"===t.key?(t.preventDefault(),document.execCommand("italic",!1),this.updateTextTool()):!0===t.metaKey&&"u"===t.key?(t.preventDefault(),document.execCommand("underline",!1),this.updateTextTool()):"Tab"===t.key?t.preventDefault():"Enter"===t.key&&!0!==t.shiftKey&&"blockquote"===document.queryCommandValue("formatBlock")&&document.execCommand("formatBlock",!1,"<p>"))},t.onkeyup=()=>{this.updateTextTool()},t.onmouseup=()=>{this.updateTextTool()},this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(vi,!0)),this.shadowRoot.appendChild(t)}updateTextTool(){void 0!==wi.texttool&&wi.texttool.update()}updateModel(){this.model&&(this.model.promise=()=>this.model instanceof We?this.content.innerHTML:this.content.innerText)}updateView(){this.model&&(this.model instanceof We?this.content.innerHTML!==this.model.value&&(this.content.innerHTML=this.model.value):this.content.innerText!==this.model.value&&(this.content.innerText=this.model.value))}}Ei.define("toad-textarea",Ei);class bi extends ai{static focusIn(t){const e=new Map;for(let i=t.parentElement,s=0;null!==i;i=i.parentElement,++s)e.set(i,s);let i,s,o=Number.MAX_SAFE_INTEGER,r=new Array;for(const s of this.allTools.values())if(s.canHandle(t))for(let t=s.parentElement,n=0;null!==t;t=t.parentElement,++n){const n=e.get(t);void 0!==n&&(o<n||(o>n&&(r.length=0),o=n,i=t,r.push(s)))}if(!i)return;const n=bi.getIndex(t,i);let l=Number.MIN_SAFE_INTEGER;for(let t of r){const e=bi.getIndex(t,i);e<n&&e>l&&(l=e,s=t)}this.setActive(s,t)}static getIndex(t,e){void 0===e&&console.trace(`GenericTool.getIndex(${t}, ${e})`);let i=t;for(;i.parentElement!==e;)i=i.parentElement;return Array.from(e.childNodes).indexOf(i)}static setActive(t,e){this.activeTool&&this.activeTool.deactivate(),this.activeTool=t,this.activeView=e,t&&t.activate()}static focusOut(t){this.activeView===t&&this.setActive(void 0,void 0)}connectedCallback(){super.connectedCallback(),bi.allTools.add(this)}disconnectedCallback(){bi.activeTool===this&&bi.setActive(void 0,void 0),bi.allTools.delete(this),super.disconnectedCallback()}}bi.allTools=new Set,window.addEventListener("focusin",(t=>{t.target instanceof bi||(t.relatedTarget instanceof ai&&bi.focusOut(t.relatedTarget),t.target instanceof ai&&bi.focusIn(t.target))}));let Ai=document.createElement("style");Ai.textContent="\n:host {\n    display: inline-block;\n    overflow: hidden;\n    box-sizing: border-box;\n    border: 1px solid #e3dbdb;\n    border-radius: 3px;\n    background: #e3dbdb;\n    width: 32px;\n    height: 32px;\n    margin: 0;\n    padding: 0;\n}\n\n:host([selected]) {\n    background: #ac9393;\n}\n\n:host([disabled]) {\n    opacity: 0.5;\n}\n\n:host([disabled]) img {\n    opacity: 0.5;\n}\n\n:host([checked][disabled]) {\n}\n";class xi extends hi{constructor(t){super(t),t?(this.setAttribute("value",t.value),this.setAttribute("img",t.img),!0===t.disabled&&this.setAttribute("disabled","disabled")):t={value:this.getAttribute("value"),img:this.getAttribute("img"),disabled:this.hasAttribute("disabled")},this.onmousedown=t=>{this.hasAttribute("disabled")||(this.focus(),t.preventDefault(),void 0!==this.model&&(this.model.stringValue=this.getValue()))};let e=document.createElement("img");e.src=t.img,this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(Ai,!0)),this.shadowRoot.appendChild(e)}getValue(){let t=this.getAttribute("value");if(null===t)throw Error("no value");return t}connectedCallback(){super.connectedCallback(),void 0===this.model&&this.setAttribute("disabled","")}updateView(){if(void 0===this.model)return this.setAttribute("disabled",""),void this.removeAttribute("selected");let t=this.getValue();this.model.isValidStringValue(t)?this.removeAttribute("disabled"):this.setAttribute("disabled",""),this.model.stringValue===t?this.setAttribute("selected",""):this.removeAttribute("selected")}}xi.define("toad-toolbutton",xi);class Ci extends hi{constructor(){super()}updateView(){if(!this.model)return;let t=void 0===this.model.value?"":this.model.value;this.model instanceof We?this.innerHTML=t:this.innerText=t}}Ci.define("toad-slot",Ci);class Si extends hi{updateView(){this.model&&(this.style.display=this.model.value?"":"none")}}Si.define("toad-if",Si);const Ti=document.createElement("style");var _i;Ti.textContent=`\n  :host(.menu-button) {\n    font-family: var(--toad-font-family, sans-serif);\n    font-size: 14px;\n    font-weight: bold;\n    padding: 7px;\n    vertical-align: center;\n  \n    background: var(--toad-menu-face, #fff);\n    color: var(--toad-menu-type, #000);\n    cursor: default;\n  }\n  :host(.menu-button.active) {\n    background: var(--toad-menu-type, #000);\n    color: var(--toad-menu-face, #fff);\n  }\n  :host(.menu-button.disabled) {\n    color: var(--toad-menu-face-disabled, #888);\n  }\n  :host(.menu-button.active.disabled) {\n    color: var(--toad-menu-face-disabled, #888);;\n  }\n  :host(.menu-button.menu-down) {\n    padding-right: 20px;\n    background-image: url("data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="15" height="14"><path d="M 0 4 l 10 0 l -5 5 Z" fill="#000" stroke="none"/></svg>')}");\n    background-repeat: no-repeat;\n    background-position: right center;\n  }\n  :host(.menu-button.active.menu-down) {\n    background-image: url("data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="15" height="14"><path d="M 0 4 l 10 0 l -5 5 Z" fill="#fff" stroke="none"/></svg>')}");\n    background-repeat: no-repeat;\n    background-position: right center;\n  }\n  :host(.menu-button.menu-side) {\n    padding-right: 20px;\n    background-image: url("data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="15" height="14"><path d="M 0 2 l 0 10 l 5 -5 Z" fill="#000" stroke="none"/></svg>')}");\n    background-repeat: no-repeat;\n    background-position: right center;\n  }\n  :host(.menu-button.active.menu-side) {\n    background-image: url("data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="15" height="14"><path d="M 0 2 l 0 10 l 5 -5 Z" fill="#fff" stroke="none"/></svg>')}");\n    background-repeat: no-repeat;\n    background-position: right center;\n  }\n  .menu-bar {\n    display: flex;\n    flex-direction: row;\n    justify-content: flex-start;\n    align-items: center;\n  }\n  .menu-popup {\n    position: fixed;\n    display: flex;\n    flex-direction: column;\n    box-shadow: 2px 2px 5px var(--toad-menu-shadow, #888);;\n  }\n`,function(t){t[t.WAIT=0]="WAIT",t[t.DOWN=1]="DOWN",t[t.UP_N_HOLD=2]="UP_N_HOLD",t[t.DOWN_N_HOLD=3]="DOWN_N_HOLD",t[t.DOWN_N_OUTSIDE=4]="DOWN_N_OUTSIDE",t[t.DOWN_N_INSIDE_AGAIN=5]="DOWN_N_INSIDE_AGAIN"}(_i||(_i={}));class Ri extends ai{constructor(t){super(t),this.vertical=!0,this.closeOnClose=!1,this.state=_i.WAIT}}class Ni extends Ri{constructor(t,e){super(),this.vertical=!0,this.root=t,this.parentButton=e,this.popup=document.createElement("div"),this.popup.classList.add("menu-popup");let i=t.down;for(;i;)i.isAvailable()?i.createWindowAt(this,this.popup):i.deleteWindow(),i=i.next;this.appendChild(this.popup),this.show()}show(){this.parentButton.master.vertical?function(t,e){let i=t.getBoundingClientRect();e.style.opacity="0",e.style.left=i.left+i.width+"px",e.style.top=i.top+"px",setTimeout((function(){let t=e.getBoundingClientRect();i.top+t.height>window.innerHeight&&(e.style.top=i.top+i.height-t.height+"px"),i.left+i.width+t.width>window.innerWidth&&(e.style.left=i.left-t.width+"px"),e.style.opacity="1"}),0)}(this.parentButton,this.popup):function(t,e){let i=t.getBoundingClientRect();e.style.opacity="0",e.style.left=i.left+"px",e.style.top=i.top+i.height+"px",setTimeout((function(){let t=e.getBoundingClientRect();i.top+i.height+t.height>window.innerHeight&&(e.style.top=i.top-t.height+"px"),i.left+t.width>window.innerWidth&&(e.style.left=i.left+i.width-t.width+"px"),e.style.opacity="1"}),0)}(this.parentButton,this.popup),this.style.display=""}hide(){this.style.display="none"}}ai.define("toad-popupmenu",Ni);class Oi extends hi{constructor(t,e){super(),this.master=t,this.node=e;let i=this;if(this.classList.add("menu-button"),e.down&&(t.vertical?this.classList.add("menu-side"):this.classList.add("menu-down")),this.updateView(),this.onmousedown=t=>{t.stopPropagation();let e=function(t){document.removeEventListener("mouseup",e,{capture:!0}),t.preventDefault(),setTimeout((()=>{Oi.buttonDown&&i.dispatchEvent(new MouseEvent("mouseup",t))}),0)};if(document.addEventListener("mouseup",e,{capture:!0}),Oi.buttonDown=!0,!this.master)throw Error("yikes");switch(this.master.state){case _i.WAIT:this.master.state=_i.DOWN,this.activate();break;case _i.UP_N_HOLD:this.master.active!==this?(this.master.state=_i.DOWN,this.activate()):this.master.state=_i.DOWN_N_HOLD;break;default:throw Error("unexpected state "+this.master.state)}return!1},this.onmouseup=t=>{if(t.stopPropagation(),Oi.buttonDown){if(Oi.buttonDown=!1,!this.master)throw Error("yikes");if(!this.node)throw Error("yikes");switch(this.master.state){case _i.DOWN:this.node.isEnabled()&&!this.node.down?(this.trigger(),this.master.state=_i.WAIT):(this.master.state=_i.UP_N_HOLD,Oi.documentMouseDown&&document.removeEventListener("mousedown",Oi.documentMouseDown,{capture:!1}),Oi.documentMouseDown=function(t){Oi.documentMouseDown&&document.removeEventListener("mousedown",Oi.documentMouseDown,{capture:!1}),Oi.documentMouseDown=void 0,"TOAD-MENUBUTTON"!==t.target.tagName&&i.collapse()},document.addEventListener("mousedown",Oi.documentMouseDown,{capture:!1}));break;case _i.DOWN_N_HOLD:case _i.DOWN_N_OUTSIDE:this.master.state=_i.WAIT,this.deactivate(),this.collapse(),this.master.closeOnClose;break;case _i.DOWN_N_INSIDE_AGAIN:this.trigger();break;default:throw Error("unexpected state "+this.master.state)}return!1}},this.onmouseout=t=>{if(t.stopPropagation(),!this.master)throw Error("yikes");switch(Oi.inside=void 0,this.master.state){case _i.WAIT:case _i.DOWN_N_OUTSIDE:case _i.UP_N_HOLD:case _i.DOWN_N_HOLD:break;case _i.DOWN:case _i.DOWN_N_INSIDE_AGAIN:this.master.state=_i.DOWN_N_OUTSIDE,this.updateView();break;default:throw Error("unexpected state")}return!1},this.onmouseover=t=>{if(t.stopPropagation(),!i.master)throw Error("yikes");switch(Oi.inside=i,i.master.state){case _i.WAIT:case _i.UP_N_HOLD:case _i.DOWN_N_OUTSIDE:case _i.DOWN_N_HOLD:case _i.DOWN:case _i.DOWN_N_INSIDE_AGAIN:if(!Oi.buttonDown)break;if(!this.master)throw Error("yikes");this.master.active&&this.master.active.deactivate(),this.master.state=_i.DOWN_N_INSIDE_AGAIN,this.activate();break;default:throw Error("unexpected state "+i.master.state)}return!1},this.attachShadow({mode:"open"}),!this.shadowRoot)throw Error("yikes");this.shadowRoot.appendChild(document.importNode(Ti,!0)),this.node.modelId||this.shadowRoot.appendChild(document.createTextNode(e.label))}connectedCallback(){if(!this.controller){if(void 0===this.node.down){let t=this.node.title;for(let e=this.node.parent;e&&e.title.length;e=e.parent)t=e.title+"|"+t;t="A:"+t,ei.registerView(t,this)}if(void 0!==this.node.modelId)if("string"==typeof this.node.modelId){let t="M:"+this.node.modelId;ei.registerView(t,this)}else this.setModel(this.node.modelId)}}disconnectedCallback(){this.controller&&this.controller.unregisterView(this)}setModel(t){if(!t)return this.action&&this.action.modified.remove(this),this.model=void 0,this.action=void 0,void this.updateView();if(t instanceof ze)this.action=t,this.action.modified.add((()=>{this.updateView()}),this);else{if(!(t instanceof Ue))throw Error("unexpected model of type "+t.constructor.name);this.model=t}this.updateView()}updateView(){if(this.model&&this.model.value){if(!this.shadowRoot)throw Error("yikes");let t=document.createElement("span");this.model instanceof We?t.innerHTML=this.model.value:t.innerText=this.model.value,this.shadowRoot.children.length>1&&this.shadowRoot.removeChild(this.shadowRoot.children[1]),this.shadowRoot.children.length>1?this.shadowRoot.insertBefore(t,this.shadowRoot.children[1]):this.shadowRoot.appendChild(t)}if(!this.master)throw Error("yikes");let t=!1;if(this.master.active==this)switch(this.master.state){case _i.DOWN:case _i.UP_N_HOLD:case _i.DOWN_N_HOLD:case _i.DOWN_N_INSIDE_AGAIN:t=!0;break;case _i.DOWN_N_OUTSIDE:if(!this.node)throw Error("yikes");t=void 0!==this.node.down&&this.node.isEnabled()}this.classList.toggle("active",t),this.classList.toggle("disabled",!this.isEnabled())}isEnabled(){return void 0!==this.node.down||void 0!==this.action&&this.action.enabled}trigger(){this.collapse(),this.action&&this.action.trigger()}collapse(){if(!this.master)throw Error("yikes");this.master.parentButton?this.master.parentButton.collapse():this.deactivate()}openPopup(){if(this.node&&this.node.down){if(!this.shadowRoot)throw Error("yikes");this.popup?this.popup.show():(this.popup=new Ni(this.node,this),this.shadowRoot.appendChild(this.popup))}}closePopup(){this.popup&&(this.popup.active&&this.popup.active.deactivate(),this.popup.hide())}activate(){if(!this.master)throw Error("yikes");if(!this.node)throw Error("yikes");let t=this.master.active;this.master.active=this,t&&t!==this&&(t.closePopup(),t.updateView()),this.updateView(),this.openPopup()}deactivate(){if(!this.master)throw Error("yikes");this.master.active===this&&(this.master.active.closePopup(),this.master.active=void 0,this.master.state=_i.WAIT,this.updateView())}}Oi.define("toad-menubutton",Oi);class Ii{constructor(t,e,i,s,o){this.title=t,this.label=e,this.shortcut=i,this.type=s||"entry",this.modelId=o}isEnabled(){return!0}isAvailable(){return!0}createWindowAt(t,e){if("spacer"==this.type){let t=document.createElement("span");return t.style.flexGrow="1",void e.appendChild(t)}this.view=new Oi(t,this),e.appendChild(this.view)}deleteWindow(){}}class ki extends Ri{constructor(t){super(t),this.config=t?.config,this.vertical=!1,this.root=new Ii("","",void 0,void 0)}connectedCallback(){if(super.connectedCallback(),this.tabIndex=0,this.config)return this.config2nodes(this.config,this.root),this.referenceActions(),void this.createShadowDOM();0===this.children.length?(this._observer=new MutationObserver(((t,e)=>{void 0!==this._timer&&clearTimeout(this._timer),this._timer=window.setTimeout((()=>{this._timer=void 0,this.layout2nodes(this.children,this.root),this.referenceActions(),this.createShadowDOM()}),100)})),this._observer.observe(this,{childList:!0,subtree:!0})):(this.layout2nodes(this.children,this.root),this.referenceActions(),this.createShadowDOM())}layout2nodes(t,e){let i=e.down;for(let s of t){let t;switch(s.nodeName){case"TOAD-MENUSPACER":t=new Ii("","","","spacer");break;case"TOAD-MENUENTRY":t=new Ii(qe(s,"name"),qe(s,"label"),Ke(s,"shortcut"),Ke(s,"type"),Ke(s,"model"))}if(t&&(t.parent=e,i?i.next=t:e.down=t,i=t),!i)throw Error("yikes");this.layout2nodes(s.children,i)}}config2nodes(t,e){let i=e.down;for(let s of t){let t;if(t=!0===s.space?new Ii("","","","spacer"):new Ii(s.name,s.label,s.shortcut,s.type,s.model),t&&(t.parent=e,i?i.next=t:e.down=t,i=t),!i)throw Error("yikes");s.sub&&this.config2nodes(s.sub,i)}}referenceActions(){}findNode(t,e){let i=t.indexOf("|"),s=-1==i?t:t.substr(0,i),o=-1==i?"":t.substr(i+1);e||(e=this.root);for(let t=e.down;t;t=t.next)if(t.title==s)return t.down?this.findNode(o,t):t}createShadowDOM(){this.view=document.createElement("div"),this.view.classList.add("menu-bar");let t=this.root.down;for(;t;)t.isAvailable()?t.createWindowAt(this,this.view):t.deleteWindow(),t=t.next;this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(Ti,!0)),this.shadowRoot.appendChild(this.view)}}ki.define("toad-menu",ki);class Di extends HTMLElement{}ai.define("toad-menuspacer",Di);function Li(t){if(void 0===t)return;const e=$i(t);if(void 0===e)return;const i=e.getBoundingClientRect(),s=t.getBoundingClientRect();if(e!==document.body){const{x:t,y:o}=function(t,e,i){const s=16,o=i.left+t.scrollLeft-e.left-s,r=i.right+t.scrollLeft-e.left+s,n=i.top+t.scrollTop-e.top-s,l=i.bottom+t.scrollTop-e.top+s,a=t.clientWidth,h=t.clientHeight;var d=t.scrollLeft,c=t.scrollTop;r-o-2*s>a?d=o:r>t.scrollLeft+a?d=r-a:o<t.scrollLeft&&(d=o);l-n-2*s>h?c=n:l>t.scrollTop+h?c=l-h:n<t.scrollTop&&(c=n);return d=Math.max(0,d),c=Math.max(0,c),{x:d,y:c}}(e,i,s);!function(t,e,i){let s,o,r=Mi.get(t);void 0===r?(r={x:e,y:i},Mi.set(t,r)):(r.x=e,r.y=i);t===document.body?(s=window.scrollX||window.pageXOffset,o=window.scrollY||window.pageYOffset):(s=t.scrollLeft,o=t.scrollTop);const n=e-s,l=i-o;if(0===n&&0===l)return void Mi.delete(t);a=a=>{if(r.x!==e||r.y!==i)return!1;const h=s+a*n,d=o+a*l;return t===document.body?window.scrollTo(h,d):(t.scrollLeft=h,t.scrollTop=d),1===a&&Mi.delete(t),!0},setTimeout((()=>{window.requestAnimationFrame(Bi.bind(window,a,void 0,void 0))}),0);var a}(e,t,o),"fixed"!==window.getComputedStyle(e).position&&window.scrollBy({left:i.left,top:i.top,behavior:"smooth"})}else window.scrollBy({left:s.left,top:s.top,behavior:"smooth"})}const Mi=new Map;let Pi=0;function Bi(t,e,i){void 0===e&&(e=Date.now(),i=++Pi);let s=(Date.now()-e)/468;s=s>1?1:s;const o=(r=s,.5*(1-Math.cos(Math.PI*r)));var r;!1!==t(o)&&o<1&&window.requestAnimationFrame(Bi.bind(window,t,e,i))}var Hi,Gi,Vi,Fi=(Hi=window.navigator.userAgent,new RegExp(["MSIE ","Trident/","Edge/"].join("|")).test(Hi)?1:0);function $i(t){for(;t!==document.body&&!1===Ui(t);){if(null===t.parentElement)return;t=t.parentElement}return t}function Ui(t){const e=Wi(t,"Y")&&zi(t,"Y"),i=Wi(t,"X")&&zi(t,"X");return e||i}function Wi(t,e){return"X"===e?t.clientWidth+Fi<t.scrollWidth:t.clientHeight+Fi<t.scrollHeight}function zi(t,e){const i=window.getComputedStyle(t,null)["overflow"+e];return"auto"===i||"scroll"===i}class ji extends Ge{isEmpty(){return 0===this.colCount&&0===this.rowCount}}!function(t){t[t.EDIT_CELL=0]="EDIT_CELL",t[t.SELECT_CELL=1]="SELECT_CELL",t[t.SELECT_ROW=2]="SELECT_ROW"}(Gi||(Gi={}));class Yi{constructor(t,e){this.col=t,this.row=e}}class qi extends Ge{constructor(t=Gi.EDIT_CELL){super(),this.mode=t,this._value=new Yi(0,0)}set col(t){this._value.col!==t&&(this._value.col=t,this.modified.trigger())}get col(){return this._value.col}set row(t){this._value.row!==t&&(this._value.row=t,this.modified.trigger())}get row(){return this._value.row}set value(t){this._value.col===t.col&&this._value.row===t.row||(this._value=t,this.modified.trigger())}get value(){return this._value}}class Ki extends ji{constructor(t,e){super(),this.nodeClass=t}}class Xi{get colCount(){return void 0===this.model?0:this.model.colCount}get rowCount(){return void 0===this.model?0:this.model.rowCount}setModel(t){this.model=t}getColumnHead(t){}getRowHead(t){}getDisplayCell(t,e){}getEditorCell(t,e){}isViewCompact(){return!1}static register(t,e,i){let s=Xi.modelToAdapter.get(e);if(void 0===s&&(s=new Map,Xi.modelToAdapter.set(e,s)),void 0!==s.get(i))throw Error("attempt to redefine existing table adapter");s.set(i,t)}static unbind(){Xi.modelToAdapter.clear()}static lookup(t){let e;e=t instanceof Ki?t.nodeClass:void 0;let i=Xi.modelToAdapter.get(Object.getPrototypeOf(t).constructor)?.get(e);if(void 0===i)for(let s of Xi.modelToAdapter.keys())if(t instanceof s){i=Xi.modelToAdapter.get(s)?.get(e);break}if(void 0===i){let i=`TableAdapter.lookup(): Did not find an adapter for model of type ${t.constructor.name}`;i+=`\n    Requested adapter: model=${t.constructor.name}, type=${e.name}\n    Available adapters:`;for(const[t,e]of Xi.modelToAdapter)for(const[s,o]of e)i+=`\n        model=${t.name}, type=${s}`;throw Error(i)}return i}}Xi.modelToAdapter=new Map,function(t){t[t.INSERT_ROW=0]="INSERT_ROW",t[t.REMOVE_ROW=1]="REMOVE_ROW",t[t.INSERT_COL=2]="INSERT_COL",t[t.REMOVE_COL=3]="REMOVE_COL",t[t.CELL_CHANGED=4]="CELL_CHANGED",t[t.RESIZE_ROW=5]="RESIZE_ROW",t[t.RESIZE_COL=6]="RESIZE_COL",t[t.CHANGED=7]="CHANGED"}(Vi||(Vi={}));let Ji=document.createElement("style");Ji.textContent="\n:host {\n  position: relative;\n  display: inline-block;\n  border: 1px #ccc solid;\n  border-radius: 3px;\n  outline-offset: -2px;\n  font-family: var(--toad-font-family, sans-serif);\n  font-size: var(--toad-font-size, 12px);\n  background: #fff;\n}\n:host:focus .cells tr.selected,\n:host:focus .cells td.selected {\n  background: #0069d4;\n  color: #fff;\n}\n\n.colhead {\n  position: absolute;\n  top: 0;\n  overflow: hidden;\n}\n.rowhead {\n  position: absolute;\n  left: 0;\n  overflow: hidden;\n}\n.cells {\n  position: absolute;\n\n  bottom: 0;\n  right: 0;\n\n  overflow: auto;\n  /* resize: both; */\n  cursor: default;\n}\n\n:host > div > table, :host > table {\n  border-collapse: collapse;\n  border-spacing: 0;\n  border: none 0px;\n}\n.colhead > table, .rowhead > table {\n  background: #e0e0e0;\n}\n\n.colhead th,\n.rowhead th,\n.cells td,\n.hiddenSizeCheck td {\n  letter-spacing: 0;  \n  overflow: hidden;   \n  padding: 2px;\n  margin: 0px;\n\n  /* this might not be always desirable; */\n  white-space: nowrap; \n\n  border: solid 1px #ccc;\n}\n\n.colhead th, .rowhead th {\n  z-index: 1;\n}\n\n.bodyrow td {\n  padding-top: 0px;\n  padding-bottom: 0px;\n  border-top: none 0px;\n  border-bottom: none 0px;\n}\n\n.cells tr:nth-child(even) {\n  background: var(--toad-table-even-row, #f5f5f5);\n}\n.cells tr:nth-child(odd) {\n  background: var(--toad-table-odd-row, #ffffff);\n}\n\n.cells td:nth-child(1) {\n  border-left: none;\n}\n.cells tr:nth-child(2) td {\n  border-top: none;\n}\n\n.cells tr.selected,\n.cells tr td.selected {\n  background: #808080;\n  color: #fff;\n}\n\n.compact.colhead th,\n.compact.rowhead th,\n.compact.hiddenSizeCheck * th {\n  border-color: none;\n  border-style: none;\n  border-width: 0;\n  padding: 0px;\n}\n.compact.cells * td,\n.compact.hiddenSizeCheck * td {\n  border-color: none;\n  border-style: none;\n  border-width: 0;\n  padding: 0px;\n}\n\n.zeroSize {\n  width: 0;\n  height: 0;\n  margin: 0;\n  padding: 0;\n  border: none;\n}\n\n.inputDiv { \n  position: relative;\n  background: #fff;\n  border: none;\n  opacity: 0;\n}\n\n.hiddenSizeCheck {\n  position: absolute;\n  opacity: 0;\n}\n";class Zi extends HTMLDivElement{static init(t){t.addEventListener("focusin",(e=>{if(t.style.opacity="1",e.target&&e.relatedTarget)try{!function(t,e){let i,s=t;i=t;let o=new Map;for(;s=i,i=i.parentNode,i;)o.set(i,s);let r=e;for(i=e;i;){if(r=i,i=i.parentNode,!i)throw Error("isNodeBeforeNode(first, second): nodes have no common parent");let t=o.get(i);if(t){s=t;break}}for(let t of i.childNodes){if(t===s)return!0;if(t===r)return!1}throw Error("isNodeBeforeNode(first, second): couldn't determine order of nodes")}(e.relatedTarget,t)?t.focusInFromRight&&t.focusInFromRight():t.focusInFromLeft&&t.focusInFromLeft()}catch(t){}})),t.addEventListener("focusout",(e=>{t.style.opacity="0"})),t.style.display="none",t.setViewRect=Zi.prototype.setViewRect,t.unsetViewRect=Zi.prototype.unsetViewRect,t.setEditView=Zi.prototype.setEditView,t.adjustToCell=Zi.prototype.adjustToCell}setEditView(t){const e=$i(this);let i=0,s=0;void 0!==e&&([i,s]=[e.scrollLeft,e.scrollTop]),this.hasChildNodes()?(function(t){if(!document.hasFocus())return!1;let e=document.activeElement;for(;null!==e;){if(e===t)return!0;if(null===e.shadowRoot)break;e=e.shadowRoot.activeElement}return!1}(this.children[0])&&this.children[0].dispatchEvent(new FocusEvent("blur")),t?this.replaceChild(t,this.childNodes[0]):this.removeChild(this.childNodes[0])):t&&this.appendChild(t),this.style.display=t?"":"none",void 0!==e&&(e.scrollLeft=i,e.scrollTop=s)}adjustToCell(t){if(!this.hasChildNodes())return void this.unsetViewRect();if(void 0===t)return;let e=t.getBoundingClientRect(),i=t.parentElement;if(null===i)return;let s,o,r=i.parentElement;if(null===r)return;navigator.userAgent.indexOf("Chrome")>-1?(o=t.offsetLeft+2,s=t.offsetTop-r.clientHeight):(o=t.offsetLeft+.5,s=t.offsetTop-r.clientHeight);const n=t.clientWidth-Je(t),l=e.height;this.setViewRect(s,o,n,l)}setViewRect(t,e,i,s){this.style.display="",this.style.opacity="1",this.style.top=`${t}px`,this.style.left=`${e}px`,this.style.width=`${i}px`,this.style.height=`${s}px`}unsetViewRect(){this.style.opacity="0",this.style.display="none",this.style.top="",this.style.left="",this.style.width="",this.style.height=""}}var Qi,ts,es,is,ss;!function(t){t[t.BEFORE_REMOVED_AREA=0]="BEFORE_REMOVED_AREA",t[t.INSIDE_REMOVED_AREA=1]="INSIDE_REMOVED_AREA",t[t.INSIDE_REMOVED_AREA_AND_NO_FURTHER_ROWS=2]="INSIDE_REMOVED_AREA_AND_NO_FURTHER_ROWS",t[t.BEHIND_REMOVED_AREA=3]="BEHIND_REMOVED_AREA"}(Qi||(Qi={}));class os extends oi{constructor(t,e){super(),this.rowAnimationHeight=0,this.hadFocus=!1,this.table=t,this.event=e}prepare(){this.hadFocus=this.table.hasFocus();let t=0;if(this.table.editView&&void 0!==this.table.selectionModel)if(this.table.selectionModel.row<this.event.index)this.selectionIs=Qi.BEFORE_REMOVED_AREA;else if(this.table.selectionModel.row<=this.event.index+this.event.size){const e=this.table.bodyBody.children.length-1;if(this.event.index+this.event.size>=e){this.selectionIs=Qi.INSIDE_REMOVED_AREA_AND_NO_FURTHER_ROWS;for(let e=this.event.index;e<=this.table.selectionModel.row;++e){t-=this.table.bodyBody.children[e+1].clientHeight}0===this.event.index?this.table.selectionModel.row=0:this.table.selectionModel.row=this.event.index-1}else{this.selectionIs=Qi.INSIDE_REMOVED_AREA;for(let e=this.event.index+1;e<=this.table.selectionModel.row;++e){t-=this.table.bodyBody.children[e+1].clientHeight}this.table.selectionModel.row=this.event.index,this.table.prepareInputOverlayForPosition({col:this.table.selectionModel.value.col,row:this.table.selectionModel.value.row})}}else this.table.selectionModel.row-=this.event.size,this.selectionIs=Qi.BEHIND_REMOVED_AREA;this.rowAnimationHeight=0;for(let t=0;t<this.event.size;++t){const e=this.table.bodyBody.children[this.event.index+t+1];this.rowAnimationHeight+=e.clientHeight}this.table.rowAnimationHeight=this.rowAnimationHeight;for(let t=1;t<this.event.size;++t)this.table.rowHeadHead.deleteRow(this.event.index+1),this.table.bodyBody.deleteRow(this.event.index+2);this.trAnimationHead=this.table.rowHeadHead.children[this.event.index],this.trAnimationBody=this.table.bodyBody.children[this.event.index+1],this.trAnimationHead.style.minHeight=this.trAnimationHead.style.maxHeight="",this.trAnimationBody.style.minHeight=this.trAnimationBody.style.maxHeight="",this.trAnimationHead.style.height=`${this.rowAnimationHeight}px`,this.trAnimationBody.style.height=`${this.rowAnimationHeight}px`;const e="url(\"data:image/svg+xml;utf8,<svg width='3' height='3' xmlns='http://www.w3.org/2000/svg'><line shape-rendering='crispEdges' x1='-1' y1='-1' x2='5' y2='5' stroke='%23888' /></svg>\")";for(;this.trAnimationHead.childNodes.length>0;)this.trAnimationHead.removeChild(this.trAnimationHead.childNodes[0]);for(;this.trAnimationBody.childNodes.length>0;)this.trAnimationBody.removeChild(this.trAnimationBody.childNodes[0]);this.trAnimationHead.appendChild(Le("th",{style:{padding:"0"}})),this.trAnimationHead.style.background=e;for(let t=0;t<this.table.adapter.colCount;++t)this.trAnimationBody.appendChild(Le("td",{style:{padding:"0"}})),this.trAnimationBody.style.background=e;const i=this.table.inputOverlay.style.top;i.length>2&&(this.overlayTop=Number.parseFloat(i.substr(0,i.length-2))+t)}animationFrame(t){const e=1-t;if(this.trAnimationBody.style.height=this.trAnimationHead.style.height=e*this.rowAnimationHeight+"px",this.overlayTop)switch(this.selectionIs){case Qi.BEFORE_REMOVED_AREA:this.table.inputOverlay.style.top=`${this.overlayTop+t*this.rowAnimationHeight}px`;break;case Qi.INSIDE_REMOVED_AREA:this.table.inputOverlay.style.top=`${this.overlayTop+this.rowAnimationHeight}px`;break;case Qi.INSIDE_REMOVED_AREA_AND_NO_FURTHER_ROWS:this.table.inputOverlay.style.top=`${this.overlayTop+t*this.rowAnimationHeight}px`;break;case Qi.BEHIND_REMOVED_AREA:this.table.inputOverlay.style.top=`${this.overlayTop}px`}}lastFrame(){this.table.rowHeadHead.deleteRow(this.event.index),this.table.bodyBody.deleteRow(this.event.index+1)}}class rs extends oi{constructor(t,e){super(),this.rowAnimationHeight=0,this.trHead=[],this.trBody=[],this.table=t,this.event=e}prepare(){for(let t=0;t<this.event.size;++t){const e=this.table.createDOMRowHeaderRow(this.event.index);this.table.hiddenSizeCheckRowHead.appendChild(e),this.trHead.push(e);const i=this.table.createDOMBodyRow(this.event.index+t);this.table.hiddenSizeCheckBody.appendChild(i),this.trBody.push(i)}const t="url(\"data:image/svg+xml;utf8,<svg width='3' height='3' xmlns='http://www.w3.org/2000/svg'><line shape-rendering='crispEdges' x1='-1' y1='-1' x2='5' y2='5' stroke='%23888' /></svg>\")";this.trAnimationHead=Le("tr",{style:{height:"0px",background:t},children:Le("th",{style:{padding:"0"}})}),this.table.rowHeadHead.insertBefore(this.trAnimationHead,this.table.rowHeadHead.children[this.event.index]),this.trAnimationBody=Le("tr",{style:{height:"0px",background:t}});for(let e=0;e<this.table.adapter.colCount;++e)this.trAnimationBody.appendChild(Le("td",{style:{padding:"0"}})),this.trAnimationBody.style.background=t;this.table.bodyBody.insertBefore(this.trAnimationBody,this.table.bodyBody.children[this.event.index+1])}firstFrame(){this.table.rowAnimationHeight=this.rowAnimationHeight=Math.max(this.table.hiddenSizeCheckBody.clientHeight,this.table.hiddenSizeCheckRowHead.clientHeight)}animationFrame(t){const e=`${Math.round(t*this.rowAnimationHeight)}px`;if(this.trAnimationHead.style.height=this.trAnimationBody.style.height=e,void 0!==this.table.selectionModel&&this.table.selectionModel.row<this.event.index){const t=this.table.getCellAt(this.table.selectionModel.value.col,this.table.selectionModel.value.row);this.table.inputOverlay.adjustToCell(t)}}lastFrame(){for(let t=0;t<this.event.size;++t){const e=`${Math.max(this.trHead[t].clientHeight,this.trBody[t].clientHeight)}px`,i=this.trHead[t].style;i.height=i.minHeight=i.maxHeight=e;const s=this.trHead[t].style;s.height=s.minHeight=s.maxHeight=e}this.table.rowHeadHead.replaceChild(this.trHead[0],this.trAnimationHead),this.table.bodyBody.replaceChild(this.trBody[0],this.trAnimationBody);for(let t=1;t<this.event.size;++t)this.table.rowHeadHead.insertBefore(this.trHead[t],this.trHead[t-1].nextSibling),this.table.bodyBody.insertBefore(this.trBody[t],this.trBody[t-1].nextSibling);if(void 0!==this.table.selectionModel&&this.table.selectionModel.row>=this.event.index&&(this.table.selectionModel.row+=this.event.size),this.table.editView&&void 0!==this.table.selectionModel&&this.table.selectionModel.row<this.event.index){const t=this.table.getCellAt(this.table.selectionModel.value.col,this.table.selectionModel.value.row);this.table.inputOverlay.adjustToCell(t)}this.table.adjustLayout(void 0)}}!function(t){t[t.LAYOUT=0]="LAYOUT",t[t.SELECTION=1]="SELECTION",t[t.USER=2]="USER"}(ts||(ts={}));class ns extends ai{constructor(t){super(),this.animator=new ri,this.rowAnimationHeight=0,this.insideGoTo=!1,this.rootDiv=Me(De,{children:[Le("div",{set:ke(this,"rowHeadDiv"),class:"rowhead",children:Le("table",{set:ke(this,"rowHeadTable"),children:Le("thead",{set:ke(this,"rowHeadHead")})})}),Le("div",{set:ke(this,"colHeadDiv"),class:"colhead",children:Le("table",{set:ke(this,"colHeadTable"),children:Le("thead",{children:Le("tr",{set:ke(this,"colHeadRow")})})})}),Me("div",{set:ke(this,"scrollDiv"),class:"cells",children:[Le("table",{set:ke(this,"bodyTable"),children:Le("tbody",{set:ke(this,"bodyBody"),children:Le("tr",{set:ke(this,"bodyRow"),class:"bodyrow"})})}),Le("div",{class:"zeroSize",children:Le("div",{set:ke(this,"inputOverlay"),class:"inputDiv"})})]}),Me("table",{class:"hiddenSizeCheck",children:[Le("thead",{set:ke(this,"hiddenSizeCheckRowHead")}),Le("tbody",{set:ke(this,"hiddenSizeCheckBody")})]})]}),this.onkeydown=this.onRootDivKeyDown,this.scrollDiv.onscroll=()=>{this.rowHeadDiv.scrollTop=this.scrollDiv.scrollTop,this.colHeadDiv.scrollLeft=this.scrollDiv.scrollLeft},this.bodyTable.onmousedown=t=>{t.target?"TD"===t.target.tagName?(t.preventDefault(),this.log(ts.USER,"bodyTable.onmousedown() -> goToCell(event.target)"),this.goToCell(t.target)):console.log(`bodyTable.onmousedown() -> target is not TD but ${t.target.tagName}`):console.log("bodyTable.onmousedown() -> no target")},Zi.init(this.inputOverlay),this.inputOverlay.focusInFromLeft=()=>{this.insideGoTo||this.goToFirstCell()},this.inputOverlay.focusInFromRight=()=>{this.insideGoTo||this.goToLastCell()},this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(Ji,!0)),this.rootDiv.appendTo(this.shadowRoot),t&&(Pe(this,t),t.selectionModel&&this.setModel(t.selectionModel))}log(t,e){}setModel(t){if(!t)return this.selectionModel&&this.selectionModel.modified.remove(this),this.model=void 0,this.selectionModel=new qi,this.selectionModel.modified.add((()=>{this.createSelection()}),this),void this.updateView();if(t instanceof qi)return this.selectionModel&&this.selectionModel.modified.remove(this),this.selectionModel=t,this.createSelection(),void this.selectionModel.modified.add((()=>{this.createSelection()}),this);if(t instanceof ji){this.model=t,this.model.modified.add((t=>{this.modelChanged(t)}),this);const e=Xi.lookup(t);try{this.adapter=new e}catch(t){throw console.log(`TableView.setModel(): failed to instantiate table adapter: ${t}`),console.log("setting TypeScript's target to 'es6' might help"),t}return this.adapter.setModel(t),this.updateCompact(),void this.updateView()}if(t instanceof Object)throw Error("TableView.setModel(): unexpected model of type "+t.constructor.name)}updateCompact(){this.adapter?.isViewCompact()?this.rootDiv.forEach((t=>t.classList.add("compact"))):this.rootDiv.forEach((t=>t.classList.remove("compact")))}modelChanged(t){switch(t.type){case Vi.INSERT_ROW:this.animator.run(new rs(this,t));break;case Vi.REMOVE_ROW:this.animator.run(new os(this,t));break;case Vi.CELL_CHANGED:this.onFieldViewBlur(new Yi(t.col,t.row))}}updateView(){try{if(!this.model)return;this.createColumnHeader(),this.createRowHeader(),this.createBody(),this.createSelection(),setTimeout((()=>{this.model&&this.adjustLayoutAfterRender()}),0)}catch(t){throw console.log("caught exception in updateView"),t instanceof Error&&console.log(t.stack),t}}createColumnHeader(){this.updateHeader(!0)}createRowHeader(){this.updateHeader(!1)}updateHeader(t){if(!this.model)throw Error("TableView.updateHeader(): no model");if(!this.adapter)throw Error("TableView.updateHeader(): no adapter");let e,i,s;!0===t?(e=this.colHeadTable,i=this.colHeadRow,s=this.adapter.colCount):(e=this.rowHeadTable,i=this.rowHeadHead,s=this.adapter.rowCount);let o,r=!1;for(;i.children.length>s+1;)i.removeChild(i.children[i.children.length-1]);for(let e=0;e<s;++e){let s;if(e>=i.children.length)if(s=Le("th",{}),t)i.appendChild(s);else{const t=Le("tr",{});t.appendChild(s),i.appendChild(t)}else s=t?i.children[e]:i.children[e].children[0],s.style.minWidth="",s.style.border="";const o=t?this.adapter.getColumnHead(e):this.adapter.getRowHead(e);void 0!==o?s.appendChild(o):r=!0}if(i.children.length<s+1)if(o=Le("th",{}),t)i.appendChild(o);else{const t=Le("tr",{});t.appendChild(o),i.appendChild(t)}else o=t?i.children[i.children.length-1]:i.children[i.children.length-1].children[0];t?(o.innerText="",o.style.minWidth="777px"):o.parentElement.style.height="777px",o.style.border="0px none",e.style.display=r?"none":""}createBody(){if(!this.model)throw Error("TableView.updateBody(): no model");if(!this.adapter)throw Error("TableView.updateBody(): no adapter");for(;this.bodyRow.children.length>this.adapter.colCount;)this.bodyRow.removeChild(this.bodyRow.children[this.bodyRow.children.length-1]);for(;this.bodyRow.children.length<this.adapter.colCount;)this.bodyRow.appendChild(Le("td",{}));for(;this.bodyBody.children.length-1>this.adapter.rowCount;)this.bodyBody.removeChild(this.bodyBody.children[this.bodyBody.children.length-1]);for(let t=0;t<this.adapter.rowCount;++t){let e;for(t+1>=this.bodyBody.children.length?(e=Le("tr",{}),this.bodyBody.appendChild(e)):e=this.bodyBody.children[t+1];e.children.length>this.adapter.colCount;)e.removeChild(e.children[e.children.length-1]);for(let i=0;i<this.adapter.colCount;++i){let s;i>=e.children.length?(s=Le("td",{}),e.appendChild(s)):s=e.children[i],s.style.width="";const o=this.adapter.getDisplayCell(i,t);o&&(Array.isArray(o)?o.forEach((t=>s.appendChild(t))):s.appendChild(o))}if("100%"===this.style.width){e.children[e.children.length-1].style.width="100%"}}}createDOMRowHeaderRow(t){if(!this.model||!this.adapter)throw Error();const e=this.adapter.getRowHead(t);return Le("tr",void 0===e?{}:{children:Le("th",{children:e})})}createDOMBodyRow(t){if(!this.model||!this.adapter)throw Error();const e=Le("tr",{});for(let i=0;i<this.adapter.colCount;++i){let s;i>=e.children.length?(s=Le("td",{}),e.appendChild(s)):s=e.children[i],s.style.width="";const o=this.adapter.getDisplayCell(i,t);o&&(Array.isArray(o)?o.forEach((t=>s.appendChild(t))):s.appendChild(o))}if("100%"===this.style.width){e.children[e.children.length-1].style.width="100%"}return e}createSelection(){if(void 0!==this.selectionModel)switch(this.selectionModel.mode){case Gi.EDIT_CELL:this.log(ts.SELECTION,`TableView.createSelection(): mode=EDIT_CELL, selection=${this.selectionModel.col}, ${this.selectionModel.row}`),this.prepareInputOverlayForPosition(new Yi(this.selectionModel.col,this.selectionModel.row)),delete this.rootDiv.tabIndex;break;case Gi.SELECT_CELL:{this.log(ts.SELECTION,`TableView.createSelection(): mode=SELECT_CELL, selection=${this.selectionModel.col}, ${this.selectionModel.row}`);let t=this.bodyBody.querySelectorAll("tbody > tr > td.selected");for(let e of t)e.classList.remove("selected");this.toggleCellSelection(this.selectionModel.value,!0),this.tabIndex=0;break}case Gi.SELECT_ROW:{this.log(ts.SELECTION,`TableView.createSelection(): mode=SELECT_ROW, selection=${this.selectionModel.col}, ${this.selectionModel.row}`);let t=this.bodyBody.querySelectorAll("tbody > tr.selected");for(let e of t)e.classList.remove("selected");this.toggleRowSelection(this.selectionModel.value.row,!0),this.tabIndex=0;break}}}adjustLayout(t){this.unadjustLayoutBeforeRender(t),setTimeout((()=>{this.adjustLayoutAfterRender()}),0)}unadjustLayoutBeforeRender(t){if(void 0===t)for(let t=0;t<this.adapter.colCount;++t)this.unadjustLayoutColumnBeforeRender(t);else this.unadjustLayoutColumnBeforeRender(t.col)}unadjustLayoutColumnBeforeRender(t){const e=this.colHeadRow.children[t],i=this.bodyRow.children[t];e.style.width=e.style.minWidth=e.style.maxWidth=i.style.width=i.style.minWidth=i.style.maxWidth=""}adjustLayoutAfterRender(){if(!this.model)throw Error("TableView.adjustLayoutAfterRender(): no model");if(!this.adapter)throw Error("TableView.adjustLayoutAfterRender(): no adapter");this.log(ts.LAYOUT,"TableView.adjustLayoutAfterRender()");const t=this.colHeadRow.children,e=this.rowHeadHead.children,i=this.bodyRow.children;for(let e=0;e<this.adapter.colCount;++e){const s=t[e],o=i[e];if(""===s.style.width){const t=s.getBoundingClientRect().width-Je(s),e=o.getBoundingClientRect().width-Je(o),i=Math.max(t,e);s.style.width=s.style.minWidth=s.style.maxWidth=`${i}px`,o.style.width=o.style.minWidth=o.style.maxWidth=`${i}px`}}this.adapter.rowCount!=this.bodyBody.children.length-1&&this.log(ts.LAYOUT,`adjustLayoutAfterRender(): bodyBody has ${this.bodyBody.children.length-1} rows while model has ${this.adapter.rowCount} rows`);for(let t=0;t<this.bodyBody.children.length-1;++t){const i=e[t],s=this.bodyBody.children[t+1];let o=i.clientHeight-Ze(i),r=s.clientHeight-Ze(s),n=Math.max(o,r);i.style.height=i.style.minHeight=i.style.maxHeight=s.style.height=s.style.minHeight=s.style.maxHeight=`${n}px`}const s=this.colHeadDiv.getBoundingClientRect(),o=this.rowHeadDiv.getBoundingClientRect();let r=this.scrollDiv.getBoundingClientRect(),n=this.bodyTable.getBoundingClientRect();const l=window.getComputedStyle(this),a=l.width,h=l.height;this.style.overflowX="",this.style.overflowY="";let d=!1,c=!1;if("0px"===a){this.log(ts.LAYOUT,"  TableView has no width specified");const t=this.parentElement;if(t){const e=o.width+n.width;e<t.clientWidth?(this.log(ts.LAYOUT,`    parent is wide enough for content, set TableView width to ${e}px`),this.style.width=e+"px",this.scrollDiv.style.overflowX="hidden",d=!0):(this.log(ts.LAYOUT,`    parent isn't wide enough for content, set TableView width to parent's width of ${t.clientWidth-2}px`),this.style.width=t.clientWidth-2+"px")}}if("0px"===h){this.log(ts.LAYOUT,"  TableView has no height specified");if(this.parentElement){let t=s.height+n.height;d||(t+=15);const e=window.innerHeight;t<e?(this.log(ts.LAYOUT,`    parent IS high enough for content, set TableView height to ${t}px`),this.style.height=t+"px",this.scrollDiv.style.overflowY="hidden",c=!0):(this.log(ts.LAYOUT,`    parent is NOT high enough for content, default TableView height to ${e}px`),this.style.height=e+"px")}}let u=this.getBoundingClientRect();this.clientLeft,u.x,this.clientTop,u.y;const g=this.clientWidth,f=this.clientHeight;this.log(ts.LAYOUT,"  adjust the bodyDiv to setup the scrollbars"),d?(this.log(ts.LAYOUT,"    table IS wide enough for content, do not set scrollDiv's width"),this.scrollDiv.style.width=""):(this.log(ts.LAYOUT,`    table is NOT wide enough for content, set scroll width to ${g-o.width}px`),this.scrollDiv.style.width=g-o.width+"px"),c?(this.log(ts.LAYOUT,"    table IS heigh enough for content, do not set scrollDiv's height"),this.scrollDiv.style.height=""):(this.log(ts.LAYOUT,`    table is NOT high enough for content, set scroll height to ${f-s.height}px`),this.scrollDiv.style.height=f-s.height+"px"),this.log(ts.LAYOUT,"  figure out how much space the scrollbars take"),r=this.scrollDiv.getBoundingClientRect();let p=c?0:r.width-this.scrollDiv.clientWidth,m=d?0:r.height-this.scrollDiv.clientHeight;this.log(ts.LAYOUT,`    width ${p}, height ${m}`),this.scrollDiv.style.top=s.height+"px",this.scrollDiv.style.left=o.width+"px",this.colHeadDiv.style.top="0",this.colHeadDiv.style.left=o.width-1+"px",this.log(ts.LAYOUT,`  set colHeadDiv = ${g} (host width) - ${o.width} (rowHeadDiv width) - ${p} (vertical scrollbar width) = ${g-o.width-p+1}`),this.colHeadDiv.style.width=g-o.width-p+1+"px",this.rowHeadDiv.style.top=s.height+"px",this.rowHeadDiv.style.left="0",this.rowHeadDiv.style.height=f-s.height-m+"px"}prepareInputOverlayForCell(t){void 0!==t&&"TD"===t.tagName&&this.prepareInputOverlayForPosition(this.getCellPosition(t))}prepareInputOverlayForPosition(t){if(!this.adapter)return;let e=this.hasFocus();this.log(ts.USER,`TableView.prepareInputOverlayForPosition(${t.col}, ${t.row})`),this.setSelectionTo(t);let i=this.adapter.getEditorCell(t.col,t.row);if(this.log(ts.SELECTION,`prepareInputOverlayForPosition() got editView=${i}`),!i)return void this.inputOverlay.setEditView(void 0);this.editView=i,i.classList.add("embedded"),i.onkeydown=e=>{this.onFieldViewKeyDown(e,t)},this.inputOverlay.setEditView(i);const s=this.getCellAt(t.col,t.row);setTimeout((()=>{this.inputOverlay.adjustToCell(s),e&&this.focus()}),0)}setSelectionTo(t){if(this.selectionModel)switch(this.selectionModel.mode){case Gi.EDIT_CELL:this.selectionModel.value=t;break;case Gi.SELECT_CELL:return this.toggleCellSelection(this.selectionModel.value,!1),this.selectionModel.value=t,void this.toggleCellSelection(this.selectionModel.value,!0);case Gi.SELECT_ROW:return this.toggleRowSelection(this.selectionModel.value.row,!1),this.selectionModel.value.row=t.row,void this.toggleRowSelection(this.selectionModel.value.row,!0)}}focus(){const{x:t,y:e}={x:this.scrollDiv.scrollLeft,y:this.scrollDiv.scrollTop};this.editView?this.editView.focus({preventScroll:!0}):super.focus({preventScroll:!0}),this.scrollDiv.scrollLeft=t,this.scrollDiv.scrollTop=e}hasFocus(){return null!==document.activeElement&&document.activeElement===this}toggleCellSelection(t,e){if(t.col>=this.adapter.colCount||t.row>=this.adapter.rowCount)return;let i=this.bodyBody.children[t.row+1].children[t.col];i.classList.toggle("selected",e),e&&Li(i)}toggleRowSelection(t,e){if(t>=this.adapter.rowCount)return;let i=this.bodyBody.children[1+this.selectionModel.value.row];i.classList.toggle("selected",e),e&&Li(i)}goTo(t,e){this.insideGoTo=!0,this.prepareInputOverlayForPosition(new Yi(t,e)),this.focus(),Li(this.getCellAt(t,e)),this.insideGoTo=!1}goToCell(t){t&&(this.insideGoTo=!0,this.prepareInputOverlayForCell(t),this.focus(),Li(t),this.insideGoTo=!1)}goToFirstCell(){this.goTo(0,0)}goToLastCell(){this.adapter&&this.goTo(this.adapter.colCount-1,this.adapter.rowCount-1)}getCellAt(t,e){return this.bodyBody.children[e+1].children[t]}getCellPosition(t){let e,i;for(e=0;e<this.adapter.colCount&&t.parentElement.children[e]!==t;++e);for(i=1;i<this.adapter.rowCount+1&&t.parentElement.parentElement.children[i]!==t.parentElement;++i);return--i,new Yi(e,i)}onRootDivKeyDown(t){if(this.selectionModel)switch(this.selectionModel.mode){case Gi.SELECT_ROW:{let e=this.selectionModel.value.row;switch(t.key){case"ArrowDown":e+1<this.adapter.rowCount&&++e;break;case"ArrowUp":e>0&&--e}e!=this.selectionModel.value.row&&(this.toggleRowSelection(this.selectionModel.value.row,!1),this.selectionModel.row=e,this.toggleRowSelection(this.selectionModel.value.row,!0))}break;case Gi.SELECT_CELL:{let e={col:this.selectionModel.col,row:this.selectionModel.row};switch(t.key){case"ArrowRight":e.col+1<this.adapter.colCount&&++e.col;break;case"ArrowLeft":e.col>0&&--e.col;break;case"ArrowDown":e.row+1<this.adapter.rowCount&&++e.row;break;case"ArrowUp":e.row>0&&--e.row}e.col==this.selectionModel.col&&e.row==this.selectionModel.row||(this.toggleCellSelection(this.selectionModel.value,!1),this.selectionModel.value=e,this.toggleCellSelection(this.selectionModel.value,!0))}}}onFieldViewKeyDown(t,e){switch(t.key){case"ArrowDown":if(e.row+1>=this.adapter.rowCount)break;t.preventDefault(),this.goTo(e.col,e.row+1);break;case"ArrowUp":if(0===e.row)break;t.preventDefault(),this.goTo(e.col,e.row-1);break;case"Tab":t.shiftKey?e.col>0?(t.preventDefault(),this.goTo(e.col-1,e.row)):e.row>0&&(t.preventDefault(),this.goTo(this.adapter.colCount-1,e.row-1)):e.col+1<this.adapter.colCount?(t.preventDefault(),this.goTo(e.col+1,e.row)):e.row+1<this.adapter.rowCount&&(t.preventDefault(),this.goTo(0,e.row+1))}}onFieldViewBlur(t){const e=this.getCellAt(t.col,t.row);if(void 0===e)return;const i=this.adapter.getDisplayCell(t.col,t.row),s=document.createElement("div");if(Array.isArray(i)?i.forEach((t=>s.appendChild(t))):s.appendChild(i),this.log(ts.USER,`TableView.onFieldViewBlur(${t.col}, ${t.row}): change "${e.innerHTML}" to "${s.innerHTML}"`),s.innerHTML!=e.innerHTML){for(this.log(ts.USER,`TableView.onFieldViewBlur(${t.col}, ${t.row})"): cell is now "${e.innerHTML}"`);e.childNodes.length>0;)e.removeChild(e.childNodes[e.childNodes.length-1]);this.log(ts.USER,`TableView.onFieldViewBlur(${t.col}, ${t.row})"): cleared cell, it's now "${e.innerHTML}"`),Array.isArray(i)?i.forEach((t=>e.appendChild(t))):e.appendChild(i),this.log(ts.USER,`TableView.onFieldViewBlur(${t.col}, ${t.row})"): cell is now "${e.innerHTML}"`),this.unadjustLayoutBeforeRender(t),setTimeout((()=>{this.adjustLayoutAfterRender()}),0)}}connectedCallback(){super.connectedCallback(),this.resizeEventListener=()=>{try{this.adjustLayoutAfterRender()}catch(t){throw console.log("resizeEventListener caught exception in adjustLayoutAfterRender()"),t}},window.addEventListener("resize",this.resizeEventListener),void 0===this.selectionModel&&(this.selectionModel=new qi,this.selectionModel.modified.add((()=>{this.createSelection()}),this))}disconnectedCallback(){window.removeEventListener("resize",this.resizeEventListener)}}ns.define("toad-table",ns);class ls{constructor(t,e,i){this.type=t,this.index=e,this.size=i}get col(){return this.index}get row(){return this.size}}class as extends Ki{constructor(t,e){super(e),this.data=t}get rowCount(){return this.data?this.data.length:0}createRow(){return new this.nodeClass}insert(t,e){if(t>this.rowCount)throw Error(`ArrayTableModel.insert(${t}) is out of range, model size is ${this.colCount}, ${this.rowCount}`);let i;return void 0===e&&(e=this.createRow()),i=e instanceof Array?e:[e],this.data.splice(t,0,...i),this.modified.trigger(new ls(Vi.INSERT_ROW,t,i.length)),t}remove(t,e=1){if(t>=this.rowCount||t+e>this.rowCount)throw Error(`ArrayTableModel.remove(${t}, ${e}) is out of range, model size is ${this.colCount}, ${this.rowCount}`);return this.data.splice(t,e),this.modified.trigger(new ls(Vi.REMOVE_ROW,t,e)),t}}ai.define("toad-tabletool",class extends bi{constructor(){super(),this.toolbar=Le("div",{class:"toolbar"}),this.buttonAddRowAbove=Le("button",{class:"left",title:"add row above",children:Me("svg",{style:{display:"block"},viewBox:"0 0 13 13",width:"13",height:"13",children:[Le("rect",{x:"0.5",y:"0.5",width:"12",height:"12",class:"strokeFill"}),Le("line",{x1:"0.5",y1:"8.5",x2:"12.5",y2:"8.5",class:"stroke"}),Le("line",{x1:"4.5",y1:"8.5",x2:"4.5",y2:"13.5",class:"stroke"}),Le("line",{x1:"8.5",y1:"8.5",x2:"8.5",y2:"13.5",class:"stroke"}),Le("line",{x1:"6.5",y1:"2",x2:"6.5",y2:"7",class:"stroke"}),Le("line",{x1:"4",y1:"4.5",x2:"9",y2:"4.5",class:"stroke"})]})}),this.buttonAddRowAbove.onclick=()=>{this.lastActiveTable?.focus();const t=this.lastActiveTable?.model,e=this.lastActiveTable?.selectionModel;e&&t&&t instanceof as&&t.insert(e.row)},this.toolbar.appendChild(this.buttonAddRowAbove),this.buttonAddRowBelow=Le("button",{title:"add row below",children:Me("svg",{viewBox:"0 0 13 13",width:"13",height:"13",children:[Le("rect",{x:"0.5",y:"0.5",width:"12",height:"12",class:"strokeFill"}),Le("line",{x1:"0.5",y1:"4.5",x2:"12.5",y2:"4.5",class:"stroke"}),Le("line",{x1:"4.5",y1:"0.5",x2:"4.5",y2:"4.5",class:"stroke"}),Le("line",{x1:"8.5",y1:"0.5",x2:"8.5",y2:"4.5",class:"stroke"}),Le("line",{x1:"6.5",y1:"6",x2:"6.5",y2:"11",class:"stroke"}),Le("line",{x1:"4",y1:"8.5",x2:"9",y2:"8.5",class:"stroke"})]})}),this.buttonAddRowBelow.onclick=()=>{this.lastActiveTable?.focus();const t=this.lastActiveTable?.model,e=this.lastActiveTable?.selectionModel;e&&t&&t instanceof as&&t.insert(e.row+1)},this.toolbar.appendChild(this.buttonAddRowBelow),this.buttonDeleteRow=Le("button",{class:"right",title:"delete row",children:Me("svg",{viewBox:"0 0 13 13",width:"13",height:"13",children:[Le("rect",{x:"0.5",y:"0.5",width:"12",height:"12",class:"strokeFill"}),Le("line",{x1:"0.5",y1:"4.5",x2:"12.5",y2:"4.5",class:"stroke"}),Le("line",{x1:"0.5",y1:"8.5",x2:"12.5",y2:"8.5",class:"stroke"}),Le("line",{x1:"5.5",y1:"3.5",x2:"11.5",y2:"9.5",class:"stroke","stroke-width":"1.5"}),Le("line",{x1:"11.5",y1:"3.5",x2:"5.5",y2:"9.5",class:"stroke","stroke-width":"1.5"})]})}),this.buttonDeleteRow.onclick=()=>{this.lastActiveTable?.focus();const t=this.lastActiveTable?.model,e=this.lastActiveTable?.selectionModel;e&&t&&t instanceof as&&t.remove(e.row)},this.toolbar.appendChild(this.buttonDeleteRow),this.toolbar.appendChild(document.createTextNode(" ")),this.buttonAddColumnLeft=Le("button",{class:"left",title:"add column left",children:Me("svg",{viewBox:"0 0 13 13",width:"13",height:"13",children:[Le("rect",{x:"0.5",y:"0.5",width:"12",height:"12",class:"strokeFill"}),Le("line",{x1:"8.5",y1:"0.5",x2:"8.5",y2:"12.5",class:"stroke"}),Le("line",{x1:"8.5",y1:"4.5",x2:"12.5",y2:"4.5",class:"stroke"}),Le("line",{x1:"8.5",y1:"8.5",x2:"12.5",y2:"8.5",class:"stroke"}),Le("line",{x1:"2",y1:"6.5",x2:"7",y2:"6.5",class:"stroke"}),Le("line",{x1:"4.5",y1:"4",x2:"4.5",y2:"9",class:"stroke"})]})}),this.toolbar.appendChild(this.buttonAddColumnLeft),this.buttonAddColumnRight=Le("button",{title:"add column right",children:Me("svg",{viewBox:"0 0 13 13",width:"13",height:"13",children:[Le("rect",{x:"0.5",y:"0.5",width:"12",height:"12",class:"strokeFill"}),Le("line",{x1:"4.5",y1:"0.5",x2:"4.5",y2:"12.5",class:"stroke"}),Le("line",{x1:"0.5",y1:"4.5",x2:"4.5",y2:"4.5",class:"stroke"}),Le("line",{x1:"0.5",y1:"8.5",x2:"4.5",y2:"8.5",class:"stroke"}),Le("line",{x1:"6",y1:"6.5",x2:"11",y2:"6.5",class:"stroke"}),Le("line",{x1:"8.5",y1:"4",x2:"8.5",y2:"9",class:"stroke"})]})}),this.toolbar.appendChild(this.buttonAddColumnRight),this.buttonDeleteColumn=Le("button",{class:"right",title:"delete column",children:Me("svg",{viewBox:"0 0 13 13",width:"13",height:"13",children:[Le("rect",{x:"0.5",y:"0.5",width:"12",height:"12",class:"strokeFill"}),Le("line",{x1:"4.5",y1:"0.5",x2:"4.5",y2:"12.5",class:"stroke"}),Le("line",{x1:"8.5",y1:"0.5",x2:"8.5",y2:"12.5",class:"stroke"}),Le("line",{x1:"3.5",y1:"5.5",x2:"9.5",y2:"11.5",class:"stroke","stroke-width":"1.5"}),Le("line",{x1:"3.5",y1:"11.5",x2:"9.5",y2:"5.5",class:"stroke","stroke-width":"1.5"})]})}),this.toolbar.appendChild(this.buttonDeleteColumn),this.toolbar.appendChild(document.createTextNode(" ")),this.buttonAddNodeAbove=Le("button",{class:"left",title:"add node above",children:Me("svg",{style:{display:"block",border:"none"},viewBox:"0 0 8 17",width:"8",height:"17",children:[Le("rect",{x:"0.5",y:"1.5",width:"6",height:"6",class:"strokeFill"}),Le("rect",{x:"0.5",y:"9.5",width:"6",height:"6",class:"fill"}),Le("line",{x1:"3.5",y1:"3",x2:"3.5",y2:"6",class:"stroke"}),Le("line",{x1:"2",y1:"4.5",x2:"5",y2:"4.5",class:"stroke"}),Le("line",{x1:"3.5",y1:"0",x2:"3.5",y2:"1",class:"stroke"}),Le("line",{x1:"3.5",y1:"8",x2:"3.5",y2:"17",class:"stroke"})]})}),this.toolbar.appendChild(this.buttonAddNodeAbove),this.buttonAddNodeBelow=Le("button",{title:"add node below",children:Me("svg",{style:{display:"block",border:"none"},viewBox:"0 0 8 17",width:"8",height:"17",children:[Le("rect",{x:"0.5",y:"1.5",width:"6",height:"6",class:"fill"}),Le("rect",{x:"0.5",y:"9.5",width:"6",height:"6",class:"strokeFill"}),Le("line",{x1:"3.5",y1:"11",x2:"3.5",y2:"14",class:"stroke"}),Le("line",{x1:"2",y1:"12.5",x2:"5",y2:"12.5",class:"stroke"}),Le("line",{x1:"3.5",y1:"0",x2:"3.5",y2:"9",class:"stroke"}),Le("line",{x1:"3.5",y1:"16",x2:"3.5",y2:"17",class:"stroke"})]})}),this.toolbar.appendChild(this.buttonAddNodeBelow),this.buttonAddNodeParent=Le("button",{title:"add node parent",children:Me("svg",{viewBox:"0 0 13 17",width:"13",height:"17",children:[Le("rect",{x:"0.5",y:"1.5",width:"6",height:"6",class:"strokeFill"}),Le("rect",{x:"6.5",y:"9.5",width:"6",height:"6",class:"fill"}),Le("line",{x1:"7",y1:"4.5",x2:"10",y2:"4.5",class:"stroke"}),Le("line",{x1:"9.5",y1:"4",x2:"9.5",y2:"9",class:"stroke"}),Le("line",{x1:"3.5",y1:"3",x2:"3.5",y2:"6",class:"stroke"}),Le("line",{x1:"2",y1:"4.5",x2:"5",y2:"4.5",class:"stroke"}),Le("line",{x1:"3.5",y1:"0",x2:"3.5",y2:"1",class:"stroke"}),Le("line",{x1:"3.5",y1:"8",x2:"3.5",y2:"17",class:"stroke"})]})}),this.buttonAddNodeParent.onclick=()=>{},this.toolbar.appendChild(this.buttonAddNodeParent),this.buttonAddNodeChild=Le("button",{title:"add node child",children:Me("svg",{viewBox:"0 0 13 17",width:"13",height:"17",children:[Le("rect",{x:"0.5",y:"1.5",width:"6",height:"6",class:"fill"}),Le("rect",{x:"6.5",y:"9.5",width:"6",height:"6",class:"strokeFill"}),Le("line",{x1:"7",y1:"4.5",x2:"10",y2:"4.5",class:"stroke"}),Le("line",{x1:"9.5",y1:"4",x2:"9.5",y2:"9",class:"stroke"}),Le("line",{x1:"9.5",y1:"11",x2:"9.5",y2:"14",class:"stroke"}),Le("line",{x1:"8",y1:"12.5",x2:"11",y2:"12.5",class:"stroke"}),Le("line",{x1:"3.5",y1:"0",x2:"3.5",y2:"17",class:"stroke"})]})}),this.toolbar.appendChild(this.buttonAddNodeChild),this.buttonDeleteNode=Le("button",{class:"right",title:"delete node",children:Me("svg",{viewBox:"0 0 10 17",width:"10",height:"17",children:[Le("rect",{x:"1.5",y:"5.5",width:"6",height:"6",class:"strokeFill"}),Le("line",{x1:"4.5",y1:"2",x2:"4.5",y2:"5",class:"stroke"}),Le("line",{x1:"4.5",y1:"12",x2:"4.5",y2:"15",class:"stroke"}),Le("line",{x1:"0.5",y1:"4.5",x2:"8.5",y2:"12.5",class:"stroke","stroke-width":"1.5"}),Le("line",{x1:"8.5",y1:"4.5",x2:"0.5",y2:"12.5",class:"stroke","stroke-width":"1.5"})]})}),this.toolbar.appendChild(this.buttonDeleteNode),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(vi,!0)),this.shadowRoot.appendChild(this.toolbar)}canHandle(t){return t instanceof ns}activate(){this.lastActiveTable=bi.activeView,this.toolbar.classList.add("active")}deactivate(){this.lastActiveTable=void 0,this.toolbar.classList.remove("active")}});ai.define("toad-treenodecell",class extends ai{constructor(t,e,i){super(),this.model=t,this.rowinfo=e,this.label=i,this.attachShadow({mode:"open"})}connectedCallback(){super.connectedCallback(),this.paint()}disconnectedCallback(){super.disconnectedCallback()}paint(){if(!this.shadowRoot)return;if(!this.parentElement)return;const t=this.model.getRow(this.rowinfo.node);if(void 0===t)return;const e=12,i=3.5,s=Math.round(2)-.5,o=this.rowinfo.depth*e+e+i,r=Me(De,{children:[Le("svg",{width:o,height:e,style:{verticalAlign:"middle",background:"none"}}),Le("span",{style:{verticalAlign:"middle",padding:"2px"},children:this.label})]}),n=r[0];{const o=this.rowinfo,r=o.depth;if(this.model.getDown(o.node)){const t=r*e+i,l=Le("rect",{x:t,y:s,width:8,height:8,stroke:"#000",fill:"#fff",cursor:"pointer"});n.appendChild(l),n.appendChild(Le("line",{x1:t+2,y1:s+4,x2:t+8-2,y2:s+4,stroke:"#000",cursor:"pointer"}));const a=Le("line",{x1:t+4,y1:s+2,x2:t+4,y2:s+8-2,stroke:"#000",cursor:"pointer"});a.style.display=o.open?"none":"",n.appendChild(a),n.appendChild(Le("line",{x1:t+8,y1:s+4,x2:t+8+3,y2:s+4,stroke:"#000"})),n.onmousedown=e=>{e.preventDefault(),e.stopPropagation();const i=this.model.getRow(o.node);if(void 0===i)return void console.log("  ==> couldn't find row number for node");const r=n.getBoundingClientRect(),l=e.clientX-r.left,h=e.clientY-r.top;t<=l&&l<=t+8&&s<=h&&h<=s+8&&(this.model?.toggleAt(i),a.style.display=this.model.isOpen(i)?"none":"")}}else n.appendChild(Le("line",{x1:r*e+i+4,y1:"0",x2:r*e+i+4,y2:s+4,stroke:"#000"})),n.appendChild(Le("line",{x1:r*e+i+4,y1:s+4,x2:r*e+i+8+3,y2:s+4,stroke:"#000"}));let l="";for(let s=0;s<=r;++s){const n=s*e+i+4;for(let e=t+1;e<this.model.rowCount&&!(this.model.rows[e].depth<s);++e)if(s===this.model.rows[e].depth){(s!==r||void 0!==this.model.getNext(o.node))&&(l+=`<line x1='${n}' y1='0' x2='${n}' y2='100%' stroke='%23000' />`);break}}if(void 0===this.model.getDown(o.node)||void 0===this.model.getNext(o.node)){const t=r*e+i+4;l+=`<line x1='${t}' y1='0' x2='${t}' y2='50%' stroke='%23000' />`}this.parentElement.style.background=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'>${l}</svg>")`,this.parentElement.style.backgroundRepeat="repeat-y"}r.replaceIn(this.shadowRoot)}});class hs{constructor(t){!function(t,e){if(e instanceof B){const i=e;t.bid=i.ulong(),t.name=i.string(),t.description=i.string(),t.layers=i.sequence((()=>i.value("Layer")))}else t.bid=void 0===e||void 0===e.bid?0:e.bid,t.name=void 0===e||void 0===e.name?"":e.name,t.description=void 0===e||void 0===e.description?"":e.description,t.layers=void 0===e||void 0===e.layers?new Array:e.layers}(this,t),this.modified=new He,console.log("BoardModel.constructor()")}transform(t,e,i){this.board.transform(t,e,i)}add(t,e){this.board.add(t,e)}delete(t,e){}setStrokeAndFill(t,e,i,s){}bringToFront(t,e){}bringToBack(t,e){}bringForward(t,e){}bringBackward(t,e){}}class ds extends ti{constructor(t){super(),this.open("src/client/AccountPreferences.html"),this.bind("fullname",t.fullname),this.bind("email",t.email),this.action("cancel",(()=>{this.close()})),this.action("save",(()=>{this.close()}))}}class cs extends it{constructor(t){super(t)}static _idlClassName(){return"BoardListener"}_orb_add(t,e){return i(this,void 0,void 0,(function*(){this.add(t.ulong(),t.value("Figure"))}))}_orb_transform(t,e){return i(this,void 0,void 0,(function*(){this.transform(t.ulong(),t.sequence((()=>t.ulong())),t.value("Matrix"),t.sequence((()=>t.ulong())))}))}}class us extends it{constructor(t){super(t)}static _idlClassName(){return"Client"}_orb_logonScreen(t,e){return i(this,void 0,void 0,(function*(){this.logonScreen(t.ulong(),t.string(),t.bool(),t.string())}))}_orb_homeScreen(t,e){return i(this,void 0,void 0,(function*(){this.homeScreen(t.string(),t.string(),t.string(),t.string())}))}}class gs{constructor(){this.modified=new He,this.selection=new Set}set(t){this.selection.clear(),this.selection.add(t),this.modified.trigger()}add(t){this.selection.add(t),this.modified.trigger()}remove(t){this.selection.delete(t),this.modified.trigger()}replace(t,e){this.selection.delete(t),this.selection.add(e),this.modified.trigger()}has(t){return this.selection.has(t)}empty(){return 0===this.selection.size}clear(){this.selection.clear(),this.modified.trigger()}figureIds(){let t=new Array;for(let e of this.selection)t.push(e.id);return t}}!function(t){t[t.Start=1]="Start",t[t.End=2]="End",t[t.Empty=3]="Empty"}(es||(es={}));class fs{constructor(t,e,i){this.filename=t,this.row=e,this.col=i}printTree(t){}toString(){throw Error(`toString() is not implemented (${this.filename}:${this.row}:${this.col})`)}innerText(){throw Error(`innerText() is not implemented (${this.filename}:${this.row}:${this.col})`)}}class ps extends fs{constructor(t,e,i){super(t,e,i),this.text=""}toString(){return this.text}innerText(){return this.text}printTree(t){let e="";for(let i=0;i<t;++i)e=`${e}    `;console.log(`${e}text: ${this.text}`)}}class ms extends fs{constructor(t,e,i){super(t,e,i),this.text=""}toString(){return`\x3c!--${this.text}--\x3e`}innerText(){return this.toString()}printTree(t){let e="";for(let i=0;i<t;++i)e=`${e}    `;console.log(`${e}comment: ${this.text}`)}}class ys extends fs{constructor(t,e,i){super(t,e,i),this.text=""}toString(){return`<![CDATA[${this.text}]]>`}innerText(){return this.toString()}printTree(t){let e="";for(let i=0;i<t;++i)e=`${e}    `;console.log(`${e}cdata: ${this.text}`)}}class vs extends fs{constructor(t,e,i){super(t,e,i),this.name="",this.type=es.Start,this.attributes=new Map,this.children=new Array}addAttribute(t,e){this.attributes.set(t,e)}getAttributeOrUndefined(t){return this.attributes.get(t)}getAttribute(t){let e=this.getAttributeOrUndefined(t);if(void 0===e)throw Error(`missing attribute '${t}'`);return e}clearAttribute(t){this.attributes.delete(t)}pushFront(t){this.children.unshift(t)}pushBack(t){this.children.push(t)}getChildOrUndefined(t){let e;for(let i of this.children)if(i instanceof vs&&i.name===t){if(void 0!==e)throw Error(`tag '${t}' has multiple occurences'`);e=i}return e}getChild(t){let e=this.getChildOrUndefined(t);if(void 0===e)throw Error(`missing tag '${t}'`);return e}forAll(t,e){t===this.name&&e(this);for(let i of this.children)i instanceof vs&&i.forAll(t,e)}toString(){let t=`<${this.name}`;for(let[e,i]of this.attributes)t=`${t} ${e}="${i}"`;if(this.type===es.Empty)t+="/";else{t+=">";for(let e of this.children)t+=e.toString();t=`${t}</${this.name}`}return t+=">",t}innerText(){let t="";for(let e of this.children)t+=e.toString();return t}printTree(t){let e="";for(let i=0;i<t;++i)e=`${e}    `;console.log(`${e}tag: ${this.name}`);for(let e of this.children)e.printTree(t+1)}}class ws extends vs{constructor(t){super(t,1,1)}toString(){let t="";for(let e of this.children)t+=e.toString();return t}printTree(t){let e="";for(let i=0;i<t;++i)e=`${e}    `;console.log(`${e}document`);for(let e of this.children)e.printTree(t+1)}}class Es{constructor(t,e){this.filename=t,this.data=e,this.pos=0,this.col=1,this.row=1,this.state=0}error(t){throw Error(`${t} (${this.filename}:${this.row}:${this.col})`)}getc(){if(!(this.pos>=this.data.length))return this.data[this.pos++]}ungetc(){if(--this.pos,10==this.data.charCodeAt(this.pos)){this.col=0;for(let t=this.pos;t>=0&&10!=this.data.charCodeAt(this.pos);--t)++this.col;--this.row}}isWhiteSpace(t){return 32==t||9==t||13==t||10==t}isNameStartChar(t){return 58===t||95===t||t>=65&&t<=90||t>=97&&t<=122||t>=192&&t<=214||t>=216&&t<=246||t>=248&&t<=767||t>=880&&t<=893||t>=895&&t<=8191||t>=8204&&t<=8205||t>=8304&&t<=8591||t>=11264&&t<=12271||t>=12289&&t<=55295||t>=63744&&t<=64975||t>=65008&&t<=65533||t>=65536&&t<=983039}isNameChar(t){return this.isNameStartChar(t)||45===t||46===t||t>=48&&t<=57||183==t||t>=768&&t<=879||t>=8255&&t<=8256}lex(){let t,e,i,s,o=0,r="",n="";for(;;){let l=this.getc();if(void 0===l)return 2===o?e:void 0;let a=l.charCodeAt(0);switch(10===a?(++this.row,this.col=1):++this.col,o){case 0:if("<"===l)o=1;else e=new ps(this.filename,this.row,this.col),e.text+=l,o=2;break;case 1:switch(l){case"!":o=13;break;case"?":o=11;break;case"/":o=3;break;default:this.isNameStartChar(a)||this.error("Expected tag name, comment or prolog after '<'"),t=new vs(this.filename,this.row,this.col),t.name+=l,o=4}break;case 2:if("<"===l)return this.ungetc(),e;e.text+=l;break;case 3:this.isNameStartChar(a)||this.error("Expected tag name after '</'"),t=new vs(this.filename,this.row,this.col),t.type=es.End,t.name+=l,o=4;break;case 4:if("/"===l)t.type=es.Empty,o=5;else{if(">"===l)return t;this.isNameChar(a)?t.name+=l:this.isWhiteSpace(a)?o=6:t.name+=l}break;case 5:return">"!=l&&this.error("Expected '>' at end of tag"),t;case 6:if(this.isWhiteSpace(a))break;if(this.isNameStartChar(a))r+=l,o=7;else if("/"===l)t.type=es.Empty,o=5;else if(">"===l)return t;break;case 7:if(this.isNameChar(a)){r+=l;break}o=8;case 8:if(this.isWhiteSpace(a))break;if("="===l){o=9;break}this.error("Expected '=' after attribute name");case 9:if(this.isWhiteSpace(a))break;if('"'===l){o=10;break}this.error("Expected '\"' after '='");case 10:'"'===l?(t.addAttribute(r,n),o=6,r="",n=""):n+=l;break;case 11:"?"==l&&(o=12);break;case 12:switch(l){case">":o=0;break;case"?":break;default:o=11}break;case 13:switch(l){case"-":o=14;break;case"[":o=30}break;case 14:"-"!==l&&this.error("Expected '-' after '<!-'"),o=15,i=new ms(this.filename,this.row,this.col);break;case 15:"-"==l?o=16:i.text+=l;break;case 16:"-"==l?o=17:(i.text+="-"+l,o=15);break;case 17:return">"!=l&&this.error("'--' is only allowed in comment to close them"),i;case 30:s=new ys(this.filename,this.row,this.col),"C"!=l&&this.error("Expected 'C' after <!["),o=31;break;case 31:"D"!=l&&this.error("Expected 'D' after <![C"),o=32;break;case 32:"A"!=l&&this.error("Expected 'A' after <![CD"),o=33;break;case 33:"T"!=l&&this.error("Expected 'T' after <![CDA"),o=34;break;case 34:"A"!=l&&this.error("Expected 'A' after <![DAT"),o=35;break;case 35:"["!=l&&this.error("Expected '[' after <![CDATA"),o=36;break;case 36:"]"===l?o=37:s.text+=l;break;case 37:"]"===l?o=38:(s.text+="]"+l,o=36);break;case 38:if(">"===l)return s;s.text+="]]"+l,o=36}}}}class bs{constructor(){this.debug=!1,void 0===bs.selection&&(bs.selection=new gs),this.transformation=new Rt,this.boundary=new jt,this.boundaryTransformation=new Rt,this.handles=new Map}activate(t){}deactivate(t){}pointerEvent(t){switch(t.type){case"down":return this.pointerdown(t);case"move":return this.pointermove(t);case"up":return this.pointerup(t)}}pointerdown(t){}pointermove(t){}pointerup(t){}keydown(t){}keyup(t){}clipboard(t,e){}updateBoundary(){if(this.boundaryTransformation.identity(),this.boundary=new jt,bs.selection.empty())return;let t=!0,e=0;for(let i of bs.selection.selection){let s;if(void 0===i.matrix)s=0;else if(s=i.matrix.getRotation(),isNaN(s)){e=0;break}if(t)t=!1,e=s;else if(!Gt(s%(Math.PI/2),e%(Math.PI/2))){e=0;break}}let i=new Rt;i.rotate(e);let s=new Rt(i).invert(),o=new jt,r=!0;for(let t of bs.selection.selection){t.bounds().forAllEdges((t=>{t=s.transformPoint(t),r?(r=!1,o.origin=t):o.expandByPoint(t)}),t.matrix)}let n=i.transformPoint(o.center());var l,a,h,d;this.boundary.origin=(l=n,h=o.size,d=.5,a=new _t({width:h.width*d,height:h.height*d}),new Tt({x:l.x-a.width,y:l.y-a.height})),this.boundary.size=o.size,0!=e&&(this.boundaryTransformation.translate(Lt(n)),this.boundaryTransformation.rotate(e),this.boundaryTransformation.translate(n))}getBoundaryHandle(t){const e=new Rt(this.transformation);e.append(this.boundaryTransformation);let i,s=this.boundary.origin.x,o=this.boundary.origin.y,r=this.boundary.size.width,n=this.boundary.size.height;switch(e.transformPoint({x:s+r/2,y:o+n/2}),t%8){case 0:i={x:-1,y:-1};break;case 1:i={x:0,y:-1};break;case 2:i={x:1,y:-1};break;case 3:i={x:1,y:0};break;case 4:i={x:1,y:1};break;case 5:i={x:0,y:1};break;case 6:i={x:-1,y:1};break;case 7:i={x:-1,y:0}}const l=e.transformPoint({x:0,y:0});if(i=It(e.transformPoint(i),l),t>=8){let l,a;switch(t){case 8:l=e.transformPoint({x:s,y:o+n}),a=e.transformPoint({x:s,y:o});break;case 9:l=e.transformPoint({x:s,y:o}),a=e.transformPoint({x:s+r/2,y:o});break;case 10:l=e.transformPoint({x:s,y:o}),a=e.transformPoint({x:s+r,y:o});break;case 11:l=e.transformPoint({x:s+r,y:o}),a=e.transformPoint({x:s+r,y:o+n/2});break;case 12:l=e.transformPoint({x:s+r,y:o}),a=e.transformPoint({x:s+r,y:o+n});break;case 13:l=e.transformPoint({x:s+r,y:o+n}),a=e.transformPoint({x:s+r/2,y:o+n});break;case 14:l=e.transformPoint({x:s+r,y:o+n}),a=e.transformPoint({x:s,y:o+n});break;case 15:l=e.transformPoint({x:s,y:o+n}),a=e.transformPoint({x:s,y:o+n/2});break;default:throw Error("yikes")}const h=It(a,l),d=Dt(h,1/Math.sqrt(Ft(h))),c=e.transformPoint({x:0,y:0}),u=e.transformPoint({x:Yt.HANDLE_RANGE,y:0});let g=Ot(a,Dt(d,2*-Math.sqrt(Ft(It(u,c)))));t%2!=0&&(g=Mt(g,a,-Math.PI/4));const f=new ge;f.move(a);for(let t=0,e=Math.PI/2;t<=8;++t,e+=Math.PI/16)f.line(Mt(g,a,e));return f.close(),{path:f,handleDirection:i}}switch(t%8){case 0:[s,o]=[s,o];break;case 1:[s,o]=[s+r/2,o];break;case 2:[s,o]=[s+r,o];break;case 3:[s,o]=[s+r,o+n/2];break;case 4:[s,o]=[s+r,o+n];break;case 5:[s,o]=[s+r/2,o+n];break;case 6:[s,o]=[s,o+n];break;case 7:[s,o]=[s,o+n/2]}const a=new jt(s,o,Yt.HANDLE_RANGE,Yt.HANDLE_RANGE);a.origin=e.transformPoint(a.origin),a.origin.x-=Yt.HANDLE_RANGE/2,a.origin.y-=Yt.HANDLE_RANGE/2,a.origin.x=Math.round(a.origin.x-.5)+.5,a.origin.y=Math.round(a.origin.y-.5)+.5;const h=new ge;return h.appendRect(a),{path:h,handleDirection:i}}setCursorForHandle(t,e,i){const s=Math.atan2(e.handleDirection.y,e.handleDirection.x)+.6875*Math.PI;let o=(Math.round(s/(2*Math.PI)*8)+8)%8;switch(t>=8&&(o+=8),o){case 0:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-resize-nw.svg) 6 6, move`);break;case 1:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-resize-n.svg) 4 7, move`);break;case 2:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-resize-ne.svg) 6 6, move`);break;case 3:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-resize-e.svg) 7 4, move`);break;case 4:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-resize-se.svg) 6 6, move`);break;case 5:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-resize-s.svg) 4 7, move`);break;case 6:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-resize-sw.svg) 6 6, move`);break;case 7:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-resize-w.svg) 7 4, move`);break;case 8:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-rotate-nw.svg) 5 5, move`);break;case 9:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-rotate-n.svg) 7 2, move`);break;case 10:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-rotate-ne.svg) 8 5, move`);break;case 11:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-rotate-e.svg) 5 7, move`);break;case 12:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-rotate-se.svg) 8 8, move`);break;case 13:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-rotate-s.svg) 7 5, move`);break;case 14:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-rotate-sw.svg) 5 8, move`);break;case 15:i.setAttributeNS("","style",`cursor: url(${bs.cursorPath}select-rotate-w.svg) 2 7, move`)}}updateOutlineAndDecorationOfSelection(t){this.updateOutlineOfSelection(t),this.updateDecorationOfSelection(t)}updateOutlineOfSelection(t){this.removeOutlines(t),this.createOutlines(t)}updateDecorationOfSelection(t){this.removeDecoration(t),this.createDecoration(t)}createOutlines(t){this.outline=document.createElementNS("http://www.w3.org/2000/svg","g");for(let e of bs.selection.selection)this.outline.appendChild(this.createOutline(t,e));t.decorationOverlay.appendChild(this.outline)}createOutline(t,e){let i=e.getPath();void 0!==e.matrix&&i.transform(e.matrix),i.transform(this.transformation);let s=i.updateSVG(t.decorationOverlay,void 0);return this.setOutlineColors(s),s}removeOutlines(t){this.outline&&(t.decorationOverlay.removeChild(this.outline),this.outline=void 0)}setOutlineColors(t){if(t instanceof SVGGElement)for(let e=0;e<t.childNodes.length;++e){let i=t.childNodes[e];this.setOutlineColors(i)}else t.setAttributeNS("","stroke-width","1"),t.setAttributeNS("","stroke","#4f80ff"),t.setAttributeNS("","fill","none")}updateDecoration(t){this.removeDecoration(t),this.createDecoration(t)}createDecoration(t){bs.selection.empty()||(this.decoration=document.createElementNS("http://www.w3.org/2000/svg","g"),this.updateBoundary(),this.createDecorationRectangle(t),this.createDecorationHandles(t),t.decorationOverlay.appendChild(this.decoration))}createDecorationRectangle(t){let e=new jt(this.boundary);e.origin.x=Math.round(e.origin.x-.5)+.5,e.origin.y=Math.round(e.origin.y-.5)+.5,e.size.width=Math.round(e.size.width),e.size.height=Math.round(e.size.height);let i=new ge;i.appendRect(e);let s=new Rt(this.transformation);s.append(this.boundaryTransformation),i.transform(s);let o=i.createSVG("rgb(79,128,255)");this.decoration.appendChild(o)}createDecorationHandles(t){for(let t=15;t>=0;--t){const e=this.getBoundaryHandle(t);let i;i=t<8?e.path.createSVG("rgb(79,128,255)",1,"#fff"):e.path.createSVG("rgba(0,0,0,0)",1,"rgba(0,0,0,0)"),this.setCursorForHandle(t,e,i),i.onmouseenter=()=>{this.insideHandle=t},i.onmouseleave=()=>{this.insideHandle=void 0},this.decoration.appendChild(i)}}removeDecoration(t){this.decoration&&(t.decorationOverlay.removeChild(this.decoration),this.decoration=void 0)}static setHint(t){const e=document.getElementById("hint");if(!e)return void console.trace("setHint: no #hint found");const i=function(t,e){let i=new Es(t,e),s=new Array,o=new ws(t);for(s.push(o);;){let t=i.lex();if(void 0===t)break;if(t instanceof vs)switch(t.type){case es.Start:o.children.push(t),s.push(t),o=t;break;case es.End:let e=s.pop();if(void 0===e||s.length<1)throw Error(`unexpected closing tag ${t.name} (${t.filename}:${t.row}:${t.col})`);if(e.name!==t.name)throw Error(`wrong closing tag: expected ${t.name} but got ${e.name} (${t.filename}:${t.row}:${t.col})`);o=s[s.length-1];break;case es.Empty:o.children.push(t)}else o.children.push(t)}if(1!==s.length)throw Error(`missing ${s.length-1} closing tags`);return s[0]}("Tool.setHint()",t);bs.transform(i),e.innerHTML=i.toString()}static clearHint(){const t=document.getElementById("hint");t&&(t.innerHTML="")}static transform(t){return t.forAll("pointer",(t=>{t.name="span",t.addAttribute("class","action")})),t.forAll("ctrl",(t=>{t.name="kbd",t.type=es.Start;const e=new ps(t.filename,t.row,t.col);-1!==navigator.appVersion.indexOf("Macintosh")?e.text=" ^ ":e.text="ctrl",t.pushBack(e)})),t.forAll("alt",(t=>{t.name="kbd",t.type=es.Start;const e=new ps(t.filename,t.row,t.col);-1!==navigator.appVersion.indexOf("Macintosh")?e.text="⌥":e.text="alt",t.pushBack(e)})),t.forAll("meta",(t=>{t.name="kbd",t.type=es.Start;const e=new ps(t.filename,t.row,t.col);-1!==navigator.appVersion.indexOf("Macintosh")?e.text="⌘":e.text="⊞",t.pushBack(e)})),t.forAll("shift",(t=>{t.name="kbd",t.type=es.Start;const e=new ps(t.filename,t.row,t.col);e.text="⇧",t.pushBack(e)})),t.forAll("enter",(t=>{t.name="kbd",t.type=es.Start;const e=new ps(t.filename,t.row,t.col);e.text="↩",t.pushBack(e)})),t.forAll("esc",(t=>{t.name="kbd",t.type=es.Start;const e=new ps(t.filename,t.row,t.col);e.text="esc",t.pushBack(e)})),t}}bs.cursorPath="img/cursor/",function(t){t[t.NONE=0]="NONE",t[t.DRAG_MARQUEE=1]="DRAG_MARQUEE",t[t.MOVE_HANDLE=2]="MOVE_HANDLE",t[t.MOVE_SELECTION=3]="MOVE_SELECTION"}(is||(is={}));class As extends bs{constructor(){super(),this.debug=!1,this.state=is.NONE,this.marqueeOutlines=new Map,this.selectedHandle=0,this.handleStart=new Tt,this.oldBoundary=new jt,this.rotationCenter=new Tt,this.rotationStartDirection=0}activate(t){t.svgView.style.cursor="default",bs.selection.modified.add((()=>{this.updateOutlineAndDecorationOfSelection(t)}),this),bs.selection.modified.trigger(),bs.setHint("arrange tool: <pointer>click</pointer>: select at cursor, <pointer>drag</pointer>: select within rectangle, <shift/>: add to selection")}deactivate(t){bs.selection.modified.remove(this),this.removeOutlines(t),this.removeDecoration(t)}pointerdown(t){if(this.pointerDownAt=t,this.pointerLastAt=t,this.downHandle(t))return void(this.state=is.MOVE_HANDLE);this.transformation.identity();let e=t.editor.selectedLayer.findFigureAt(t);if(void 0===e)return t.shiftKey||bs.selection.clear(),void(this.state=is.DRAG_MARQUEE);this.state=is.MOVE_SELECTION,bs.selection.has(e)||(bs.selection.modified.lock(),t.shiftKey||bs.selection.clear(),bs.selection.add(e),bs.selection.modified.unlock())}pointermove(t){if(t.pointerDown)switch(this.state){case is.MOVE_HANDLE:this.moveHandle(t);break;case is.DRAG_MARQUEE:this.dragMarquee(t);break;case is.MOVE_SELECTION:this.moveSelection(t)}}pointerup(t){switch(this.state){case is.DRAG_MARQUEE:this.stopMarquee(t);break;case is.MOVE_HANDLE:this.moveHandle(t),this.stopHandle(t);break;case is.MOVE_SELECTION:this.moveSelection(t),this.stopMove(t)}this.state=is.NONE,this.transformation.identity(),this.updateBoundary()}keydown(t){"Backspace"!==t.code&&"Delete"!==t.code||(t.editor.deleteSelection(),bs.selection.modified.lock(),bs.selection.clear(),bs.selection.modified.unlock())}moveSelection(t){let e=It(t,this.pointerDownAt);this.transformation.identity(),this.transformation.translate(e),this.updateOutlineAndDecorationOfSelection(t.editor)}stopMove(t){this.moveSelection(t),t.editor.transformSelection(this.transformation),this.pointerDownAt=void 0}downHandle(t){const e=this.findHandle(t);return void 0!==e&&(this.selectedHandle=e,this.handleStart=t,this.transformation.identity(),this.oldBoundary=new jt(this.boundary),e>=8&&(this.rotationCenter=this.boundary.center(),this.rotationStartDirection=Math.atan2(t.y-this.rotationCenter.y,t.x-this.rotationCenter.x)),!0)}findHandle(t){if(!bs.selection.empty())return this.insideHandle}moveHandle(t){this.selectedHandle<8?this.moveHandle2Scale(t):this.moveHandle2Rotate(t)}moveHandle2Scale(t){let e=this.boundary.origin.x,i=this.boundary.origin.y,s=e+this.boundary.size.width,o=i+this.boundary.size.height,r=this.oldBoundary.origin.x,n=this.oldBoundary.origin.y,l=r+this.oldBoundary.size.width,a=n+this.oldBoundary.size.height,h=new Rt(this.boundaryTransformation);h.invert();let d=h.transformPoint(t);switch(this.selectedHandle){case 0:[e,i]=[d.x,d.y];break;case 1:i=d.y;break;case 2:[s,i]=[d.x,d.y];break;case 3:s=d.x;break;case 4:[s,o]=[d.x,d.y];break;case 5:o=d.y;break;case 6:[e,o]=[d.x,d.y];break;case 7:e=d.x}let c=(s-e)/(l-r),u=(o-i)/(a-n),[g,f]=[e,i],[p,m]=[r,n];this.transformation.identity(),this.transformation.append(h),this.transformation.translate({x:-p,y:-m}),this.transformation.scale(c,u),this.transformation.translate({x:g,y:f}),this.transformation.prepend(this.boundaryTransformation),this.updateOutlineAndDecorationOfSelection(t.editor)}moveHandle2Rotate(t){let e=Math.atan2(t.y-this.rotationCenter.y,t.x-this.rotationCenter.x);e-=this.rotationStartDirection;let i=this.rotationCenter;this.transformation.identity(),this.transformation.translate(Lt(i)),this.transformation.rotate(e),this.transformation.translate(i),this.updateOutlineAndDecorationOfSelection(t.editor)}stopHandle(t){this.state=is.NONE;let e=this.transformation;this.transformation=new Rt,t.editor.transformSelection(e),this.updateOutlineAndDecorationOfSelection(t.editor)}dragMarquee(t){void 0===this.svgMarquee&&this.createMarquee(t.editor),this.updateMarquee(t),this.removeMarqueeOutlines(t.editor),this.createMarqueeOutlines(t.editor)}stopMarquee(t){bs.selection.modified.lock(),this.copyMarqueeToSelection(),this.removeMarquee(t.editor),this.removeMarqueeOutlines(t.editor),bs.selection.modified.unlock(),this.pointerDownAt=void 0}createMarquee(t){void 0===this.svgMarquee&&(this.svgMarquee=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.svgMarquee.setAttributeNS("","stroke","rgb(79,128,255)"),this.svgMarquee.setAttributeNS("","fill","rgba(79,128,255,0.2)"),t.decorationOverlay.appendChild(this.svgMarquee))}removeMarquee(t){void 0!==this.svgMarquee&&(t.decorationOverlay.removeChild(this.svgMarquee),this.svgMarquee=void 0)}copyMarqueeToSelection(){for(let t of this.marqueeOutlines)bs.selection.add(t[0])}updateMarquee(t){let e=this.pointerDownAt.x,i=this.pointerDownAt.y,s=t.x,o=t.y;s<e&&([e,s]=[s,e]),o<i&&([i,o]=[o,i]),this.marqueeRectangle=new jt({origin:{x:e,y:i},size:{width:s-e,height:o-i}}),this.svgMarquee.setAttributeNS("","x",String(Math.round(e)+.5)),this.svgMarquee.setAttributeNS("","y",String(Math.round(i)+.5)),this.svgMarquee.setAttributeNS("","width",String(Math.round(s-e))),this.svgMarquee.setAttributeNS("","height",String(Math.round(o-i)))}createMarqueeOutlines(t){for(let e of t.selectedLayer.data){if(bs.selection.has(e))continue;let i=!0;if(e.bounds().forAllEdges((t=>{this.marqueeRectangle.contains(t)||(i=!1)}),e.matrix),!i)continue;let s=this.createOutline(t,e);t.decorationOverlay.appendChild(s),this.marqueeOutlines.set(e,s)}}removeMarqueeOutlines(t){for(let e of this.marqueeOutlines)t.decorationOverlay.removeChild(e[1]);this.marqueeOutlines.clear()}}!function(t){t[t.NONE=0]="NONE"}(ss||(ss={}));class xs extends bs{constructor(){super(),this.debug=!1,this.state=ss.NONE}activate(t){t.svgView.style.cursor="default",bs.setHint("edit tool: under construction"),bs.selection.modified.add((()=>{this.updateOutlineOfSelection(t)}),this),bs.selection.modified.trigger()}deactivate(t){bs.selection.modified.remove(this),this.removeOutlines(t)}pointerdown(t){let e=t.editor.selectedLayer.findFigureAt(t);void 0!==e?bs.selection.has(e)||(bs.selection.modified.lock(),t.shiftKey||bs.selection.clear(),bs.selection.add(e),bs.selection.modified.unlock()):t.shiftKey||bs.selection.clear()}}class Cs{constructor(t,e){this.editor=t,this.event=e,this.code=e.code,this.value=e.key,this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.alt=e.altKey,this.meta=e.metaKey}preventDefault(){this.event.preventDefault()}stopPropagation(){this.event.stopPropagation()}stopImmediatePropagation(){this.event.stopImmediatePropagation()}}var Ss={};function Ts(t,e,i){if(!i||typeof i.value!==Ss.typeOfFunction)throw new TypeError(`Only methods can be decorated with @bind. <${String(e)}> is not a method!`);return{configurable:Ss.boolTrue,get:function(){var t=i.value.bind(this);return Object.defineProperty(this,e,{value:t,configurable:Ss.boolTrue,writable:Ss.boolTrue}),t}}}!function(t){t.typeOfFunction="function",t.boolTrue=!0}(Ss||(Ss={}));let _s=document.createElement("style");var Rs;_s.textContent="\nsvg {\n    top: 0;\n    left: 0;\n    width: 41px;\n    height: 60px;\n    background: none;\n}\n",function(t){t[t.STROKE=0]="STROKE",t[t.FILL=1]="FILL",t[t.NONE=2]="NONE",t[t.BOTH=3]="BOTH"}(Rs||(Rs={}));class Ns extends Ge{constructor(){super(),this._stroke="#000",this._fill="#fff",this._strokeOrFill=Rs.STROKE}set(t){switch(this._strokeOrFill){case Rs.STROKE:this.stroke=t;break;case Rs.FILL:this.fill=t;break;case Rs.NONE:break;case Rs.BOTH:this.modified.lock(),this.stroke=t,this.fill=t,this.modified.unlock()}}get(){switch(this._strokeOrFill){case Rs.STROKE:return this.stroke;case Rs.FILL:return this.fill;case Rs.NONE:case Rs.BOTH:return""}}set stroke(t){t!==this._stroke&&(this._stroke=t,this.modified.trigger())}get stroke(){return this._stroke}set fill(t){t!==this._fill&&(this._fill=t,this.modified.trigger())}get fill(){return this._fill}set strokeOrFill(t){t!==this._strokeOrFill&&(this._strokeOrFill=t,this.modified.trigger())}get strokeOrFill(){return this._strokeOrFill}}class Os extends hi{constructor(t){super(),this.stroke="#000",this.fill="#fff",this.svg=Me("svg",{children:[Le("rect",{x:"0.5",y:"0.5",width:"27",height:"27",stroke:"#000",fill:"#000",set:ke(this,"fillElement"),onmousedown:this.focusFillBox}),Le("line",{x1:"4",y1:"24",x2:"24",y2:"4",stroke:"#f00",strokeWidth:"2",strokeLinecap:"round",set:ke(this,"fillNoneElement")}),Le("rect",{x:"13.5",y:"13.5",width:"27",height:"27",stroke:"#000",fill:"#fff",set:ke(this,"strokeOuterFrame")}),Le("rect",{x:"15.5",y:"15.5",width:"23",height:"23",stroke:"#000",fill:"#000",set:ke(this,"strokeElement")}),Le("line",{x1:"16",y1:"38",x2:"38",y2:"16",stroke:"#f00",strokeWidth:"2",strokeLinecap:"round",set:ke(this,"strokeNoneElement")}),Le("rect",{x:"20.5",y:"20.5",width:"13",height:"13",stroke:"#fff",fill:"#fff"}),Le("rect",{x:"21.5",y:"21.5",width:"11",height:"11",stroke:"#000",fill:"none"}),Le("rect",{x:"13.5",y:"13.5",width:"27",height:"27",stroke:"rgba(0,0,0,0)",fill:"rgba(0,0,0,0)",set:ke(this,"strokeHitBox"),onmousedown:this.focusStrokeBox}),Le("path",{d:"M 31 2.5 L 34 0 L 34  5 Z M 38.5 10 L 36 7 L 41 7 Z",fill:"#000"}),Le("path",{d:"M 33.5 2.5 C 38.5 2.5 38.5 2.5 38.5, 7.5",stroke:"#000",fill:"none"}),Le("rect",{x:"30.5",y:"0.5",width:"10",height:"10",stroke:"rgba(0,0,0,0)",fill:"rgba(0,0,0,0)",onmousedown:this.swapStrokeAndFill}),Le("rect",{x:"4.5",y:"32.5",width:"7",height:"7",stroke:"#000",fill:"#000"}),Le("rect",{x:"6.5",y:"34.5",width:"3",height:"3",stroke:"#fff",fill:"#fff"}),Le("rect",{x:"1.5",y:"29.5",width:"7",height:"7",stroke:"#000",fill:"#fff"}),Le("rect",{x:"1.5",y:"29.5",width:"10",height:"10",stroke:"rgba(0,0,0,0)",fill:"rgba(0,0,0,0)",onmousedown:this.setDefaultStrokeAndFill}),Le("rect",{x:"0.5",y:"46.5",width:"13",height:"13",stroke:"#000",fill:"none",set:ke(this,"colorButtonIndicatorElement")}),Le("rect",{x:"3.5",y:"49.5",width:"7",height:"7",stroke:"#000",fill:"#000",set:ke(this,"colorButtonElement")}),Le("rect",{x:"0.5",y:"46.5",width:"13",height:"13",stroke:"rgba(0,0,0,0)",fill:"rgba(0,0,0,0)",onmousedown:this.assignColor}),Le("rect",{x:"27.5",y:"46.5",width:"13",height:"13",stroke:"#000",fill:"none",set:ke(this,"noneButtonIndicatorElement")}),Le("rect",{x:"30.5",y:"49.5",width:"7",height:"7",stroke:"#000",fill:"#fff"}),Le("line",{x1:"32",y1:"55",x2:"36",y2:"51",stroke:"#f00",strokeWidth:"2",strokeLinecap:"round"}),Le("rect",{x:"27.5",y:"46.5",width:"13",height:"13",stroke:"rgba(0,0,0,0)",fill:"rgba(0,0,0,0)",onmousedown:this.assignNone})]}),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(_s,!0)),this.shadowRoot.appendChild(this.svg),t&&t.model&&this.setModel(t.model)}focusFillBox(){this.model&&(this.model.strokeOrFill=Rs.FILL),this.svg.removeChild(this.fillElement),this.svg.removeChild(this.fillNoneElement),this.svg.insertBefore(this.fillNoneElement,this.strokeHitBox.nextSibling),this.svg.insertBefore(this.fillElement,this.strokeHitBox.nextSibling)}focusStrokeBox(){this.model&&(this.model.strokeOrFill=Rs.STROKE),this.svg.removeChild(this.fillElement),this.svg.removeChild(this.fillNoneElement),this.svg.insertBefore(this.fillElement,this.strokeOuterFrame),this.svg.insertBefore(this.fillNoneElement,this.strokeOuterFrame)}swapStrokeAndFill(){if(!this.model)return;let t;this.model.modified.lock(),t=this.model.stroke,this.model.stroke=this.model.fill,this.model.fill=t,t=this.stroke,this.stroke=this.fill,this.fill=t,this.model.modified.trigger(),this.model.modified.unlock()}setDefaultStrokeAndFill(){this.model&&(this.model.modified.lock(),this.model.stroke="#000",this.model.fill="#fff",this.model.modified.unlock())}assignColor(){if(this.model){switch(this.model.modified.lock(),this.model.strokeOrFill){case Rs.STROKE:this.model.stroke=this.stroke;break;case Rs.FILL:this.model.fill=this.fill}this.model.modified.trigger(),this.model.modified.unlock()}}assignNone(){this.model&&this.model.set("none")}updateView(){this.model&&("none"!==this.model.stroke&&(this.stroke=this.model.stroke),"none"!==this.model.fill&&(this.fill=this.model.fill),this.noneButtonIndicatorElement.setAttributeNS("","fill","none"===this.model.get()?"#888":"#ddd"),this.colorButtonIndicatorElement.setAttributeNS("","fill","none"!==this.model.get()?"#888":"#ddd"),this.colorButtonElement.setAttributeNS("","fill",this.model.strokeOrFill===Rs.STROKE?this.stroke:this.fill),"none"===this.model.stroke?(this.strokeElement.setAttributeNS("","fill","#fff"),this.strokeElement.setAttributeNS("","stroke","#fff"),this.strokeNoneElement.setAttributeNS("","stroke","#f00")):(this.strokeElement.setAttributeNS("","fill",this.model.stroke),this.strokeElement.setAttributeNS("","stroke",this.model.stroke),this.strokeNoneElement.setAttributeNS("","stroke","none")),"none"===this.model.fill?(this.fillElement.setAttributeNS("","fill","#fff"),this.fillNoneElement.setAttributeNS("","stroke","#f00")):(this.fillElement.setAttributeNS("","fill",this.model.fill),this.fillNoneElement.setAttributeNS("","stroke","none")))}}e([Ts],Os.prototype,"focusFillBox",null),e([Ts],Os.prototype,"focusStrokeBox",null),e([Ts],Os.prototype,"swapStrokeAndFill",null),e([Ts],Os.prototype,"setDefaultStrokeAndFill",null),e([Ts],Os.prototype,"assignColor",null),e([Ts],Os.prototype,"assignNone",null),Os.define("toad-strokeandfill",Os);class Is extends li{}let ks=document.createElement("style");var Ds,Ls,Ms,Ps,Bs,Hs;ks.textContent="\n    :host: {\n        position: relative;\n    }\n\n    .stretch {\n        position: absolute;\n        left: 0;\n        top: 0;\n        right: 0;\n        bottom: 0;\n    }\n\n    .inputCatcher {\n        overflow: hidden;\n    }\n\n    .inputCatcher:focus {\n        /* the selected figure will have the outline */\n        outline: none;\n    }\n\n    .scrollView {\n        overflow: scroll;\n        /* use background color to hide the inputCatcher */\n        background: #fff;\n    }\n\n    .cursor-blink {\n      animation: cursor-blink 1s steps(1, start) infinite;\n    }\n\n    @keyframes cursor-blink {\n        50% { opacity: 0;       }\n            100% { opacity: 1; }\n    }\n",function(t){t[t.ADD_LAYERS=0]="ADD_LAYERS",t[t.REMOVE_LAYERS=1]="REMOVE_LAYERS",t[t.ADD_FIGURES=2]="ADD_FIGURES",t[t.DELETE_FIGURES=3]="DELETE_FIGURES",t[t.BRING_FIGURES_TO_FRONT=4]="BRING_FIGURES_TO_FRONT",t[t.BRING_FIGURES_TO_BACK=5]="BRING_FIGURES_TO_BACK",t[t.BRING_FIGURES_FORWARD=6]="BRING_FIGURES_FORWARD",t[t.BRING_FIGURES_BACKWARD=7]="BRING_FIGURES_BACKWARD",t[t.TRANSFORM_FIGURES=8]="TRANSFORM_FIGURES",t[t.UPDATE_FIGURES=9]="UPDATE_FIGURES",t[t.MOVE_HANDLE=10]="MOVE_HANDLE"}(Ds||(Ds={}));class Gs{constructor(t,e){this.figure=t,this.parent=e,this.path=void 0,this.svg=void 0}}class Vs extends hi{constructor(t){super(),this.cache=new Map,this.mouseIsDown=!1,this.bounds=new jt,this.zoom=1,this.inputCatcher=document.createElement("div"),this.inputCatcher.classList.add("stretch"),this.inputCatcher.classList.add("inputCatcher"),this.inputCatcher.contentEditable="true",this.inputCatcher.addEventListener("keydown",this.inputCatcherKeyDown),this.inputCatcher.addEventListener("keyup",this.inputCatcherKeyUp),this.inputCatcher.addEventListener("cut",this.clipboard),this.inputCatcher.addEventListener("copy",this.clipboard),this.inputCatcher.addEventListener("paste",this.clipboard),this.scrollView=document.createElement("div"),this.scrollView.classList.add("stretch"),this.scrollView.classList.add("scrollView"),this.scrollView.addEventListener("pointerdown",this.pointerDown),this.scrollView.addEventListener("pointermove",this.pointerMove),this.scrollView.addEventListener("pointerup",this.pointerUp),this.svgView=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.decorationOverlay=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgView.appendChild(this.decorationOverlay),this.scrollView.appendChild(this.svgView),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(ks,!0)),this.shadowRoot.appendChild(this.inputCatcher),this.shadowRoot.appendChild(this.scrollView),Pe(this,t),(null==t?void 0:t.tool)&&this.setModel(t.tool),(null==t?void 0:t.strokeandfill)&&this.setModel(t.strokeandfill),si("object|arrange|front",(()=>{this.model&&this.model.bringToFront(this.selectedLayer.id,bs.selection.figureIds())})),si("object|arrange|back",(()=>{this.model&&this.model.bringToBack(this.selectedLayer.id,bs.selection.figureIds())})),si("object|arrange|forward",(()=>{this.model&&this.model.bringForward(this.selectedLayer.id,bs.selection.figureIds())})),si("object|arrange|backward",(()=>{this.model&&this.model.bringBackward(this.selectedLayer.id,bs.selection.figureIds())}))}setTool(t){t!==this.tool&&(this.tool&&(bs.clearHint(),this.tool.deactivate(this)),this.tool=t,this.tool&&(this.isConnected?this.tool.activate(this):window.setTimeout((()=>{this.tool.activate(this)}),0)))}setModel(t){if(void 0===t)this.toolModel&&(this.toolModel.modified.remove(this),this.toolModel=void 0),this.strokeAndFillModel&&(this.strokeAndFillModel.modified.remove(this),this.strokeAndFillModel=void 0),super.setModel(void 0);else if(t instanceof Is){if(this.toolModel===t)return;this.toolModel=t,this.toolModel.modified.add((()=>{this.setTool(this.toolModel.value)}),this),this.setTool(this.toolModel.value)}else if(t instanceof Ns){if(this.strokeAndFillModel===t)return;this.strokeAndFillModel=t,this.strokeAndFillModel.modified.add((()=>{this.model.setStrokeAndFill(this.selectedLayer.id,bs.selection.figureIds(),this.strokeAndFillModel.stroke,this.strokeAndFillModel.fill)}),this)}else super.setModel(t)}updateView(t){if(void 0===this.model||0===this.model.layers.length)return;this.selectedLayer=this.model.layers[0],this.layer||(this.layer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.layer.style.cursor="inherit",this.svgView.insertBefore(this.layer,this.decorationOverlay));let e=this.layer;if(void 0===t){if(!this.model)throw Error("FigureEditor.updateView(): handling of removing a model hasn't been implemented yet");{let e=this.model.layers[0].data.filter((t=>!this.cache.has(t.id))).map((t=>t.id));t={operation:Ds.ADD_FIGURES,figures:e}}}switch(t.operation){case Ds.ADD_FIGURES:this.model.layers[0].data.forEach((t=>{!this.cache.has(t.id)&&this.cache.set(t.id,new Gs(t))}));for(let i of t.figures){let t=this.cache.get(i);if(!t)throw Error(`FigureEditor.updateView(): ADD_FIGURES cache lacks id ${i}`);if(t.figure instanceof Te)throw Error("FigureEditor.updateView(): ADD_FIGURES for groups not implemented yet");t.path||(t.path=t.figure.getPath(),t.figure.matrix&&t.path.transform(t.figure.matrix));let s=t.figure.updateSVG(t.path,e,t.svg);t.svg||(e.appendChild(s),t.svg=s)}break;case Ds.TRANSFORM_FIGURES:for(let i of t.figures){let s=this.cache.get(i);if(!s)throw Error("FigureEditor error: cache lacks id $id");if(s.figure instanceof Te)throw Error("FigureEditor.updateView(): ADD_FIGURES for groups not implemented yet");if(!s.path)throw Error("FigureEditor.updateView(): expected path in cache");if(!s.svg)throw Error("FigureEditor.updateView(): expected svg in cache");s.path,t.matrix,s.path.transform(t.matrix),s.svg=s.figure.updateSVG(s.path,e,s.svg)}break;case Ds.UPDATE_FIGURES:for(let i of t.figures){let t=this.cache.get(i);if(!t)throw Error("FigureEditor error: cache lacks id $id");if(t.figure instanceof Te)throw Error("FigureEditor.updateView(): UPDATE_FIGURES for groups not implemented yet");if(!t.path)throw Error("FigureEditor.updateView(): expected path in cache");if(!t.svg)throw Error("FigureEditor.updateView(): expected svg in cache");t.path=t.figure.getPath(),t.figure.matrix&&t.path.transform(t.figure.matrix),t.svg=t.figure.updateSVG(t.path,e,t.svg)}break;case Ds.DELETE_FIGURES:for(let i of t.figures){let t=this.cache.get(i);if(!t)throw Error("FigureEditor error: cache lacks id $id");void 0!==t.svg&&e.removeChild(t.svg),this.cache.delete(i)}break;case Ds.BRING_FIGURES_TO_FRONT:this.removeFromLayer(e,t.figures).forEach((t=>e.appendChild(t)));break;case Ds.BRING_FIGURES_TO_BACK:{const i=this.removeFromLayer(e,t.figures);if(0===e.childNodes.length)i.reverse(),i.forEach((t=>e.appendChild(t)));else{const t=e.childNodes[0];i.forEach((i=>e.insertBefore(i,t)))}}break;case Ds.BRING_FIGURES_FORWARD:{const i=this.removeFromLayerWithIndex(e,t.figures);for(let t=0;t<i.figures.length;++t)i.index[t]<e.childNodes.length?e.insertBefore(i.figures[t],e.childNodes[i.index[t]]):e.appendChild(i.figures[t])}break;case Ds.BRING_FIGURES_BACKWARD:{const i=this.removeFromLayerWithIndex(e,t.figures);for(let s=0;s<t.figures.length;++s){let t=i.index[s];t<0&&(t=0),e.insertBefore(i.figures[s],e.childNodes[t])}}}setTimeout((()=>{this.bounds.expandByPoint({x:this.scrollView.offsetWidth,y:this.scrollView.offsetHeight}),this.svgView.style.width=this.bounds.size.width+"px",this.svgView.style.height=this.bounds.size.height+"px",this.adjustBounds(),this.scrollView.scrollLeft=-this.bounds.origin.x,this.scrollView.scrollTop=-this.bounds.origin.y}),0)}removeFromLayer(t,e){const i=[];for(let s of e){let e=this.cache.get(s);if(!e)throw Error("FigureEditor error: cache lacks id $id");if(void 0===e.svg)throw Error("yikes");t.removeChild(e.svg),i.push(e.svg)}return i}removeFromLayerWithIndex(t,e){const i={figures:[],index:[]},s=new Map;this.selectedLayer.data.forEach(((t,e)=>s.set(t,e)));for(let o of e){let e=this.cache.get(o);if(!e)throw Error("FigureEditor error: cache lacks id $id");if(void 0===e.svg)throw Error("yikes");t.removeChild(e.svg),i.figures.push(e.svg),i.index.push(s.get(e.figure))}return i}adjustBounds(){if(!this.model)return;let t=new jt;t.expandByPoint({x:this.scrollView.offsetWidth/this.zoom,y:this.scrollView.offsetHeight/this.zoom});for(let e of this.model.layers[0].data)t.expandByRectangle(e.bounds());t.expandByPoint({x:this.bounds.origin.x+this.scrollView.scrollLeft,y:this.bounds.origin.y+this.scrollView.scrollTop}),t.expandByPoint({x:this.bounds.origin.x+this.scrollView.scrollLeft+this.scrollView.clientWidth/this.zoom,y:this.bounds.origin.y+this.scrollView.scrollTop+this.scrollView.clientHeight/this.zoom});let e=this.bounds.origin.x+this.scrollView.scrollLeft-t.origin.x,i=this.bounds.origin.y+this.scrollView.scrollTop-t.origin.y,s=String(this.zoom),o="scale("+s+" "+s+")";this.layer.setAttributeNS("","transform","translate("+-t.origin.x+" "+-t.origin.y+") "+o),this.decorationOverlay.setAttributeNS("","transform","translate("+-t.origin.x+" "+-t.origin.y+") "+o),this.svgView.style.width=t.size.width*this.zoom+"px",this.svgView.style.height=t.size.height*this.zoom+"px",this.scrollView.scrollLeft=e,this.scrollView.scrollTop=i,this.bounds=t}transformSelection(t){this.model.transform(this.selectedLayer.id,bs.selection.figureIds(),t)}deleteSelection(){this.model.delete(this.selectedLayer.id,bs.selection.figureIds())}addFigure(t){this.model.add(this.selectedLayer.id,t)}getPath(t){var e;return null===(e=this.cache.get(t.id))||void 0===e?void 0:e.path}getSVG(t){var e;return null===(e=this.cache.get(t.id))||void 0===e?void 0:e.svg}focus(t){this.inputCatcher.focus(t)}pointerDown(t){if(this.scrollView.setPointerCapture(t.pointerId),this.inputCatcher.focus({preventScroll:!0}),t.preventDefault(),this.mouseIsDown=!0,this.tool&&this.selectedLayer){const e=this.createEditorPointerEvent(t);this.mouseDownAt=e,this.tool.pointerEvent(e)}}pointerMove(t){t.preventDefault(),this.tool&&this.selectedLayer&&this.tool.pointerEvent(this.createEditorPointerEvent(t))}pointerUp(t){t.preventDefault(),this.mouseIsDown=!1,this.tool&&this.selectedLayer&&this.tool.pointerEvent(this.createEditorPointerEvent(t))}createEditorPointerEvent(t){let e;switch(t.type){case"pointermove":e="move";break;case"pointerdown":e="down";break;case"pointerup":e="up";break;default:throw Error(`FigureEditor.createEditorPointerEvent(): unexpected event type '${t.type}'`)}let i=this.scrollView.getBoundingClientRect();return{editor:this,x:(t.clientX+.5-i.left+this.scrollView.scrollLeft+this.bounds.origin.x)/this.zoom,y:(t.clientY+.5-i.top+this.scrollView.scrollTop+this.bounds.origin.y)/this.zoom,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey,ctrlKey:t.ctrlKey,pressure:t.pressure,tiltX:t.tiltX,tiltY:t.tiltY,twist:t.twist,pointerId:t.pointerId,pointerType:t.pointerType,pointerDown:this.mouseIsDown,type:e}}inputCatcherKeyDown(t){!0!==t.metaKey&&"Dead"!==t.key&&this.tool&&this.selectedLayer&&(this.tool.keydown(new Cs(this,t)),this.inputCatcher.textContent="")}inputCatcherKeyUp(t){!0!==t.metaKey&&"Dead"!==t.key&&this.tool&&this.selectedLayer&&(this.tool.keyup(new Cs(this,t)),this.inputCatcher.textContent="")}clipboard(t){this.tool&&this.selectedLayer&&this.tool.clipboard(this,t)}}function Fs(t,e){return It(t,It(e,t))}e([Ts],Vs.prototype,"pointerDown",null),e([Ts],Vs.prototype,"pointerMove",null),e([Ts],Vs.prototype,"pointerUp",null),e([Ts],Vs.prototype,"inputCatcherKeyDown",null),e([Ts],Vs.prototype,"inputCatcherKeyUp",null),e([Ts],Vs.prototype,"clipboard",null),Vs.define("toad-figureeditor",Vs),function(t){t[t.DEFAULT=0]="DEFAULT",t[t.READY=1]="READY",t[t.ACTIVE=2]="ACTIVE",t[t.DIRECT=3]="DIRECT"}(Ls||(Ls={})),function(t){t[t.READY=0]="READY",t[t.DOWN_ADD_FIRST_ANCHOR=1]="DOWN_ADD_FIRST_ANCHOR",t[t.DOWN_DRAG_FIRST_ANCHOR=2]="DOWN_DRAG_FIRST_ANCHOR",t[t.ACTIVE=3]="ACTIVE",t[t.DOWN_ADD_ANCHOR=4]="DOWN_ADD_ANCHOR",t[t.DOWN_DRAG_ANCHOR=5]="DOWN_DRAG_ANCHOR",t[t.DOWN_DRAG_EDGE=6]="DOWN_DRAG_EDGE",t[t.DOWN_DRAG_LINE=7]="DOWN_DRAG_LINE",t[t.DOWN_CLOSE_EDGE=8]="DOWN_CLOSE_EDGE",t[t.DRAG_CLOSE_EDGE=9]="DRAG_CLOSE_EDGE",t[t.DOWN_CLOSE_CURVE=10]="DOWN_CLOSE_CURVE",t[t.DRAG_CLOSE_CURVE=11]="DRAG_CLOSE_CURVE"}(Ms||(Ms={})),function(t){t[t.PREVIOUS_FORWARD=0]="PREVIOUS_FORWARD",t[t.CURRENT_BACKWARD=1]="CURRENT_BACKWARD",t[t.CURRENT_FORWARD=2]="CURRENT_FORWARD",t[t.NEXT_BACKWARD=3]="NEXT_BACKWARD"}(Ps||(Ps={}));class $s extends bs{constructor(){super(),this.state=Ms.READY,this.anchors=[],this._handlePos=new Array(4),this._handles=new Array(4),this.lines=new Array(4)}activate(t){bs.selection.clear(),this.setCursor(t,Ls.READY),bs.setHint("technical pen: <pointer>down</pointer>: add anchor, <pointer>drag</pointer>: smooth anchor, <alt/>+<pointer>drag</pointer>: sharp anchor")}deactivate(t){this.clear(t),this.setCursor(t,Ls.DEFAULT)}keydown(t){if(this.state===Ms.DOWN_DRAG_ANCHOR)if("Alt"===t.value)this.state=Ms.DOWN_DRAG_EDGE}keyup(t){if(this.state===Ms.DOWN_DRAG_EDGE)if("Alt"===t.value){this.state=Ms.DOWN_DRAG_ANCHOR;const e=t.editor.mouseDownAt,i=Fs(e,this.getHandlePos(Ps.CURRENT_FORWARD));this._outline.updateSymmetric(i),this.updateSVG(t.editor),this.updateHandle(Ps.CURRENT_BACKWARD,e,i)}}pointerEvent(t){switch(this.state){case Ms.READY:if("down"===t.type)this.prepareEditor(t),this.setCursor(t.editor,Ls.DIRECT),this.state=Ms.DOWN_ADD_FIRST_ANCHOR,this.addAnchor(t),this._outline.addEdge(t),this.updateSVG(t.editor),this.figure.addEdge(t);break;case Ms.DOWN_ADD_FIRST_ANCHOR:switch(t.type){case"move":if($t(t.editor.mouseDownAt,t)>Yt.DRAG_START_DISTANCE){this.state=Ms.DOWN_DRAG_FIRST_ANCHOR;const e=t.editor.mouseDownAt,i=t,s=Fs(e,i);this.updateHandle(Ps.CURRENT_FORWARD,e,i),this.updateHandle(Ps.CURRENT_BACKWARD,e,s)}break;case"up":this.setCursor(t.editor,Ls.ACTIVE),this.state=Ms.ACTIVE}break;case Ms.DOWN_DRAG_FIRST_ANCHOR:switch(t.type){case"move":{const e=t.editor.mouseDownAt,i=t,s=Fs(e,i);this.updateHandle(Ps.CURRENT_FORWARD,e,i),this.updateHandle(Ps.CURRENT_BACKWARD,e,s)}break;case"up":{this.setCursor(t.editor,Ls.ACTIVE),this.state=Ms.ACTIVE;const e=t;this._outline.changeEdgeToEdgeAngle(e),this.figure.changeEdgeToEdgeAngle(e)}}break;case Ms.ACTIVE:if("down"===t.type)if(this.isFirstAnchor(t)){switch(this.setCursor(t.editor,Ls.DIRECT),this._outline.types[0]){case Re.AnchorType.ANCHOR_EDGE:this.state=Ms.DOWN_CLOSE_EDGE;break;case Re.AnchorType.ANCHOR_EDGE_ANGLE:this.state=Ms.DOWN_CLOSE_CURVE;const t={x:this._outline.values[0],y:this._outline.values[1]},e={x:this._outline.values[2],y:this._outline.values[3]};this.updateHandle(Ps.CURRENT_FORWARD,t,e),this.updateHandle(Ps.CURRENT_BACKWARD);break;default:throw Error(`PenTool: mousedown at state ACTIVE unexpected 1st anchor of type ${Re.AnchorType[this._outline.types[0]]}`)}this._outline.addClose(),this.updateSVG(t.editor)}else this.setCursor(t.editor,Ls.DIRECT),this.state=Ms.DOWN_ADD_ANCHOR,this.addAnchor(t),this._outline.addEdge(t),this.updateSVG(t.editor),this.figure.addEdge(t),this.switchHandle(Ps.CURRENT_FORWARD,Ps.PREVIOUS_FORWARD),this.updateHandle(Ps.CURRENT_BACKWARD);break;case Ms.DOWN_ADD_ANCHOR:switch(t.type){case"move":if($t(t.editor.mouseDownAt,t)>Yt.DRAG_START_DISTANCE){this.state=Ms.DOWN_DRAG_ANCHOR;const e=t.editor.mouseDownAt,i=t,s=Fs(e,i);this._outline.changeEdgeToSymmetric(s),this.updateSVG(t.editor),this.updateHandle(Ps.CURRENT_FORWARD,e,i),this.updateHandle(Ps.CURRENT_BACKWARD,e,s)}break;case"up":this.setCursor(t.editor,Ls.ACTIVE),this.state=Ms.ACTIVE,t.editor.model.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]})}break;case Ms.DOWN_DRAG_ANCHOR:switch(t.type){case"move":{const e=t.editor.mouseDownAt,i=t,s=Fs(e,i);this._outline.updateSymmetric(s),this.updateSVG(t.editor),this.updateHandle(Ps.CURRENT_FORWARD,e,i),this.updateHandle(Ps.CURRENT_BACKWARD,e,s)}break;case"up":{this.setCursor(t.editor,Ls.ACTIVE),this.state=Ms.ACTIVE;const e=Fs(t.editor.mouseDownAt,t);this._outline.updateSymmetric(e),this.updateSVG(t.editor),this.figure.changeEdgeToSymmetric(e),t.editor.model.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]})}}break;case Ms.DOWN_DRAG_EDGE:switch(t.type){case"move":{const e=t.editor.mouseDownAt,i=t;this.updateHandle(Ps.CURRENT_FORWARD,e,i)}break;case"up":{this.state=Ms.ACTIVE,this.setCursor(t.editor,Ls.ACTIVE);const e=this.getHandlePos(Ps.CURRENT_BACKWARD),i=t;this._outline.changeSymmetricToSmoothAngleAngle(i),this.figure.changeEdgeToSmoothAngleAngle(e,i),t.editor.model.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]})}}break;case Ms.DOWN_CLOSE_EDGE:switch(t.type){case"move":if($t(t.editor.mouseDownAt,t)>Yt.DRAG_START_DISTANCE){this.state=Ms.DRAG_CLOSE_EDGE;const e=t.editor.mouseDownAt,i=Fs(e,t);this.updateHandle(Ps.CURRENT_BACKWARD,e,i),this._outline.changeEdgeToAngleEdge(0,i),this.updateSVG(t.editor)}break;case"up":this.state=Ms.READY,this.setCursor(t.editor,Ls.READY),this.figure.addClose(),t.editor.model.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]})}break;case Ms.DRAG_CLOSE_EDGE:switch(t.type){case"move":{const e=t.editor.mouseDownAt,i=Fs(e,t);this.updateHandle(Ps.CURRENT_BACKWARD,e,i),this._outline.updateAngleEdge(0,i),this.updateSVG(t.editor)}break;case"up":{this.setCursor(t.editor,Ls.READY),this.state=Ms.READY;const e=t.editor.mouseDownAt,i=Fs(e,t);this.updateHandle(Ps.CURRENT_BACKWARD,e,i),this._outline.updateAngleEdge(0,i),this.updateSVG(t.editor),this.figure.addClose(),this.figure.changeEdgeToAngleEdge(0,i),t.editor.model.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]})}}break;case Ms.DOWN_CLOSE_CURVE:switch(t.type){case"move":if($t(t.editor.mouseDownAt,t)>Yt.DRAG_START_DISTANCE){this.state=Ms.DRAG_CLOSE_CURVE;const e=t,i={x:this.figure.values[0],y:this.figure.values[1]};let s={x:this.figure.values[2],y:this.figure.values[3]};const o=Fs(i,e),r=$t(i,o),n=$t(i,s);s=Ot(i,Dt(It(e,i),n/r)),this.updateHandle(Ps.CURRENT_FORWARD,i,s),this.updateHandle(Ps.CURRENT_BACKWARD,i,o),this._outline.changeEdgeAngleToSmooth(0,o,s),this.updateSVG(t.editor)}break;case"up":this.state=Ms.READY,this.setCursor(t.editor,Ls.READY),this.figure.addClose(),t.editor.model.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]})}break;case Ms.DRAG_CLOSE_CURVE:switch(t.type){case"move":{const e=t,i={x:this.figure.values[0],y:this.figure.values[1]};let s={x:this.figure.values[2],y:this.figure.values[3]};const o=Fs(i,e),r=$t(i,o),n=$t(i,s);s=Ot(i,Dt(It(e,i),n/r)),this.updateHandle(Ps.CURRENT_FORWARD,i,s),this.updateHandle(Ps.CURRENT_BACKWARD,i,o),this._outline.updateSmooth(0,o,s),this.updateSVG(t.editor)}break;case"up":{this.setCursor(t.editor,Ls.READY),this.state=Ms.READY;const e=t,i={x:this.figure.values[0],y:this.figure.values[1]};let s={x:this.figure.values[2],y:this.figure.values[3]};const o=Fs(i,e),r=$t(i,o),n=$t(i,s);s=Ot(i,Dt(It(e,i),n/r)),this.updateHandle(Ps.CURRENT_FORWARD,i,s),this.updateHandle(Ps.CURRENT_BACKWARD,i,o),this._outline.updateSmooth(0,o,s),this.figure.addClose(),this.figure.changeEdgeAngleToSmooth(0,o,s),t.editor.model.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]})}}}}prepareEditor(t){this.clear(t.editor),bs.selection.clear(),this.decoration=document.createElementNS("http://www.w3.org/2000/svg","g"),this.decoration.id="pen-tool-decoration",this.updateBoundary(),t.editor.decorationOverlay.appendChild(this.decoration),this._outline=new Ne,this.svg=this._outline.getPath().createSVG(),this.setOutlineColors(this.svg),this.decoration.appendChild(this.svg),this.figure=new Ne,t.editor.strokeAndFillModel&&(this.figure.stroke=t.editor.strokeAndFillModel.stroke,this.figure.fill=t.editor.strokeAndFillModel.fill),t.editor.addFigure(this.figure)}clear(t){this.state=Ms.READY,this.anchors=[],this._handles=new Array(4),this.lines=new Array(4),this.decoration&&t.decorationOverlay.removeChild(this.decoration),this.decoration=void 0,this._outline=void 0,this.svg=void 0}setCursor(t,e){switch(e){case Ls.DEFAULT:t.svgView.style.cursor="";break;case Ls.READY:t.svgView.style.cursor=`url(${bs.cursorPath}pen-ready.svg) 5 1, crosshair`;break;case Ls.ACTIVE:t.svgView.style.cursor=`url(${bs.cursorPath}pen-active.svg) 5 1, crosshair`;break;case Ls.DIRECT:t.svgView.style.cursor=`url(${bs.cursorPath}direct-selection-cursor.svg) 1 1, crosshair`}}createAnchor(t){let e=t.x-Yt.HANDLE_RANGE/2,i=t.y-Yt.HANDLE_RANGE/2;e=Math.round(e-.5)+.5,i=Math.round(i-.5)+.5;let s=document.createElementNS("http://www.w3.org/2000/svg","rect");return s.setAttributeNS("","x",`${e}`),s.setAttributeNS("","y",`${i}`),s.setAttributeNS("","width",`${Yt.HANDLE_RANGE}`),s.setAttributeNS("","height",`${Yt.HANDLE_RANGE}`),s.setAttributeNS("","stroke","rgb(79,128,255)"),s.setAttributeNS("","fill","#fff"),s}addAnchor(t){this.anchors.length>1&&(this.anchors[this.anchors.length-1].style.cursor="");const e=this.createAnchor(t);0===this.anchors.length?e.style.cursor=`url(${bs.cursorPath}pen-close.svg) 5 1, crosshair`:e.style.cursor=`url(${bs.cursorPath}pen-edge.svg) 5 1, crosshair`,this.decoration.appendChild(e),this.anchors.push(e)}isFirstAnchor(t){if(0===this.anchors.length)return!1;const e=this.anchors[0];return new jt(Number.parseFloat(e.getAttributeNS(null,"x")),Number.parseFloat(e.getAttributeNS(null,"y")),Number.parseFloat(e.getAttributeNS(null,"width")),Number.parseFloat(e.getAttributeNS(null,"height"))).inside(t)}isLastAnchor(t){if(0===this.anchors.length)return!1;const e=this.anchors[this.anchors.length-1];return new jt(Number.parseFloat(e.getAttributeNS(null,"x")),Number.parseFloat(e.getAttributeNS(null,"y")),Number.parseFloat(e.getAttributeNS(null,"width")),Number.parseFloat(e.getAttributeNS(null,"height"))).inside(t)}_createHandle(t){const e=Math.round(t.x-.5)+.5,i=Math.round(t.y-.5)+.5,s=document.createElementNS("http://www.w3.org/2000/svg","circle");return s.setAttributeNS("","cx",`${e}`),s.setAttributeNS("","cy",`${i}`),s.setAttributeNS("","r",""+Yt.HANDLE_RANGE/2),s.setAttributeNS("","stroke","rgb(79,128,255)"),s.setAttributeNS("","fill","rgb(79,128,255)"),s}updateHandle(t,e,i){if(void 0!==e){if(void 0===i)throw Error("yikes");if(this._handlePos[t]=i,void 0===this._handles[t])this._handles[t]=this._createHandle(i),this.decoration.appendChild(this._handles[t]),this.lines[t]=this.createLine(e,i),this.decoration.appendChild(this.lines[t]);else{this._handles[t].style.display="",this.lines[t].style.display="";const s=Math.round(i.x-.5)+.5,o=Math.round(i.y-.5)+.5;this._handles[t].setAttributeNS("","cx",`${s}`),this._handles[t].setAttributeNS("","cy",`${o}`),this.lines[t].setAttributeNS("","x1",`${e.x}`),this.lines[t].setAttributeNS("","y1",`${e.y}`),this.lines[t].setAttributeNS("","x2",`${i.x}`),this.lines[t].setAttributeNS("","y2",`${i.y}`)}}else void 0!==this._handles[t]&&(this._handles[t].style.display="none",this.lines[t].style.display="none")}switchHandle(t,e){[this._handles[t],this._handles[e],this.lines[t],this.lines[e],this._handlePos[t],this._handlePos[e]]=[this._handles[e],this._handles[t],this.lines[e],this.lines[t],this._handlePos[e],this._handlePos[t]],this.updateHandle(t)}getHandlePos(t){return this._handlePos[t]}createLine(t,e){const i=document.createElementNS("http://www.w3.org/2000/svg","line");return i.setAttributeNS("","x1",`${t.x}`),i.setAttributeNS("","y1",`${t.y}`),i.setAttributeNS("","x2",`${e.x}`),i.setAttributeNS("","y2",`${e.y}`),i.setAttributeNS("","stroke","rgb(79,128,255)"),i}updateSVG(t){this._outline.getPath().updateSVG(t.decorationOverlay,this.svg)}}class Us extends bs{constructor(t){super(),this.creator=t}activate(t){bs.selection.clear(),bs.setHint(`${this.creator.name.toLowerCase()} tool: <pointer>drag</pointer> to add ${this.creator.name.toLowerCase()}`)}pointerdown(t){this.shape=new this.creator,this.shape.setHandlePosition(0,t),this.shape.setHandlePosition(2,t),t.editor.strokeAndFillModel&&(this.shape.stroke=t.editor.strokeAndFillModel.stroke,this.shape.fill=t.editor.strokeAndFillModel.fill);let e=this.shape.getPath();this.svg=this.shape.updateSVG(e,t.editor.decorationOverlay),t.editor.decorationOverlay.appendChild(this.svg)}pointermove(t){if(!t.pointerDown)return;let e=this.shape;e.setHandlePosition(2,t);let i=e.getPath();e.updateSVG(i,t.editor.decorationOverlay,this.svg)}pointerup(t){let e=this.shape;e.setHandlePosition(2,t),e.size.width<0&&(e.origin.x+=e.size.width,e.size.width=-e.size.width),e.size.height<0&&(e.origin.y+=e.size.height,e.size.height=-e.size.height),t.editor.decorationOverlay.removeChild(this.svg),t.editor.addFigure(e),this.shape=void 0,this.svg=void 0}}class Ws{constructor(t,e){this.selectionOffsetWord=null,this.selectionOffsetChar=0,this.text=e,this.svgParent=t.getSVG(e),this.textSource=e.textSource,this.boxes=e.textSource.wordBoxes,this.position=new Tt,this.xDuringVerticalMovement=void 0,this.offsetWord=0,this.offsetChar=0,this.svgCursor=this.createCursor(),this.updateCursor(),t.decorationOverlay.appendChild(this.svgCursor)}hasSelection(){return null!==this.selectionOffsetWord}createCursor(){let t=document.createElementNS("http://www.w3.org/2000/svg","line");return t.setAttributeNS("","stroke","#000"),t}stop(){this.svgCursor&&(this.svgCursor.parentElement.removeChild(this.svgCursor),this.svgCursor=void 0),this.svgSelection&&(this.svgSelection.parentElement.removeChild(this.svgSelection),this.svgSelection=void 0),this.selectionOffsetWord=null}mousedown(t){this.offsetWord=0,this.offsetChar=0,this.goNearY(t.y)&&this.goNearX(t.x),this.selectionOffsetWord=this.offsetWord,this.selectionOffsetChar=this.offsetChar,this.updateCursor()}mousemove(t){this.offsetWord=0,this.offsetChar=0,this.goNearY(t.y)&&(this.goNearX(t.x),this.updateCursor())}updateSelection(t){void 0===t||t.shift?null===this.selectionOffsetWord&&(this.selectionOffsetWord=this.offsetWord,this.selectionOffsetChar=this.offsetChar):this.selectionOffsetWord=null}keydown(t){if(t.preventDefault(),"Home"===t.code||t.ctrl&&"KeyA"===t.code)return this.updateSelection(t),this.moveCursorBOL(),void this.updateCursor();if("End"===t.code||t.ctrl&&"KeyE"===t.code)return this.updateSelection(t),this.moveCursorEOL(),void this.updateCursor();switch(t.code){case"ArrowRight":this.updateSelection(t),this.moveCursorRight(),this.updateCursor();break;case"ArrowLeft":this.updateSelection(t),this.moveCursorLeft(),this.updateCursor();break;case"Backspace":null!==this.selectionOffsetWord||(this.updateSelection(),this.moveCursorLeft()),this.deleteSelectedText(),this.textSource.reset(),new Ae(t.editor.getPath(this.text),this.textSource),this.textSource.updateSVG(),this.updateCursor();break;case"Delete":null!==this.selectionOffsetWord||(this.updateSelection(),this.moveCursorRight()),this.deleteSelectedText(),this.textSource.reset(),new Ae(t.editor.getPath(this.text),this.textSource),this.textSource.updateSVG(),this.updateCursor();break;default:1==t.value.length&&(this.insertText(t.value),this.textSource.reset(),new Ae(t.editor.getPath(this.text),this.textSource),this.textSource.updateSVG(),this.updateCursor())}switch(t.code){case"ArrowDown":this.updateSelection(t),void 0===this.xDuringVerticalMovement&&(this.xDuringVerticalMovement=this.position.x),this.gotoNextRow()&&(this.goNearX(this.xDuringVerticalMovement),this.updateCursor());break;case"ArrowUp":this.updateSelection(t),void 0===this.xDuringVerticalMovement&&(this.xDuringVerticalMovement=this.position.x),this.gotoPreviousRow()&&(this.goNearX(this.xDuringVerticalMovement),this.updateCursor());break;default:this.xDuringVerticalMovement=void 0}}clipboard(t,e){switch(e.type){case"cut":this.cut(t,e);break;case"copy":this.copy(e);break;case"paste":this.paste(t,e)}}cut(t,e){e.clipboardData&&this.hasSelection()&&(this.copy(e),this.deleteSelectedText(),this.text.textSource.reset(),new Ae(t.getPath(this.text),this.text.textSource),this.textSource.updateSVG(),this.updateCursor())}copy(t){if(!t.clipboardData)return;if(!this.hasSelection())return;const[e,i,s,o]=this.getSelection();if(e===s){const s=this.text.textSource.wordBoxes[e].word;t.clipboardData.setData("text/plain",s.substr(i,o-i))}else{const r=this.text.textSource.wordBoxes;let n=r[e].word.substr(i)+" ";for(let t=e+1;t<s;++t)n+=r[t].word+" ";n+=r[s].word.substr(0,o),t.clipboardData.setData("text/plain",n)}t.preventDefault()}paste(t,e){const i=Array.from(e.clipboardData.items).filter((t=>"string"===t.kind&&"text/plain"===t.type)).shift();void 0!==i&&i.getAsString((e=>{this.insertText(e),this.text.textSource.reset(),new Ae(t.getPath(this.text),this.text.textSource),this.text.textSource.updateSVG(),this.updateCursor()}))}insertText(t){null!==this.selectionOffsetWord&&this.deleteSelectedText();let e=[];if(Ce.splitTextIntoWordBoxes(e,t),0===e.length)return;let i=this.boxes[this.offsetWord],s=i.word.substr(this.offsetChar);i.word=i.word.substr(0,this.offsetChar),i.word+=e[0].word,e.length>1||0==e[0].word.length?(e.length>1&&e.splice(0,1),this.offsetChar=e[e.length-1].word.length,this.offsetWord=this.offsetWord+=e.length,e[e.length-1].word+=s,this.textSource.wordBoxes.splice(this.offsetWord+1,0,...e)):(this.offsetChar=i.word.length,i.word+=s),i.svg&&(i.svg.textContent=i.word)}moveCursorRight(){++this.offsetChar,this.offsetChar>this.boxes[this.offsetWord].word.length&&(this.offsetWord>=this.boxes.length||this.boxes[this.offsetWord].endOfWrap?--this.offsetChar:(this.offsetChar=0,++this.offsetWord))}moveCursorLeft(){if((0!==this.offsetWord||0!==this.offsetChar)&&(--this.offsetChar,this.offsetChar<0)){--this.offsetWord;const t=this.boxes[this.offsetWord];this.offsetChar=t.word.length}}moveCursorBOL(){let t=this.offsetWord;for(;;){if(t>0&&this.boxes[t-1].endOfLine||0===t){this.offsetWord=t,this.offsetChar=0;break}--t}}moveCursorEOL(){let t=this.offsetWord;for(;;){if(t===this.boxes.length-1||this.boxes[t].endOfLine||this.boxes[t].endOfWrap){this.offsetWord=t,this.offsetChar=this.boxes[t].word.length;break}++t}}deleteSelectedText(){var t;const[e,i,s,o]=this.getSelection();if(e===s){const t=this.textSource.wordBoxes[e];t.word=t.word.substring(0,i)+t.word.substring(o),void 0!==t.svg&&(t.svg.textContent=t.word)}else{const r=this.textSource.wordBoxes[e],n=this.textSource.wordBoxes[s];r.word=r.word.substring(0,i)+n.word.substring(o),void 0!==r.svg&&(r.svg.textContent=r.word);for(let i=e+1;i<s;++i){const e=this.textSource.wordBoxes[i];e.svg&&(null===(t=e.svg.parentElement)||void 0===t||t.removeChild(e.svg),e.svg=void 0)}this.textSource.wordBoxes.splice(e+1,s-e)}this.offsetWord=e,this.offsetChar=i,this.selectionOffsetWord=null}gotoNextRow(){let t=this.offsetWord;for(;t<this.boxes.length&&!this.boxes[t++].endOfLine;);return!(t>=this.boxes.length||this.boxes[t-1].endOfWrap)&&(this.offsetWord=t,this.offsetChar=0,!0)}gotoPreviousRow(){let t=this.offsetWord;for(;t>0&&!this.boxes[t-1].endOfLine;)--t;if(0==t)return!1;for(--t;t>0&&!this.boxes[t-1].endOfLine;)--t;return this.offsetWord=t,this.offsetChar=0,!0}goNearY(t){let e=0,i=Number.MIN_VALUE;for(let s=0;s<this.boxes.length;++s){let o=this.boxes[s];if(i=Math.max(i,o.origin.y+o.size.height),o.endOfLine){if(t<=i)return this.offsetWord=e,!0;if(i=Number.MIN_VALUE,s+1>=this.boxes.length||o.endOfWrap)break;e=s+1}}return this.offsetWord=e,!0}goNearX(t){let e=this.offsetWord,i=this.offsetChar;for(;;){let s=this.boxes[e];if(t>s.origin.x+s.size.width){if(s.endOfLine){i=s.word.length;break}if(++e,e===this.boxes.length){i=s.word.length,--e;break}continue}if(e!=this.offsetWord&&t<s.origin.x){let o=this.boxes[e-1],r=o.origin.x+o.size.width;s.origin.x-t>=t-r?(e-=1,i=o.word.length):i=0;break}i=-1;let o=s.origin.x;for(let e=1;e<=s.word.length;++e){let r=s.origin.x+s.svg.getSubStringLength(0,e);if(t<r){i=r-t>=t-o?e-1:e;break}o=r}-1==i&&(i=s.word.length);break}this.offsetWord=e,this.offsetChar=i}getSelection(){if(null===this.selectionOffsetWord)throw Error("no selection");let[t,e]=[this.offsetWord,this.offsetChar],[i,s]=[this.selectionOffsetWord,this.selectionOffsetChar];return t>i||t===i&&e>s?[i,s,t,e]:[t,e,i,s]}updateCursor(){var t;const[e,i,s]=this.offsetToScreen(this.offsetWord,this.offsetChar);if(null===this.selectionOffsetWord)this.svgSelection&&(null===(t=this.svgSelection.parentElement)||void 0===t||t.removeChild(this.svgSelection),this.svgSelection=void 0);else{let[t,e,i,s]=this.getSelection();const o=new ge;let r=t;for(;r<=i;){const n=this.boxes[r];if(n.endOfLine||n.endOfSlice||r===i){const[l,a,h]=this.offsetToScreen(t,e);let d,c,u;[d,c,u]=r<i?this.offsetToScreen(r,n.word.length):this.offsetToScreen(r,s),o.move(l,a+h).line(l,a).line(d,c).line(d,c+u).close(),[t,e]=[r+1,0]}++r}void 0===this.svgSelection?(this.svgSelection=o.createSVG("#b3d7ff",1,"#b3d7ff"),this.svgParent.insertBefore(this.svgSelection,this.svgParent.children[0])):o.updateSVG(this.svgParent,this.svgSelection)}this.position.x=e,this.position.y=i;const o=`${Math.round(e)+.5}`,r=`${Math.round(i)+.5}`,n=`${Math.round(i+s)+.5}`;this.svgCursor.setAttributeNS("","x1",o),this.svgCursor.setAttributeNS("","y1",r),this.svgCursor.setAttributeNS("","x2",o),this.svgCursor.setAttributeNS("","y2",n),this.pauseCaretAnimation()}offsetToScreen(t,e){let i,s=this.boxes[t];return i=0===s.word.length||0===e?0:s.svg.getSubStringLength(0,e),[s.origin.x+i,s.origin.y,s.size.height]}pauseCaretAnimation(){this.timer&&(window.clearTimeout(this.timer),this.timer=void 0),this.svgCursor.classList.remove("cursor-blink"),this.timer=window.setTimeout((()=>{this.svgCursor.classList.add("cursor-blink"),this.timer=void 0}),500)}}!function(t){t[t.NONE=0]="NONE",t[t.EDIT=1]="EDIT",t[t.AREA=2]="AREA",t[t.SHAPE=3]="SHAPE",t[t.PATH=4]="PATH"}(Bs||(Bs={})),function(t){t[t.NONE=0]="NONE",t[t.AREA=1]="AREA",t[t.EDIT=2]="EDIT"}(Hs||(Hs={}));class zs extends bs{constructor(){super(),this.state=Hs.NONE,this.currentCursor=Bs.NONE}activate(t){this.state=Hs.NONE,bs.setHint("type tool: <pointer>drag</pointer> to add text area")}deactivate(t){this.stopEdit(t),this.setCursor(Bs.NONE,t.svgView),t.svgView.style.cursor="default",this.removeOutlines(t),this.removeDecoration(t)}pointerdown(t){let e=t.editor.selectedLayer.findFigureAt(t);void 0===e?(this.state=Hs.AREA,this.startDrawTextArea(t)):e instanceof Se&&(this.figure=e,this.state=Hs.EDIT,this.startEdit(t.editor),this.texteditor.mousedown(t),bs.selection.set(e),this.updateDecorationOfSelection(t.editor))}pointermove(t){switch(this.state){case Hs.EDIT:if(t.editor.mouseIsDown)return void this.texteditor.mousemove(t);case Hs.NONE:this.setCursorBasedOnFigureBelowMouse(t);break;case Hs.AREA:this.resizeDrawTextArea(t)}}pointerup(t){if(this.state===Hs.AREA)this.stopDrawTextArea(t),this.createTextArea(t),this.state=Hs.EDIT,this.startEdit(t.editor)}keydown(t){var e;this.state==Hs.EDIT&&(this.texteditor.keydown(t),null===(e=t.editor.model)||void 0===e||e.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]}))}clipboard(t,e){var i;this.state==Hs.EDIT&&(this.texteditor.clipboard(t,e),null===(i=t.model)||void 0===i||i.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]}))}setCursor(t,e){if(this.currentCursor!==t)switch(this.currentCursor=t,e.style.cursor="",t){case Bs.NONE:e.style.cursor="default";break;case Bs.EDIT:e.style.cursor=`url(${bs.cursorPath}text-edit.svg) 9 12, move`;break;case Bs.AREA:e.style.cursor=`url(${bs.cursorPath}text-area.svg) 9 12, move`;break;case Bs.SHAPE:e.style.cursor=`url(${bs.cursorPath}text-shape.svg) 9 12, move`;break;case Bs.PATH:e.style.cursor=`url(${bs.cursorPath}text-path.svg) 9 12, move`}}setCursorBasedOnFigureBelowMouse(t){let e=t.editor.selectedLayer.findFigureAt(t);void 0===e?this.setCursor(Bs.AREA,t.editor.svgView):e instanceof Se?this.setCursor(Bs.EDIT,t.editor.svgView):this.setCursor(Bs.SHAPE,t.editor.svgView)}startEdit(t){this.stopEdit(t),this.texteditor=new Ws(t,this.figure)}stopEdit(t){var e;void 0!==this.texteditor&&(this.texteditor.stop(),this.texteditor=void 0,null===(e=t.model)||void 0===e||e.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[this.figure.id]}))}startDrawTextArea(t){this.mouseDownAt=t,this.defs=document.createElementNS("http://www.w3.org/2000/svg","defs"),this.defs.innerHTML='<pattern id="textToolPattern"\n                x="0" y="0" width="100" height="4"\n                patternUnits="userSpaceOnUse"\n                patternTransform="rotate(45)">\n               <line x1="0" y1="0" x2="100" y2="0" style="stroke: rgb(79,128,255)" />\n            </pattern>',t.editor.svgView.appendChild(this.defs),this.svgRect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this.svgRect.setAttributeNS("","stroke","rgb(79,128,255)"),this.svgRect.setAttributeNS("","fill","url(#textToolPattern)"),t.editor.decorationOverlay.appendChild(this.svgRect)}resizeDrawTextArea(t){let e=this.mouseDownAt.x,i=this.mouseDownAt.y,s=t.x,o=t.y;s<e&&([e,s]=[s,e]),o<i&&([i,o]=[o,i]),this.svgRect.setAttributeNS("","x",`${Math.round(e)+.5}`),this.svgRect.setAttributeNS("","y",`${Math.round(i)+.5}`),this.svgRect.setAttributeNS("","width",`${Math.round(s-e)}`),this.svgRect.setAttributeNS("","height",`${Math.round(o-i)}`)}stopDrawTextArea(t){t.editor.decorationOverlay.removeChild(this.svgRect),t.editor.svgView.removeChild(this.defs)}createTextArea(t){let e=this.mouseDownAt.x,i=this.mouseDownAt.y,s=t.x,o=t.y;s<e&&([e,s]=[s,e]),o<i&&([i,o]=[o,i]);let r=new jt(e,i,s-e,o-i);this.figure=new Se(r),t.editor.addFigure(this.figure),bs.selection.set(this.figure),this.updateDecorationOfSelection(t.editor)}}class js extends cs{constructor(t,e){super(t),this.boardmodel=e}layerById(t){for(let e of this.boardmodel.layers)if(e.id===t)return e;throw Error("BoardListener_impl.layerById(): unknown layer id "+t)}add(t,e){return i(this,void 0,void 0,(function*(){this.layerById(t).data.push(e),this.boardmodel.modified.trigger({operation:Ds.ADD_FIGURES,figures:[e.id]})}))}transform(t,e,s,o){return i(this,void 0,void 0,(function*(){let i=this.layerById(t),o=new Set;for(let t of e)o.add(t);for(let t in i.data){let e=i.data[t];if(o.has(e.id)&&!e.transform(s))throw Error("BoardListener_impl.transform(): inserting a Transform() figure is not implemented... and should also be deprecated.")}this.boardmodel.modified.trigger({operation:Ds.TRANSFORM_FIGURES,figures:e,matrix:s})}))}}class Ys{constructor(){this.idCounter=-1,this.modified=new He,this.layers=[]}add(t,e){let i=this.layerById(t);0===e.id&&(-1===this.idCounter&&this.initializeIdCounter(),e.id=++this.idCounter),i.data.push(e),this.modified.trigger({operation:Ds.ADD_FIGURES,figures:[e.id]})}delete(t,e){const i=this.figureIdsAsSet(e),s=this.layerById(t);this.removeFromLayer(s,i),this.modified.trigger({operation:Ds.DELETE_FIGURES,figures:e})}setStrokeAndFill(t,e,i,s){this.forAllFigures(t,e,(t=>{t instanceof qt&&(t.stroke=i,t.fill=s)})),this.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:e})}forAllFigures(t,e,i){let s=this.figureIdsAsSet(e),o=this.layerById(t);for(let t in o.data){let e=o.data[t];s.has(e.id)&&i(e)}}transform(t,e,i){let s=this.figureIdsAsSet(e),o=this.layerById(t);for(let t in o.data){let e=o.data[t];s.has(e.id)&&(void 0===e.matrix&&e.transform(i)?this.modified.trigger({operation:Ds.UPDATE_FIGURES,figures:[e.id]}):(void 0===e.matrix&&(e.matrix=new Rt),e.matrix.prepend(i),this.modified.trigger({operation:Ds.TRANSFORM_FIGURES,matrix:i,figures:[e.id]})))}}bringToFront(t,e){const i=this.figureIdsAsSet(e),s=this.layerById(t),o=this.removeFromLayer(s,i);o.figures.reverse(),s.data.push(...o.figures),this.modified.trigger({operation:Ds.BRING_FIGURES_TO_FRONT,figures:e})}bringToBack(t,e){const i=this.figureIdsAsSet(e),s=this.layerById(t),o=this.removeFromLayer(s,i);o.figures.reverse(),s.data.splice(0,0,...o.figures),this.modified.trigger({operation:Ds.BRING_FIGURES_TO_BACK,figures:e})}bringForward(t,e){const i=this.figureIdsAsSet(e),s=this.layerById(t),o=this.removeFromLayer(s,i);o.figures.reverse(),o.index.reverse();for(let t=0;t<e.length;++t)s.data.splice(o.index[t]+1,0,o.figures[t]);this.modified.trigger({operation:Ds.BRING_FIGURES_FORWARD,figures:e})}bringBackward(t,e){const i=this.figureIdsAsSet(e),s=this.layerById(t),o=this.removeFromLayer(s,i);o.figures.reverse(),o.index.reverse();for(let t=0;t<e.length;++t){let e=o.index[t]-1;e<0&&(e=0),s.data.splice(e,0,o.figures[t])}this.modified.trigger({operation:Ds.BRING_FIGURES_BACKWARD,figures:e})}initializeIdCounter(){for(let t of this.layers)for(let e of t.data)this.initializeIdCounterHelper(e);++this.idCounter}initializeIdCounterHelper(t){if(this.idCounter=Math.max(this.idCounter,t.id),t instanceof Te)for(let e of t.childFigures)this.initializeIdCounterHelper(e)}layerById(t){for(let e of this.layers)if(e.id===t)return e;throw Error("LocalLayerModel.layerById(): unknown layer id "+t)}removeFromLayer(t,e){const i={figures:[],index:[]};for(let s=t.data.length-1;s>=0;--s)e.has(t.data[s].id)&&(i.figures.push(t.data[s]),i.index.push(s),t.data.splice(s,1));if(i.figures.length!==e.size)throw Error("Unknown figure Ids");return i}figureIdsAsSet(t){let e=new Set;for(let i of t)e.add(i);return e}}let qs=document.createElement("style");qs.textContent="\nsvg {\n    top: 0;\n    botton: 0;\n    left: 0;\n    right: 0;\n    background: none;\n}\n";class Ks extends Ge{constructor(){super(),this.data=[[0,0,0,""],[128,128,128,""],[191,191,191,""],[255,255,255,""],[128,0,0,""],[255,0,0,""],[255,128,0,""],[255,205,148,""],[255,255,0,""],[0,255,0,""],[0,128,0,""],[0,128,128,""],[0,255,255,""],[0,128,255,""],[0,0,255,""],[0,0,128,""],[128,0,128,""],[128,0,255,""],[128,128,255,""],[255,0,255,""],[255,0,128,""],[255,128,255,""],[255,255,128,""],[128,128,0,""],[128,255,0,""],[128,255,128,""],[0,255,128,""],[128,255,255,""]]}}class Xs extends di{constructor(t){super();let e=(null==t?void 0:t.model)?t.model:new Ks;this.action=null==t?void 0:t.action;let i=document.createElementNS("http://www.w3.org/2000/svg","svg"),s=0,o=0;for(let t of e.data){let e=document.createElementNS("http://www.w3.org/2000/svg","rect");for(let i of[["x",String(1+10*s)],["y",String(1+10*o)],["width","9"],["height","9"],["stroke","none"],["fill","rgb("+t[0]+","+t[1]+","+t[2]+")"]])e.setAttributeNS("",i[0],i[1]);i.appendChild(e),++s,s>=4&&(s=0,++o)}i.onmousedown=t=>{if(void 0===this.action)return;let s=i.getBoundingClientRect(),o=new Tt({x:t.x-s.left,y:t.y-s.top}),r=0,n=0;for(let t of e.data){if(new jt({origin:{x:1+10*r,y:1+10*n},size:{width:9,height:9}}).contains(o)){this.action.trigger("rgb("+t[0]+","+t[1]+","+t[2]+")");break}++r,r>=4&&(r=0,++n)}},this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(document.importNode(qs,!0)),this.shadowRoot.appendChild(i)}}function Js(t){return i(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{const s=window.indexedDB.deleteDatabase(t);s.onsuccess=t=>e(t),s.onerror=t=>i(t)}))}))}Xs.define("toad-colorswatch",Xs);class Zs extends ti{constructor(t,e,i){super();const s=new Ue(t),o=document.createElement("a");o.type="text/plain",o.style.display="hidden",this.open(Me(De,{children:[Le("h1",{children:"Export"}),Le("p",{children:Le(yi,{model:s})}),Me("p",{children:[Le(ui,Object.assign({action:this.close},{children:"Cancel"})),Le(ui,Object.assign({action:()=>{o.download=s.value,o.href=URL.createObjectURL(new Blob([i.serialize(e)])),o.dispatchEvent(new MouseEvent("click")),this.close()}},{children:"Export"}))]}),o]}))}}class Qs extends ti{constructor(t,e){super();let s=!1;const o=document.createElement("input");o.type="file",o.style.display="none",o.addEventListener("change",(()=>i(this,void 0,void 0,(function*(){var i;if(s=!0,1===(null===(i=o.files)||void 0===i?void 0:i.length)){const i=o.files[0],s=yield i.arrayBuffer(),r=e.deserialize(s),n=t.layers[0];t.delete(n.id,n.data.map((t=>t.id))),n.data=r.data,t.modified.trigger(void 0),this.close()}}))),!1),window.addEventListener("focus",(t=>{setTimeout((()=>{!s&&this.shadow&&this.close()}),300)}),{once:!0}),this.open(Me(De,{children:[Le("h1",{children:"Import"}),Me("p",{children:[Le(ui,Object.assign({action:this.close},{children:"Cancel"})),Le(ui,Object.assign({action:()=>{o.dispatchEvent(new MouseEvent("click"))}},{children:"Import"}))]}),o]})),o.dispatchEvent(new MouseEvent("click"))}}var to;!function(t){function e(t){let e=document.querySelector('template[id="'+t+'"]');if(!e)throw new Error("failed to find template '"+t+"'");let i=e.content;return document.importNode(i,!0)}t.erase=function(t){for(;t.firstChild;)t.removeChild(t.firstChild)},t.add=function(t,e){t.appendChild(e)},t.instantiateTemplate=function(t){return e(t)},t.tmpl=e}(to||(to={}));class eo extends us{constructor(t,e){super(t),void 0!==e?(this.server=e,e.setClient(this),this.initializeSession()):this.offline()}initializeSession(){let t="";if(document.cookie){let e=document.cookie.split(";");for(let i=0;i<e.length;++i){let s=e[i].trim();if(0==s.indexOf("session=")){t=s.substring(8,s.length);break}}}this.server.initializeWebSession(t)}logonScreen(t,e,s,o){return i(this,void 0,void 0,(function*(){console.log("Client_impl.logonScreen()");let i=new Qe("logonScreen"),r=i.text("logon",""),n=i.text("password",""),l=i.boolean("remember",s);i.html("disclaimer",e),i.number("lifetime",t,{}),i.text("message",o);let a=i.action("logon",(()=>{i.clear(),this.server.logon(r.value,n.value,l.value)})),h=function(){a.enabled=0!=r.value.trim().length&&0!=n.value.trim().length};h(),r.modified.add(h),n.modified.add(h),to.erase(document.body),to.add(document.body,i.root)}))}homeScreen(t,e,s,o){return i(this,void 0,void 0,(function*(){console.log("homeScreen()"),this.createMenuActions(o,s),this.createAvatarModel(e);const i=yield this.createBoardModel(),r=this.getHomeScreen(i);0!==t.length&&(document.cookie=t),to.erase(document.body),r.appendTo(document.body)}))}getHomeScreen(t){return function(t,e,i,s,o){const r=si("setcolor",(t=>{i.set(t)}));return Me(De,{children:[Le("img",{src:"img/logo.svg",width:"44",height:"44",style:{position:"absolute",left:"2px",top:"2px"}}),Me("div",Object.assign({class:"toolbar"},{children:[Le(xi,{model:e,value:"arrange",img:"img/tool/select.svg",title:"Arrange (V)"}),Le(xi,{model:e,value:"edit",img:"img/tool/direct.svg",title:"Edit (A)"}),Le(xi,{model:e,value:"pen",img:"img/tool/pen.svg",title:"Technical Pen (P)"}),Le(xi,{model:e,value:"nib",img:"img/tool/nib.svg",title:"Nib Pen (N)"}),Le(xi,{model:e,value:"rectangle",img:"img/tool/rectangle.svg",title:"Rectangle (M)"}),Le(xi,{model:e,value:"circle",img:"img/tool/circle.svg",title:"Ellipse (L)"}),Le(xi,{model:e,value:"text",img:"img/tool/text.svg",title:"Type (T)"}),Le(xi,{model:e,value:"zoom",img:"img/tool/zoom.svg",title:"Zoom (Z)"}),Le(Os,{model:i}),Le(Xs,{model:s,action:r})]})),Le(Vs,{model:t,tool:e,strokeandfill:i,style:{position:"absolute",left:"49px",right:"0px",top:"49px",bottom:"24px"}}),Le("div",{id:"hint",style:{position:"absolute",left:"0",right:"0",height:"24px",bottom:"0"}}),Le("div",Object.assign({style:{position:"absolute",left:"48px",right:"0",top:"0"}},{children:Le(ki,{config:[{name:"file",label:"File",sub:[{name:"new",label:"New",sub:[{name:"board",label:"Board"},{name:"card",label:"Card"},{name:"document",label:"Document"}]},{name:"import",label:"Import"},{name:"export",label:"Export"},{name:"delete",label:"Delete"},{name:"permissions",label:"Permissions"}]},{name:"edit",label:"Edit",sub:[{name:"undo",label:"Undo",shortcut:"Ctrl+Z"},{name:"redo",label:"Redo",shortcut:"Ctrl+Y"},{name:"cut",label:"Cut",shortcut:"Ctrl+X"},{name:"copy",label:"Copy",shortcut:"Ctrl+C"},{name:"paste",label:"Paste",shortcut:"Ctrl+V"},{name:"delete",label:"Delete",shortcut:"Del"},{name:"deselect-all",label:"Deselect All",shortcut:"Ctrl+Shift+A"},{name:"select-all",label:"Select All",shortcut:"Ctrl+A"}]},{name:"object",label:"Object",sub:[{name:"transform",label:"Transform",sub:[{name:"again",label:"Transform Again",shortcut:"Ctrl+D"},{name:"move",label:"Move",shortcut:"Ctrl+Shift+M"},{name:"rotate",label:"Rotate"},{name:"mirror",label:"Mirror"},{name:"scale",label:"Scale"},{name:"shear",label:"Shear"}]},{name:"arrange",label:"Arrange",sub:[{name:"front",label:"Bring To Front",shortcut:"Ctrl+Shift+]"},{name:"back",label:"Bring To Back",shortcut:"Ctrl+Shift+["},{name:"forward",label:"Bring Forward",shortcut:"Ctrl+]"},{name:"backward",label:"Bring Backward",shortcut:"Ctrl+["}]},{name:"group",label:"Group"},{name:"ungroup",label:"Ungroup"}]},{name:"type",label:"Type",sub:[{name:"font",label:"Font",sub:[{name:"family",label:"Family"},{name:"bold",label:"Bold",shortcut:"Ctrl+B"},{name:"italics",label:"Italics",shortcut:"Ctrl+I"},{name:"underline",label:"Underline",shortcut:"Ctrl+U"},{name:"stroke",label:"Stroke"},{name:"bigger",label:"Bigger",shortcut:"Ctrl++"},{name:"smaller",label:"Smaller",shortcut:"Ctrl+-"}]},{name:"text",label:"Text",sub:[{name:"left",label:"Left"},{name:"center",label:"Center"},{name:"right",label:"Right"}]}]},{space:!0},{name:"help",label:"Help"},{name:"settings",label:"Settings"},{name:"account",label:"Account",model:o,sub:[{name:"preferences",label:"Preferences"},{name:"logout",label:"Logout"}]}]})}))]})}(t,this.createToolModel(),this.createStrokeAndFillModel(),new Ks,this.createAvatarModel("img/avatars/whale.svg"))}createBoardModel(){return i(this,void 0,void 0,(function*(){let t=yield this.server.getProject(1),e=yield t.getBoard(1),i=yield e.getModel();i.board=e;let s=new js(this.orb,i);return e.addListener(s),ii("board",i),i}))}offline(){return i(this,void 0,void 0,(function*(){let t=new Ys,e=new Oe;try{const s=yield function(t,e,s){return i(this,void 0,void 0,(function*(){return new Promise(((i,o)=>{const r=window.indexedDB.open(t,e);r.onupgradeneeded=t=>{s(t)},r.onsuccess=t=>i(t.target.result),r.onerror=t=>o(t.target.error)}))}))}("workflow2",1,(t=>{const e=t.target.result;t.oldVersion<1?(console.log("IndexedDB: update to version 1"),e.createObjectStore("document",{keyPath:"name"})):console.log("IndexedDB: no update required. on version 1")})),o=yield function(t,e,s){return i(this,void 0,void 0,(function*(){return new Promise(((i,o)=>{try{const r=t.transaction([e],"readonly").objectStore(e).get(s);r.onsuccess=t=>i(t.target.result),r.onerror=t=>o(t)}catch(t){i(void 0)}}))}))}(s,"document","Untitled.wf");if(void 0===o)console.log("CREATE INITIAL PAGE"),yield function(t,e,s){return i(this,void 0,void 0,(function*(){return new Promise(((i,o)=>{const r=t.transaction([e],"readwrite");r.oncomplete=t=>i(t),r.onerror=t=>o(t),r.objectStore(e).add(s)}))}))}(s,"document",{name:"Untitled.wf",content:new ArrayBuffer(0)});else if(console.log("FOUND PREVIOUS PAGE"),o.content.byteLength>0)try{const t=this.orb.deserialize(o.content);e.data=t.data}catch(t){console.log(`Failed to deserialize 'Untitled.wf': ${t}`)}t.modified.add((()=>{console.log("SAVE"),function(t,e,s){i(this,void 0,void 0,(function*(){return new Promise(((i,o)=>{const r=t.transaction([e],"readwrite");r.oncomplete=t=>i(t),r.onerror=t=>o(t),r.objectStore(e).put(s)}))}))}(s,"document",{name:"Untitled.wf",content:this.orb.serialize(e)})}))}catch(t){console.log(`Failed to access workflow's IndexedDB: ${t}`),console.log(t),console.log("Deleting IndexedDB"),yield Js("workflow"),yield Js("workflow2"),new Oe}t.layers.push(e),ii("board",t),si("file|export",(()=>{new Zs("Untitled.wf",e,this.orb)})),si("file|import",(()=>{new Qs(t,this.orb)})),si("file|delete",(()=>i(this,void 0,void 0,(function*(){let e=[];for(let i of t.layers[0].data)e.push(i.id);t.delete(t.layers[0].id,e),yield Js("workflow"),yield Js("workflow2")}))));const s=this.getHomeScreen(t);to.erase(document.body),s.appendTo(document.body)}))}createMenuActions(t,e){si("account|preferences",(()=>{let i={fullname:new Ue(t),email:new Ue(e)};new ds(i)})),si("account|logout",(()=>{}))}createStrokeAndFillModel(){const t=new Ns;return ii("strokeandfill",t),ii("board",t),si("setcolor",(e=>{t.set(e)})),t}createToolModel(){let t=new Is;return t.add("arrange",new As),t.add("edit",new xs),t.add("pen",new $s),t.add("rectangle",new Us(fe)),t.add("circle",new Us(pe)),t.add("text",new zs),t.stringValue="arrange",ii("tool",t),ii("board",t),t}createAvatarModel(t){let e=new We(`\n            <svg height="32" width="32">\n                <defs>\n                    <clipPath id="mask">\n                        <rect x="0" y="0" width="32" height="32" rx="4" ry="4" />\n                    </clipPath>\n                </defs>\n                <rect x="0" y="0" width="32" height="32" rx="4" ry="4" stroke="none" fill="#08f" />\n                <image clip-path="url(#mask)" xlink:href="${t}" x="2" y="2" width="28px" height="28px" />\n            </svg>`);return ii("avatar",e),e}}function io(t){t.registerStubClass(ct),t.registerStubClass(dt),t.registerStubClass(ht),t.registerStubClass(at)}function so(){tt.registerValueType("Point",Tt),tt.registerValueType("Size",_t),tt.registerValueType("Rectangle",jt),tt.registerValueType("Matrix",Rt),tt.registerValueType("Figure",Yt),tt.registerValueType("figure.AttributedFigure",qt),tt.registerValueType("figure.Shape",Kt),tt.registerValueType("figure.Rectangle",fe),tt.registerValueType("figure.Circle",pe),tt.registerValueType("figure.Text",Se),tt.registerValueType("figure.Path",Ne),tt.registerValueType("figure.Group",Te),tt.registerValueType("figure.Transform",_e),tt.registerValueType("Layer",Oe),tt.registerValueType("BoardModel",hs)}return t.initializeCORBAValueTypes=so,t.initializeORB=io,t.main=function(t){return i(this,void 0,void 0,(function*(){console.log("WORKFLOW: MAIN");const e=new tt;e.debug=1,e.addProtocol(new nt),io(e),so();try{const i=ct.narrow(yield e.stringToObject(`corbaname::${window.location.hostname}:8809#WorkflowServer`));e.onclose=()=>{document.body.innerHTML="lost connection to workflow server '"+t+"'. please reload."};const s=yield i.getServer();new eo(e,s)}catch(t){console.log("Failed to connect to WorkFlow server, falling back to serverless."),new eo(e)}}))},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
